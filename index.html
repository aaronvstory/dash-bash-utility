<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dash Bash Utility</title>

    <!-- Version 1.2.0 - Update this version with each release -->
    <meta name="app-version" content="1.5.0">

    <!-- Cache Control Headers -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <link rel="icon" type="image/svg+xml" href="favicon.svg?v=1.2.0">
    <link rel="alternate icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Ccircle cx='16' cy='16' r='15' fill='%231f2937'/%3E%3Ctext x='16' y='22' font-family='Arial, sans-serif' font-size='18' font-weight='bold' text-anchor='middle' fill='%23fbbf24'%3E$%3C/text%3E%3Crect x='6' y='8' width='6' height='2' fill='%2360a5fa' opacity='0.8'/%3E%3Crect x='20' y='8' width='6' height='2' fill='%2360a5fa' opacity='0.8'/%3E%3Crect x='6' y='22' width='6' height='2' fill='%23a78bfa' opacity='0.8'/%3E%3Crect x='20' y='22' width='6' height='2' fill='%23a78bfa' opacity='0.8'/%3E%3C/svg%3E" />
    <meta name="description" content="Target Calculator & Address Book Utility with Dashers Management">
    <meta name="theme-color" content="#111827">

    <!-- PWA Support -->
    <link rel="manifest" href="manifest.json?v=1.2.0">
    <link rel="apple-touch-icon" href="icon-192.png?v=1.2.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiRGFzaCBCYXNoIFV0aWxpdHkiLCJzaG9ydF9uYW1lIjoiRGFzaEJhc2giLCJzdGFydF91cmwiOiIvIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzExMTgyNyIsInRoZW1lX2NvbG9yIjoiIzExMTgyNyIsImljb25zIjpbeyJzcmMiOiJkYXRhOmltYWdlL3BuZztiYXNlNjQsaVZCT1J3MEtHZ29BQUFBTlNVaEVVZ0FBQUlBQUFBQ0FDQVlBQUFDUVhaUjBBQUFBQVhOU1IwSUFyczRjNlFBQUFFeFJRVmgxbGRTWHJUVEJBUEFBQUFBQkpSVTVFcmtKZ2dnPT0iLCJzaXplcyI6IjEyOHgxMjgiLCJ0eXBlIjoiaW1hZ2UvcG5nIn1dfQ==">

    <!-- React and Dependencies -->
    <!-- BUILD STAMP: injected at 2025-09-30T08:05Z for version 1.4.3 (badge wiring, flag badges + icon-btn) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- External Stylesheets (base + exported refined theme) -->
    <link rel="stylesheet" href="styles.css?v=1.4.3">
    <link rel="stylesheet" href="styles2.css?v=1.4.3" data-layer="refined-theme">

    <!-- Tailwind CSS (for backward compatibility during transition) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body class="theme-jp" data-style-version="1.4.3">
    <div id="root"></div>

    <!-- Service Worker Registration with Version Check -->
    <script>
    console.log('%cDash Bash Utility build 1.4.5 (deactivated section styling matched) loaded','background:#222;color:#f39ac5;padding:4px 8px;border-radius:4px');
    const APP_VERSION = '1.5.0'; // Update this with each release
        // Log active stylesheets for debugging theme cascade
        window.addEventListener('load', () => {
            const sheets = [...document.styleSheets].map(s => s.href && s.href.split('/').pop());
            console.log('[DashBash] Active stylesheets:', sheets.filter(Boolean));
            if (!sheets.some(name => name && name.startsWith('styles2.css'))) {
                console.warn('[DashBash] styles2.css not loaded through link tag; injecting dynamically.');
                const link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = `styles2.css?v=${APP_VERSION}&dyn=1`;
                document.head.appendChild(link);
            }
        });

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Register service worker with cache bust parameter
                navigator.serviceWorker.register(`service-worker.js?v=${APP_VERSION}`)
                    .then(registration => {
                        console.log('ServiceWorker registered for version', APP_VERSION);

                        // Check for updates every hour
                        setInterval(() => {
                            registration.update();
                        }, 3600000);

                        // Handle updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New version available
                                    console.log('New version available!');
                                    // Create update notification
                                    const updateBanner = document.createElement('div');
                                    updateBanner.innerHTML = `
                                        <div style="position: fixed; top: 10px; right: 10px; background: #059669; color: white; padding: 12px 20px; border-radius: 8px; z-index: 9999; box-shadow: 0 4px 6px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 10px;">
                                            <span>New version available!</span>
                                            <button onclick="window.location.reload(true)" style="background: white; color: #059669; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: bold;">
                                                Update Now
                                            </button>
                                        </div>
                                    `;
                                    document.body.appendChild(updateBanner);

                                    // Auto-hide after 30 seconds
                                    setTimeout(() => {
                                        if (updateBanner.parentNode) {
                                            updateBanner.remove();
                                        }
                                    }, 30000);
                                }
                            });
                        });

                        // Immediate update check
                        registration.update();
                    })
                    .catch(err => console.log('ServiceWorker registration failed:', err));
            });

            // Handle controller change (new service worker activated)
            let refreshing = false;
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (!refreshing) {
                    refreshing = true;
                    window.location.reload(true);
                }
            });
        }

        // Version check on visibility change
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && navigator.serviceWorker && navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({ type: 'VERSION_CHECK', version: APP_VERSION });
            }
        });
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Simple icon component wrapper for Lucide
        const Icon = ({ name, size = 20, className = '' }) => {
            const iconRef = useRef(null);

            useEffect(() => {
                if (iconRef.current && window.lucide) {
                    // Clear previous content
                    iconRef.current.innerHTML = '';
                    // Add the icon
                    const iconElement = document.createElement('i');
                    iconElement.setAttribute('data-lucide', name);
                    iconElement.className = className;
                    if (size) {
                        iconElement.setAttribute('width', size);
                        iconElement.setAttribute('height', size);
                    }
                    iconRef.current.appendChild(iconElement);
                    // Replace with actual SVG
                    window.lucide.createIcons();
                }
            }, [name, size, className]);

            return React.createElement('span', { ref: iconRef });
        };

        // Helper functions for commonly used icons
        const Trash2 = (props) => React.createElement(Icon, { ...props, name: 'trash-2' });
        const Plus = (props) => React.createElement(Icon, { ...props, name: 'plus' });
        const Copy = (props) => React.createElement(Icon, { ...props, name: 'copy' });
        const ChevronDown = (props) => React.createElement(Icon, { ...props, name: 'chevron-down' });
        const ChevronUp = (props) => React.createElement(Icon, { ...props, name: 'chevron-up' });
        const ChevronsDown = (props) => React.createElement(Icon, { ...props, name: 'chevrons-down' });
        const ChevronsUp = (props) => React.createElement(Icon, { ...props, name: 'chevrons-up' });
        const Edit2 = (props) => React.createElement(Icon, { ...props, name: 'edit-2' });
        const Check = (props) => React.createElement(Icon, { ...props, name: 'check' });
        const Save = (props) => React.createElement(Icon, { ...props, name: 'save' });
        const X = (props) => React.createElement(Icon, { ...props, name: 'x' });
        const GripVertical = (props) => React.createElement(Icon, { ...props, name: 'grip-vertical' });
        const Clock = (props) => React.createElement(Icon, { ...props, name: 'clock' });
        const MapPin = (props) => React.createElement(Icon, { ...props, name: 'map-pin' });
        const Calculator = (props) => React.createElement(Icon, { ...props, name: 'calculator' });
        const MessageSquare = (props) => React.createElement(Icon, { ...props, name: 'message-square' });
        const Building2 = (props) => React.createElement(Icon, { ...props, name: 'building-2' });
        const Settings = (props) => React.createElement(Icon, { ...props, name: 'settings' });
        const Download = (props) => React.createElement(Icon, { ...props, name: 'download' });
        const Upload = (props) => React.createElement(Icon, { ...props, name: 'upload' });
        const RefreshCw = (props) => React.createElement(Icon, { ...props, name: 'refresh-cw' });
        const CheckSquare = (props) => React.createElement(Icon, { ...props, name: 'check-square' });
        const FolderOpen = (props) => React.createElement(Icon, { ...props, name: 'folder-open' });
        const FileText = (props) => React.createElement(Icon, { ...props, name: 'file-text' });
        const Timer = (props) => React.createElement(Icon, { ...props, name: 'timer' });
        const Users = (props) => React.createElement(Icon, { ...props, name: 'users' });
        const TimerOff = (props) => React.createElement(Icon, { ...props, name: 'timer-off' });
        const BarChart3 = (props) => React.createElement(Icon, { ...props, name: 'bar-chart-3' });
        const Archive = (props) => React.createElement(Icon, { ...props, name: 'archive' });
        const ArchiveRestore = (props) => React.createElement(Icon, { ...props, name: 'archive-restore' });
        const UserX = (props) => React.createElement(Icon, { ...props, name: 'user-x' });
        const UserCheck = (props) => React.createElement(Icon, { ...props, name: 'user-check' });
    const CircleCheck = (props) => React.createElement(Icon, { ...props, name: 'circle-check' });
    const Activity = (props) => React.createElement(Icon, { ...props, name: 'activity' });

        const EnhancedCalculator = () => {
            const [target, setTarget] = useState('99');
            const [targetPreset, setTargetPreset] = useState('99'); // '99', '120', or 'custom'
            const [isEditingTarget, setIsEditingTarget] = useState(false);
            const [customTarget, setCustomTarget] = useState('');
            const [prices, setPrices] = useState([]);
            const [currentPrice, setCurrentPrice] = useState('');
            const priceInputRef = useRef(null);

            // Collapsible sections state
            const [isCalculatorOpen, setIsCalculatorOpen] = useState(false); // Collapsed by default
            const [isMessagesOpen, setIsMessagesOpen] = useState(false);
            const [isAddressBookOpen, setIsAddressBookOpen] = useState(false);
            const [isNotesOpen, setIsNotesOpen] = useState(false);
            const [isStatisticsOpen, setIsStatisticsOpen] = useState(false);
            const [isStateManagementOpen, setIsStateManagementOpen] = useState(false);
            const [collapsedCategories, setCollapsedCategories] = useState({});
            const [collapsedStores, setCollapsedStores] = useState({});
            const [collapsedDashers, setCollapsedDashers] = useState({});
            const [collapsedArchivedDashers, setCollapsedArchivedDashers] = useState({});

            // Edit Mode and Selection state
            const [isEditMode, setIsEditMode] = useState(false);
            const [selectedItems, setSelectedItems] = useState({
                dashers: new Set(),        // dasher IDs
                dasherCategories: new Set(), // dasher category IDs
                notes: new Set(),          // note IDs (categoryId-noteIndex)
                noteCategories: new Set(), // note category IDs
                stores: new Set(),         // store IDs
                storeCategories: new Set(), // store category IDs (address book)
                messages: new Set(),       // message indices
                archivedDashers: new Set() // archived dasher IDs
            });

            // State management
            const [availableExports, setAvailableExports] = useState([]);
            const [importNotification, setImportNotification] = useState('');

            // Quick messages state
            const [editingIndex, setEditingIndex] = useState(-1);
            const [editText, setEditText] = useState('');
            const [draggedIndex, setDraggedIndex] = useState(-1);
            const [isAddingNew, setIsAddingNew] = useState(false);
            const [newMessageText, setNewMessageText] = useState('');
            const [copyNotification, setCopyNotification] = useState('');
            const [messages, setMessages] = useState([
                "hi can u pls see if u can help get a dasher assigned quicker!? I'm in a rush to get to work asap! Thank you",
                "Ok someone got it! darn it i just noticed i put the tip so high by accident :( can u help change the tip to $0 pls?",
                "Thanks, have a great day! <3",
                "Yes",
                "unassign this driver, we have had issues in the past, restraining order, stole my order last time, ASAP PLEASE, Thank you!",
                "Adjust dasher tip to $0 for the current order",
                "customer asked for refund if out of stock",
                "Got 1⚡",
                "canceled ❌❌❌",
                "looking for offer 👀",
                "Got 2nd⚡⚡",
                "Got 2nd⚡⚡  Arrived, pls lmk when removed. 🦆🦆🦆",
                "AGENT",
                "It applies to the other order as well! Cancel the other order I am on as well, please.  🤗",
                "Got 1, waiting on 2nd 🤗🤗🤗",
                "Yes I see the 3 dots but when i click it it says as everything is unavailable I need to contact support for it to be cancelled",
                "Hello 👋 the stores oven is broken"
            ]);

            // Address Book state
            const [categories, setCategories] = useState([
                {
                    id: 1,
                    name: "Dollar General",
                    stores: [
                        {
                            id: 1,
                            address: "840 North Main St., Beaver, UT 84713",
                            openTime: "",
                            closeTime: "",
                            notes: ""
                        }
                    ]
                },
                {
                    id: 2,
                    name: "Tractor Supply Co.",
                    stores: [
                        {
                            id: 201,
                            address: "456 Farm Road, Rural Town, TX 75001",
                            openTime: "07:00",
                            closeTime: "21:00",
                            notes: "Farm supplies and equipment"
                        }
                    ]
                }
            ]);
            const [editingCategory, setEditingCategory] = useState(-1);
            const [editingDasherCategory, setEditingDasherCategory] = useState(-1);
            const [editingNoteCategory, setEditingNoteCategory] = useState(-1);
            const [editingStore, setEditingStore] = useState({ categoryId: -1, storeId: -1 });
            const [newCategoryName, setNewCategoryName] = useState('');
            const [isAddingCategory, setIsAddingCategory] = useState(false);
            const [draggedCategory, setDraggedCategory] = useState(-1);
            const [draggedStore, setDraggedStore] = useState({ categoryId: -1, storeId: -1 });
            const [currentTime, setCurrentTime] = useState(new Date());
            const [saveNotification, setSaveNotification] = useState('');

            // Notes state
            const [noteCategories, setNoteCategories] = useState(() => {
                // Try to load from localStorage first
                const savedState = localStorage.getItem('dashBashState');
                if (savedState) {
                    try {
                        const state = JSON.parse(savedState);
                        if (state.noteCategories) {
                            return state.noteCategories;
                        }
                    } catch (e) {
                        console.error('Error loading noteCategories from localStorage:', e);
                    }
                }

                // Only use defaults if no saved state exists
                return [
                    {
                        id: Date.now().toString(),
                        name: 'General',
                        notes: ['Welcome to Dash Bash! This is a sample note. You can edit, copy, or delete it. Try adding your own notes!']
                    }
                ];
            });
            const [editingNote, setEditingNote] = useState({ categoryId: '', noteIndex: -1 });
            const [draggedNote, setDraggedNote] = useState({ categoryId: '', noteIndex: -1 });
            const [collapsedNoteCategories, setCollapsedNoteCategories] = useState({});

            // Dashers state
            const [isDashersOpen, setIsDashersOpen] = useState(false);
            const [isDeactivatedDashersOpen, setIsDeactivatedDashersOpen] = useState(false);
            const [isReadyDashersOpen, setIsReadyDashersOpen] = useState(false);
            const [isCurrentlyUsingDashersOpen, setIsCurrentlyUsingDashersOpen] = useState(false);
            const [isAppealedDashersOpen, setIsAppealedDashersOpen] = useState(false);
            const [isArchivedDashersOpen, setIsArchivedDashersOpen] = useState(false);
            const [archivedDashers, setArchivedDashers] = useState(() => {
                // Try to load from localStorage first
                const savedState = localStorage.getItem('dashBashState');
                if (savedState) {
                    try {
                        const state = JSON.parse(savedState);
                        if (state.archivedDashers) {
                            return state.archivedDashers;
                        }
                    } catch (e) {
                        console.error('Error loading archivedDashers from localStorage:', e);
                    }
                }
                return [];
            });
            const [deactivatedDashers, setDeactivatedDashers] = useState(() => {
                const savedState = localStorage.getItem('dashBashState');
                if (savedState) {
                    try {
                        const state = JSON.parse(savedState);
                        if (state.deactivatedDashers) {
                            return state.deactivatedDashers;
                        }
                    } catch (e) {
                        console.error('Error loading deactivatedDashers from localStorage:', e);
                    }
                }
                return [];
            });
            const [readyDashers, setReadyDashers] = useState(() => {
                const savedState = localStorage.getItem('dashBashState');
                if (savedState) {
                    try {
                        const state = JSON.parse(savedState);
                        if (state.readyDashers) {
                            return state.readyDashers;
                        }
                    } catch (e) {
                        console.error('Error loading readyDashers from localStorage:', e);
                    }
                }
                return [];
            });
            const [currentlyUsingDashers, setCurrentlyUsingDashers] = useState(() => {
                const savedState = localStorage.getItem('dashBashState');
                if (savedState) {
                    try {
                        const state = JSON.parse(savedState);
                        if (state.currentlyUsingDashers) {
                            return state.currentlyUsingDashers;
                        }
                    } catch (e) {
                        console.error('Error loading currentlyUsingDashers from localStorage:', e);
                    }
                }
                return [];
            });
            const [appealedDashers, setAppealedDashers] = useState(() => {
                const savedState = localStorage.getItem('dashBashState');
                if (savedState) {
                    try {
                        const state = JSON.parse(savedState);
                        if (state.appealedDashers) {
                            return state.appealedDashers;
                        }
                    } catch (e) {
                        console.error('Error loading appealedDashers from localStorage:', e);
                    }
                }
                return [];
            });
            const [collapsedDeactivatedDashers, setCollapsedDeactivatedDashers] = useState({});
            const [dasherCategories, setDasherCategories] = useState(() => {
                // Try to load from localStorage first
                const savedState = localStorage.getItem('dashBashState');
                if (savedState) {
                    try {
                        const state = JSON.parse(savedState);
                        if (state.dasherCategories) {
                            return state.dasherCategories;
                        }
                    } catch (e) {
                        console.error('Error loading dasherCategories from localStorage:', e);
                    }
                }

                // Only use defaults if no saved state exists
                return [
                    {
                        id: 'main',
                        name: 'Main',
                        dashers: [{
                            id: 'test-dasher-' + Date.now(),
                            name: 'Test Dasher',
                            email: 'test@example.com',
                            emailPw: 'password123',
                            dasherPw: 'dasher456',
                            phone: '555-0123',
                            balance: '$50.00',
                            crimson: false,
                            redCard: false,
                            appealed: false,
                            appealedAt: null,
                            deactivated: false,
                            lastUsed: null,
                            notes: 'This is a sample dasher for testing. Feel free to edit or delete!'
                        }]
                    },
                    { id: 'currently-using', name: 'Currently using', dashers: [] },
                    // Removed inline 'deactivated' category; handled as separate top-level list now
                    { id: 'locked', name: 'Locked', dashers: [] },
                    { id: 'reverif', name: 'Reverif', dashers: [] },
                    { id: 'ready', name: 'Ready', dashers: [{
                        id: 'version-test-dasher',
                        name: 'Version Test Dasher',
                        email: 'test@version.check',
                        crimson: false,
                        redCard: false,
                        lastUsed: null,
                        notes: 'TEST DASHER - Added to verify GitHub Pages deployment'
                    }] }
                ];
            });
            const [editingDasher, setEditingDasher] = useState({ categoryId: null, dasherId: null, name: '', email: '', balance: 0, notes: '' });
            const [draggedDasher, setDraggedDasher] = useState({ categoryId: '', dasherIndex: -1 });
            const [draggedDasherCategory, setDraggedDasherCategory] = useState(null);
            const [collapsedDasherCategories, setCollapsedDasherCategories] = useState({});
            const [timerTick, setTimerTick] = useState(0);

            // Load from localStorage on component mount
            useEffect(() => {
                // Try to load the new unified state first
                const savedState = localStorage.getItem('dashBashState');
                if (savedState) {
                    try {
                        const state = JSON.parse(savedState);

                        // Load target configuration
                        const savedTarget = state.target || '99';
                        const savedPreset = state.targetPreset || (savedTarget === '99' || savedTarget === '120' ? savedTarget : 'custom');

                        setTarget(savedTarget);
                        setTargetPreset(savedPreset);
                        if (savedPreset === 'custom') {
                            setCustomTarget(savedTarget);
                        }

                        // Load other state
                        setPrices(state.prices || []);
                        setMessages(state.messages || messages);
                        setCategories(state.categories || []);
                        // Load archived dashers
                        if (state.archivedDashers) {
                            setArchivedDashers(state.archivedDashers);
                        }
                        if (state.collapsedArchivedDashers) {
                            setCollapsedArchivedDashers(state.collapsedArchivedDashers);
                        }
                        // Note: noteCategories and dasherCategories are now loaded via lazy initialization
                    } catch (e) {
                        console.error('Error loading saved state:', e);
                    }
                } else {
                    // Fallback to old addressBookCategories for backward compatibility
                    const savedCategories = localStorage.getItem('addressBookCategories');
                    if (savedCategories) {
                        try {
                            setCategories(JSON.parse(savedCategories));
                        } catch (e) {
                            console.error('Error loading saved categories:', e);
                        }
                    }
                }
            }, []);

            // Update current time every minute
            useEffect(() => {
                const interval = setInterval(() => {
                    setCurrentTime(new Date());
                }, 60000);
                return () => clearInterval(interval);
            }, []);

            // Update timer tick every second for dashers
            useEffect(() => {
                const interval = setInterval(() => {
                    setTimerTick(prev => prev + 1);
                }, 1000);
                return () => clearInterval(interval);
            }, []);

            // Calculator functions
            const addPrice = () => {
                if (currentPrice && !isNaN(parseFloat(currentPrice))) {
                    setPrices([...prices, parseFloat(currentPrice)]);
                    setCurrentPrice('');
                    setTimeout(() => priceInputRef.current && priceInputRef.current.focus(), 0);
                }
            };

            const removePrice = (index) => {
                setPrices(prices.filter((_, i) => i !== index));
                setTimeout(() => priceInputRef.current && priceInputRef.current.focus(), 0);
            };

            const clearAll = () => {
                setPrices([]);
                setTimeout(() => priceInputRef.current && priceInputRef.current.focus(), 0);
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter') {
                    addPrice();
                }
            };

            const handleTargetKeyPress = (e) => {
                if (e.key === 'Enter') {
                    if (isEditingTarget) {
                        handleCustomTargetSave();
                    } else {
                        priceInputRef.current && priceInputRef.current.focus();
                    }
                }
            };

            const handleTargetPresetChange = (preset) => {
                setTargetPreset(preset);
                setIsEditingTarget(false);

                if (preset === '99' || preset === '120') {
                    setTarget(preset);
                    setCustomTarget('');
                } else if (preset === 'custom') {
                    setIsEditingTarget(true);
                    setCustomTarget(target !== '99' && target !== '120' ? target : '');
                }

                // Auto-save the change
                setTimeout(() => {
                    saveAllToLocalStorage();
                }, 100);
            };

            const handleCustomTargetSave = () => {
                if (customTarget && !isNaN(parseFloat(customTarget))) {
                    setTarget(customTarget);
                    setIsEditingTarget(false);

                    // Auto-save the change
                    setTimeout(() => {
                        saveAllToLocalStorage();
                    }, 100);
                }
            };

            useEffect(() => {
                priceInputRef.current && priceInputRef.current.focus();
            }, []);

            // Message management functions
            const copyToClipboard = async (text) => {
                try {
                    await navigator.clipboard.writeText(text);
                    const preview = text.length > 40 ? text.substring(0, 40) + '...' : text;
                    setCopyNotification(`✅ Copied: "${preview}"`);
                    setTimeout(() => setCopyNotification(''), 3000);
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                    setCopyNotification('❌ Failed to copy');
                    setTimeout(() => setCopyNotification(''), 3000);
                }
            };

            const startEdit = (index) => {
                setEditingIndex(index);
                setEditText(messages[index]);
            };

            const saveEdit = () => {
                if (editText.trim()) {
                    const newMessages = [...messages];
                    newMessages[editingIndex] = editText.trim();
                    setMessages(newMessages);

                    // Auto-save messages
                    setTimeout(() => {
                        saveAllToLocalStorage();
                    }, 100);
                }
                setEditingIndex(-1);
                setEditText('');
            };

            const cancelEdit = () => {
                setEditingIndex(-1);
                setEditText('');
            };

            const deleteMessage = (index) => {
                const newMessages = messages.filter((_, i) => i !== index);
                setMessages(newMessages);
                if (editingIndex === index) {
                    setEditingIndex(-1);
                    setEditText('');
                }

                // Auto-save after deletion
                setTimeout(() => {
                    saveAllToLocalStorage();
                }, 100);
            };

            const handleDragStart = (e, index) => {
                setDraggedIndex(index);
                e.dataTransfer.effectAllowed = 'move';
            };

            const handleDragOver = (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            };

            const handleDrop = (e, dropIndex) => {
                e.preventDefault();
                if (draggedIndex === -1 || draggedIndex === dropIndex) return;

                const newMessages = [...messages];
                const draggedMessage = newMessages[draggedIndex];
                newMessages.splice(draggedIndex, 1);
                newMessages.splice(dropIndex, 0, draggedMessage);
                setMessages(newMessages);
                setDraggedIndex(-1);

                // Auto-save after reordering
                setTimeout(() => {
                    saveAllToLocalStorage();
                }, 100);
            };

            const addNewMessage = () => {
                if (newMessageText.trim()) {
                    const newMessages = [...messages, newMessageText.trim()];
                    setMessages(newMessages);
                    setNewMessageText('');
                    setIsAddingNew(false);

                    // Auto-save after adding
                    setTimeout(() => {
                        saveAllToLocalStorage();
                    }, 100);
                }
            };

            const cancelAddNew = () => {
                setNewMessageText('');
                setIsAddingNew(false);
            };

            // Address Book functions
            const extractCityState = (address) => {
                if (!address) return '';

                // Split by comma and trim spaces
                const parts = address.split(',').map(part => part.trim());

                if (parts.length >= 3) {
                    // Format: "Street, City, State ZIP"
                    const city = parts[1];
                    const stateZip = parts[2];
                    // Extract state (first word before ZIP)
                    const state = stateZip.split(' ')[0];
                    return `${city}, ${state}`;
                } else if (parts.length === 2) {
                    // Format: "Street, City State"
                    const cityState = parts[1];
                    return cityState;
                }

                return '';
            };

            // State Management Functions
            const saveAllToLocalStorage = () => {
                try {
                    const state = {
                        target,
                        targetPreset,
                        prices,
                        messages,
                        categories,
                        noteCategories,
                        dasherCategories,
                        archivedDashers,
                        deactivatedDashers,
                        readyDashers,
                        currentlyUsingDashers,
                        appealedDashers,
                        collapsedCategories,
                        collapsedStores,
                        collapsedDashers,
                        collapsedArchivedDashers,
                        collapsedDeactivatedDashers,
                        collapsedDasherCategories,
                        collapsedNoteCategories,
                        isArchivedDashersOpen,
                        isDeactivatedDashersOpen,
                        isReadyDashersOpen,
                        isCurrentlyUsingDashersOpen,
                        isAppealedDashersOpen,
                        timestamp: new Date().toISOString()
                    };
                    localStorage.setItem('dashBashState', JSON.stringify(state));
                    setSaveNotification('✅ Saved automatically');
                    setTimeout(() => setSaveNotification(''), 3000);
                } catch (e) {
                    setSaveNotification('❌ Failed to save data');
                    setTimeout(() => setSaveNotification(''), 3000);
                }
            };

            const loadFromLocalStorage = () => {
                try {
                    const savedState = localStorage.getItem('dashBashState');
                    if (savedState) {
                        const state = JSON.parse(savedState);

                        // Load target configuration
                        const savedTarget = state.target || '99';
                        const savedPreset = state.targetPreset || (savedTarget === '99' || savedTarget === '120' ? savedTarget : 'custom');

                        setTarget(savedTarget);
                        setTargetPreset(savedPreset);
                        if (savedPreset === 'custom') {
                            setCustomTarget(savedTarget);
                        }

                        setPrices(state.prices || []);
                        setMessages(state.messages || []);
                        setCategories(state.categories || []);
                        // Don't use defaults if we have saved state
                        if (state.noteCategories) setNoteCategories(state.noteCategories);
                        if (state.dasherCategories) setDasherCategories(state.dasherCategories);
                        if (state.archivedDashers) setArchivedDashers(state.archivedDashers);
                        if (state.deactivatedDashers) setDeactivatedDashers(state.deactivatedDashers);

                        // Load collapsed states if they exist
                        if (state.collapsedCategories) setCollapsedCategories(state.collapsedCategories);
                        if (state.collapsedStores) setCollapsedStores(state.collapsedStores);
                        if (state.collapsedDashers) setCollapsedDashers(state.collapsedDashers);
                        if (state.collapsedArchivedDashers) setCollapsedArchivedDashers(state.collapsedArchivedDashers);
                        if (state.collapsedDeactivatedDashers) setCollapsedDeactivatedDashers(state.collapsedDeactivatedDashers);
                        if (state.collapsedDasherCategories) setCollapsedDasherCategories(state.collapsedDasherCategories);
                        if (state.collapsedNoteCategories) setCollapsedNoteCategories(state.collapsedNoteCategories);
                        if (state.isArchivedDashersOpen !== undefined) setIsArchivedDashersOpen(state.isArchivedDashersOpen);
                        if (state.isDeactivatedDashersOpen !== undefined) setIsDeactivatedDashersOpen(state.isDeactivatedDashersOpen);

                        setSaveNotification('✅ Data loaded successfully!');
                        setTimeout(() => setSaveNotification(''), 3000);
                    } else {
                        setSaveNotification('⚠️ No saved data found');
                        setTimeout(() => setSaveNotification(''), 3000);
                    }
                } catch (e) {
                    setSaveNotification('❌ Failed to load data');
                    setTimeout(() => setSaveNotification(''), 3000);
                }
            };

            const exportToJSON = () => {
                try {
                    const state = {
                        target,
                        targetPreset,
                        prices,
                        messages,
                        categories,
                        noteCategories,
                        dasherCategories,
                        archivedDashers,
                        collapsedCategories,
                        collapsedStores,
                        collapsedDashers,
                        collapsedArchivedDashers,
                        collapsedDasherCategories,
                        collapsedNoteCategories,
                        isArchivedDashersOpen,
                        exportDate: new Date().toISOString(),
                        version: '2.1'
                    };

                    const dataStr = JSON.stringify(state, null, 2);
                    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);

                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                    const fileName = `dashbash-export-${timestamp}.json`;

                    const linkElement = document.createElement('a');
                    linkElement.setAttribute('href', dataUri);
                    linkElement.setAttribute('download', fileName);
                    linkElement.click();

                    setSaveNotification(`✅ Exported to ${fileName}`);
                    setTimeout(() => setSaveNotification(''), 3000);
                } catch (e) {
                    setSaveNotification('❌ Failed to export data');
                    setTimeout(() => setSaveNotification(''), 3000);
                }
            };

            const exportSelected = () => {
                try {
                    const exportData = {
                        version: '3.0',
                        exportType: 'selective',
                        exportDate: new Date().toISOString(),

                        // Include metadata for import handling
                        metadata: {
                            sourceCategoryStructure: {
                                dasherCategories: dasherCategories.map(c => ({ id: c.id, name: c.name })),
                                noteCategories: noteCategories.map(c => ({ id: c.id, name: c.name })),
                                storeCategories: categories.map(c => ({ id: c.id, name: c.name }))
                            }
                        },

                        // Only include selected data
                        dashers: [],
                        archivedDashers: [],
                        deactivatedDashers: [],
                        readyDashers: [],
                        currentlyUsingDashers: [],
                        appealedDashers: [],
                        notes: [],
                        stores: [],
                        messages: [],

                        // Include full categories if all items selected
                        fullCategories: {
                            dasher: [],
                            note: [],
                            store: []
                        }
                    };

                    // Collect selected dashers
                    dasherCategories.forEach(cat => {
                        const categoryDashers = cat.dashers.filter(d => selectedItems.dashers.has(d.id));
                        if (categoryDashers.length > 0) {
                            if (categoryDashers.length === cat.dashers.length && selectedItems.dasherCategories.has(cat.id)) {
                                // Full category selected
                                exportData.fullCategories.dasher.push({
                                    ...cat,
                                    dashers: categoryDashers
                                });
                            } else {
                                // Individual dashers selected
                                exportData.dashers.push(...categoryDashers.map(d => ({
                                    ...d,
                                    sourceCategoryId: cat.id,
                                    sourceCategoryName: cat.name
                                })));
                            }
                        }
                    });

                    // Collect selected archived dashers
                    const selectedArchived = archivedDashers.filter(d => selectedItems.archivedDashers.has(d.id));
                    exportData.archivedDashers.push(...selectedArchived);

                    // Collect selected deactivated dashers
                    const selectedDeactivated = deactivatedDashers.filter(d => selectedItems.deactivatedDashers?.has(d.id));
                    exportData.deactivatedDashers.push(...selectedDeactivated);

                    // Collect selected ready dashers
                    const selectedReady = readyDashers.filter(d => selectedItems.readyDashers?.has(d.id));
                    exportData.readyDashers.push(...selectedReady);

                    // Collect selected currently using dashers
                    const selectedCurrentlyUsing = currentlyUsingDashers.filter(d => selectedItems.currentlyUsingDashers?.has(d.id));
                    exportData.currentlyUsingDashers.push(...selectedCurrentlyUsing);

                    // Collect selected appealed dashers
                    const selectedAppealed = appealedDashers.filter(d => selectedItems.appealedDashers?.has(d.id));
                    exportData.appealedDashers.push(...selectedAppealed);

                    // Collect selected notes
                    noteCategories.forEach(cat => {
                        const selectedNotes = [];
                        cat.notes.forEach((note, index) => {
                            const noteId = `${cat.id}-${index}`;
                            if (selectedItems.notes.has(noteId)) {
                                selectedNotes.push(note);
                            }
                        });

                        if (selectedNotes.length > 0) {
                            if (selectedNotes.length === cat.notes.length && selectedItems.noteCategories.has(cat.id)) {
                                // Full category selected
                                exportData.fullCategories.note.push({
                                    ...cat,
                                    notes: selectedNotes
                                });
                            } else {
                                // Individual notes selected
                                exportData.notes.push(...selectedNotes.map(n => ({
                                    text: n,
                                    sourceCategoryId: cat.id,
                                    sourceCategoryName: cat.name
                                })));
                            }
                        }
                    });

                    // Collect selected stores
                    categories.forEach(cat => {
                        const categoryStores = cat.stores.filter(s => selectedItems.stores.has(s.id));
                        if (categoryStores.length > 0) {
                            if (categoryStores.length === cat.stores.length && selectedItems.storeCategories.has(cat.id)) {
                                // Full category selected
                                exportData.fullCategories.store.push({
                                    ...cat,
                                    stores: categoryStores
                                });
                            } else {
                                // Individual stores selected
                                exportData.stores.push(...categoryStores.map(s => ({
                                    ...s,
                                    sourceCategoryId: cat.id,
                                    sourceCategoryName: cat.name
                                })));
                            }
                        }
                    });

                    // Collect selected messages
                    const selectedMessages = messages.filter((msg, index) => selectedItems.messages.has(index));
                    exportData.messages.push(...selectedMessages);

                    // Download the file
                    const dataStr = JSON.stringify(exportData, null, 2);
                    const dataBlob = new Blob([dataStr], {type: 'application/json'});
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(dataBlob);
                    link.download = `dashbash-selected-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    setSaveNotification('✓ Selected items exported successfully!');
                    setTimeout(() => setSaveNotification(''), 3000);

                    // Clear selections after export
                    clearAllSelections();
                    setIsEditMode(false);
                } catch (error) {
                    console.error('Export error:', error);
                    setSaveNotification('⚠️ Export failed!');
                    setTimeout(() => setSaveNotification(''), 3000);
                }
            };

            const importFromJSON = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const state = JSON.parse(e.target.result);

                        // Check if this is a selective export (v3.0+)
                        if (state.version === '3.0' && state.exportType === 'selective') {
                            // Handle selective import
                            const timestamp = new Date().toLocaleDateString();

                            // Create/update imported categories
                            let importedDasherCategory = null;
                            let importedNoteCategory = null;
                            let importedStoreCategory = null;

                            // Process individual dashers
                            if (state.dashers && state.dashers.length > 0) {
                                importedDasherCategory = {
                                    id: 'imported-' + Date.now(),
                                    name: 'Imported ' + timestamp,
                                    dashers: state.dashers.map(dasher => ({
                                        ...dasher,
                                        id: dasher.id + '-imp-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                                        imported: true,
                                        importDate: new Date().toISOString()
                                    }))
                                };
                            }

                            // Process full dasher categories
                            if (state.fullCategories && state.fullCategories.dasher && state.fullCategories.dasher.length > 0) {
                                const importedCategories = state.fullCategories.dasher.map(cat => ({
                                    ...cat,
                                    id: cat.id + '-imp-' + Date.now(),
                                    name: cat.name + ' (Imported)',
                                    dashers: cat.dashers.map(dasher => ({
                                        ...dasher,
                                        id: dasher.id + '-imp-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                                        imported: true,
                                        importDate: new Date().toISOString()
                                    }))
                                }));
                                setDasherCategories([...dasherCategories, ...importedCategories]);
                            } else if (importedDasherCategory) {
                                setDasherCategories([...dasherCategories, importedDasherCategory]);
                            }

                            // Process archived dashers
                            if (state.archivedDashers && state.archivedDashers.length > 0) {
                                const importedArchived = state.archivedDashers.map(dasher => ({
                                    ...dasher,
                                    id: dasher.id + '-imp-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                                    imported: true,
                                    importDate: new Date().toISOString()
                                }));
                                setArchivedDashers([...archivedDashers, ...importedArchived]);
                            }

                            // Process deactivated dashers
                            if (state.deactivatedDashers && state.deactivatedDashers.length > 0) {
                                const importedDeactivated = state.deactivatedDashers.map(dasher => ({
                                    ...dasher,
                                    id: dasher.id + '-imp-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                                    imported: true,
                                    importDate: new Date().toISOString()
                                }));
                                setDeactivatedDashers([...deactivatedDashers, ...importedDeactivated]);
                            }

                            // Process ready dashers
                            if (state.readyDashers && state.readyDashers.length > 0) {
                                const importedReady = state.readyDashers.map(dasher => ({
                                    ...dasher,
                                    id: dasher.id + '-imp-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                                    imported: true,
                                    importDate: new Date().toISOString()
                                }));
                                setReadyDashers([...readyDashers, ...importedReady]);
                            }

                            // Process currently using dashers
                            if (state.currentlyUsingDashers && state.currentlyUsingDashers.length > 0) {
                                const importedCurrentlyUsing = state.currentlyUsingDashers.map(dasher => ({
                                    ...dasher,
                                    id: dasher.id + '-imp-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                                    imported: true,
                                    importDate: new Date().toISOString()
                                }));
                                setCurrentlyUsingDashers([...currentlyUsingDashers, ...importedCurrentlyUsing]);
                            }

                            // Process appealed dashers
                            if (state.appealedDashers && state.appealedDashers.length > 0) {
                                const importedAppealed = state.appealedDashers.map(dasher => ({
                                    ...dasher,
                                    id: dasher.id + '-imp-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                                    imported: true,
                                    importDate: new Date().toISOString()
                                }));
                                setAppealedDashers([...appealedDashers, ...importedAppealed]);
                            }

                            // Process individual notes
                            if (state.notes && state.notes.length > 0) {
                                importedNoteCategory = {
                                    id: 'imported-notes-' + Date.now(),
                                    name: 'Imported Notes ' + timestamp,
                                    notes: state.notes.map(n => n.text || n)
                                };
                            }

                            // Process full note categories
                            if (state.fullCategories && state.fullCategories.note && state.fullCategories.note.length > 0) {
                                const importedCategories = state.fullCategories.note.map(cat => ({
                                    ...cat,
                                    id: cat.id + '-imp-' + Date.now(),
                                    name: cat.name + ' (Imported)'
                                }));
                                setNoteCategories([...noteCategories, ...importedCategories]);
                            } else if (importedNoteCategory) {
                                setNoteCategories([...noteCategories, importedNoteCategory]);
                            }

                            // Process individual stores
                            if (state.stores && state.stores.length > 0) {
                                importedStoreCategory = {
                                    id: 'imported-stores-' + Date.now(),
                                    name: 'Imported Stores ' + timestamp,
                                    stores: state.stores.map(store => ({
                                        ...store,
                                        id: store.id + '-imp-' + Date.now()
                                    }))
                                };
                            }

                            // Process full store categories
                            if (state.fullCategories && state.fullCategories.store && state.fullCategories.store.length > 0) {
                                const importedCategories = state.fullCategories.store.map(cat => ({
                                    ...cat,
                                    id: cat.id + '-imp-' + Date.now(),
                                    name: cat.name + ' (Imported)',
                                    stores: cat.stores.map(store => ({
                                        ...store,
                                        id: store.id + '-imp-' + Date.now()
                                    }))
                                }));
                                setCategories([...categories, ...importedCategories]);
                            } else if (importedStoreCategory) {
                                setCategories([...categories, importedStoreCategory]);
                            }

                            // Process messages (append to existing)
                            if (state.messages && state.messages.length > 0) {
                                setMessages([...messages, ...state.messages]);
                            }

                            setImportNotification(`✅ Imported selected items into new categories from ${file.name}`);
                            setTimeout(() => setImportNotification(''), 3000);

                        } else {
                            // Handle full import (backward compatibility for v2.1 and earlier)
                            // Load target configuration
                            const savedTarget = state.target || '99';
                            const savedPreset = state.targetPreset || (savedTarget === '99' || savedTarget === '120' ? savedTarget : 'custom');

                            setTarget(savedTarget);
                            setTargetPreset(savedPreset);
                            if (savedPreset === 'custom') {
                                setCustomTarget(savedTarget);
                            }

                            setPrices(state.prices || []);
                            setMessages(state.messages || []);
                            setCategories(state.categories || []);
                            // Don't use defaults if we have saved state
                            if (state.noteCategories) setNoteCategories(state.noteCategories);
                            if (state.dasherCategories) setDasherCategories(state.dasherCategories);
                            if (state.archivedDashers) setArchivedDashers(state.archivedDashers);

                            // Load collapsed states if they exist
                            if (state.collapsedCategories) setCollapsedCategories(state.collapsedCategories);
                            if (state.collapsedStores) setCollapsedStores(state.collapsedStores);
                            if (state.collapsedDashers) setCollapsedDashers(state.collapsedDashers);
                            if (state.collapsedArchivedDashers) setCollapsedArchivedDashers(state.collapsedArchivedDashers);
                            if (state.collapsedDasherCategories) setCollapsedDasherCategories(state.collapsedDasherCategories);
                            if (state.collapsedNoteCategories) setCollapsedNoteCategories(state.collapsedNoteCategories);
                            if (state.isArchivedDashersOpen !== undefined) setIsArchivedDashersOpen(state.isArchivedDashersOpen);

                            setImportNotification(`✅ Imported data from ${file.name}`);
                            setTimeout(() => setImportNotification(''), 3000);
                        }
                    } catch (err) {
                        console.error('Import error:', err);
                        setImportNotification('❌ Failed to import - invalid file format');
                        setTimeout(() => setImportNotification(''), 3000);
                    }
                };
                reader.readAsText(file);
                event.target.value = ''; // Reset input
            };

            const clearAllData = () => {
                if (confirm('Are you sure you want to clear all data? This cannot be undone.')) {
                    setTarget('99');
                    setTargetPreset('99');
                    setCustomTarget('');
                    setIsEditingTarget(false);
                    setPrices([]);
                    setMessages([
                        "Ok someone got it! darn it i just noticed i put the tip so high by accident :( can u help change the tip to $0 pls?",
                        "Thanks, have a great day! <3",
                        "Yes",
                        "AGENT",
                        "hi can u pls see if u can help get a dasher assigned quicker!? I'm in a rush to get to work asap! Thank you",
                        "unassign this driver, we have had issues in the past, restraining order, stole my order last time, ASAP PLEASE, Thank you!",
                        "Adjust dasher tip to $0 for the current order",
                        "customer asked for refund if out of stock"
                    ]);
                    setCategories([]);
                    setNoteCategories([
                        { id: Date.now().toString(), name: 'General', notes: [] }
                    ]);
                    setDasherCategories([
                        { id: 'main', name: 'Main', dashers: [] },
                        { id: 'currently-using', name: 'Currently using', dashers: [] },
                        { id: 'deactivated', name: 'Deactivated', dashers: [] },
                        { id: 'locked', name: 'Locked', dashers: [] },
                        { id: 'reverif', name: 'Reverif', dashers: [] },
                        { id: 'ready', name: 'Ready', dashers: [] }
                    ]);
                    localStorage.removeItem('dashBashState');
                    localStorage.removeItem('addressBookCategories');
                    setSaveNotification('✅ All data cleared');
                    setTimeout(() => setSaveNotification(''), 3000);
                }
            };

            const formatTime = (timeStr) => {
                if (!timeStr || timeStr.length !== 4) return '';
                const hours = timeStr.substring(0, 2);
                const minutes = timeStr.substring(2, 4);
                return `${hours}:${minutes}`;
            };

            const calculateTimeStatus = (closeTimeStr) => {
                if (!closeTimeStr || closeTimeStr.length !== 4) return null;

                const closeHours = parseInt(closeTimeStr.substring(0, 2));
                const closeMinutes = parseInt(closeTimeStr.substring(2, 4));

                const now = new Date();
                const todayClose = new Date(now);
                todayClose.setHours(closeHours, closeMinutes, 0, 0);

                // If closing time has passed today, assume it's tomorrow's closing time
                if (todayClose < now) {
                    todayClose.setDate(todayClose.getDate() + 1);
                }

                const diffMs = todayClose - now;
                const diffMinutes = Math.floor(diffMs / (1000 * 60));
                const diffHours = Math.floor(diffMinutes / 60);
                const remainingMinutes = diffMinutes % 60;

                // Check if store is closed (assuming 6am opening time)
                const todayOpen = new Date(now);
                todayOpen.setHours(6, 0, 0, 0);

                if (now < todayOpen || (diffMs < 0 && Math.abs(diffMinutes) > 12 * 60)) {
                    return { status: 'closed', text: 'Closed', color: 'text-red-400' };
                }

                if (diffMinutes < 0) {
                    return { status: 'closed', text: 'Closed', color: 'text-red-400' };
                }

                let color = 'text-green-400'; // More than 2 hours
                if (diffMinutes < 120) color = 'text-yellow-400'; // Less than 2 hours
                if (diffMinutes < 60) color = 'text-red-400'; // Less than 1 hour

                const timeText = diffHours > 0
                    ? `${diffHours}h ${remainingMinutes}m left`
                    : `${diffMinutes}m left`;

                return {
                    status: 'open',
                    text: timeText,
                    color,
                    formatted: formatTime(closeTimeStr)
                };
            };

            const addCategory = () => {
                if (newCategoryName.trim()) {
                    const newCategory = {
                        id: Date.now(),
                        name: newCategoryName.trim(),
                        stores: []
                    };
                    setCategories([...categories, newCategory]);
                    setNewCategoryName('');
                    setIsAddingCategory(false);

                    // Auto-save
                    setTimeout(() => {
                        saveAllToLocalStorage();
                    }, 100);
                }
            };

            const updateCategory = (categoryId, newName) => {
                setCategories(categories.map(cat =>
                    cat.id === categoryId ? { ...cat, name: newName } : cat
                ));

                // Auto-save
                setTimeout(() => {
                    saveAllToLocalStorage();
                }, 100);
            };

            const deleteCategory = (categoryId) => {
                setCategories(categories.filter(cat => cat.id !== categoryId));

                // Auto-save
                setTimeout(() => {
                    saveAllToLocalStorage();
                }, 100);
            };

            const addStore = (categoryId) => {
                const newStore = {
                    id: Date.now(),
                    address: "",
                    openTime: "",
                    closeTime: "",
                    notes: ""
                };
                setCategories(categories.map(cat =>
                    cat.id === categoryId
                        ? { ...cat, stores: [...cat.stores, newStore] }
                        : cat
                ));

                // Auto-save
                setTimeout(() => {
                    saveAllToLocalStorage();
                }, 100);
            };

            const updateStore = (categoryId, storeId, field, value) => {
                setCategories(categories.map(cat =>
                    cat.id === categoryId
                        ? {
                            ...cat,
                            stores: cat.stores.map(store =>
                                store.id === storeId ? { ...store, [field]: value } : store
                            )
                        }
                        : cat
                ));

                // Auto-save
                setTimeout(() => {
                    saveAllToLocalStorage();
                }, 100);
            };

            const deleteStore = (categoryId, storeId) => {
                setCategories(categories.map(cat =>
                    cat.id === categoryId
                        ? { ...cat, stores: cat.stores.filter(store => store.id !== storeId) }
                        : cat
                ));

                // Auto-save
                setTimeout(() => {
                    saveAllToLocalStorage();
                }, 100);
            };

            const toggleEditStore = (categoryId, storeId) => {
                if (editingStore.categoryId === categoryId && editingStore.storeId === storeId) {
                    setEditingStore({ categoryId: -1, storeId: -1 });
                } else {
                    setEditingStore({ categoryId, storeId });
                }
            };

            const isStoreEditing = (categoryId, storeId) => {
                return editingStore.categoryId === categoryId && editingStore.storeId === storeId;
            };

            const toggleCategoryCollapse = (categoryId) => {
                setCollapsedCategories(prev => ({
                    ...prev,
                    [categoryId]: !prev[categoryId]
                }));
            };

            const toggleStoreCollapse = (categoryId, storeId) => {
                const key = `${categoryId}-${storeId}`;
                setCollapsedStores(prev => ({
                    ...prev,
                    [key]: !prev[key]
                }));
            };

            const isStoreCollapsed = (categoryId, storeId) => {
                const key = `${categoryId}-${storeId}`;
                return collapsedStores[key] || false;
            };

            const getStoresStatusCount = (stores) => {
                let openCount = 0;
                let closedCount = 0;

                stores.forEach(store => {
                    const status = calculateTimeStatus(store.closeTime);
                    if (status && status.status === 'open') {
                        openCount++;
                    } else if (status && status.status === 'closed') {
                        closedCount++;
                    }
                });

                return { openCount, closedCount };
            };

            const handleStoreDragStart = (e, categoryId, storeIndex) => {
                setDraggedStore({ categoryId, storeIndex });
                e.dataTransfer.effectAllowed = 'move';
            };

            const handleStoreDragOver = (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            };

            const handleStoreDrop = (e, categoryId, storeIndex) => {
                e.preventDefault();
                if (draggedStore.categoryId === categoryId && draggedStore.storeIndex !== storeIndex) {
                    const updatedCategories = [...categories];
                    const categoryIndex = categories.findIndex(cat => cat.id === categoryId);
                    const category = updatedCategories[categoryIndex];
                    const draggedStoreItem = category.stores[draggedStore.storeIndex];

                    const newStores = [...category.stores];
                    newStores.splice(draggedStore.storeIndex, 1);
                    newStores.splice(storeIndex, 0, draggedStoreItem);

                    updatedCategories[categoryIndex] = { ...category, stores: newStores };
                    setCategories(updatedCategories);
                }
                setDraggedStore({ categoryId: -1, storeIndex: -1 });
            };

            const calculateQuantities = (price, targetAmount) => {
                if (price === 0) return { validOptions: [] };

                const maxQuantity = Math.floor(targetAmount / price);
                const validOptions = [];

                for (let qty = maxQuantity; qty >= 1; qty--) {
                    const total = qty * price;
                    if (total <= targetAmount) {
                        validOptions.push({
                            quantity: qty,
                            total: total,
                            difference: targetAmount - total
                        });
                    }
                }

                return { validOptions };
            };

            const findBestOption = (validOptions) => {
                if (validOptions.length === 0) return null;

                return validOptions.sort((a, b) => {
                    if (Math.abs(a.difference - b.difference) < 0.01) {
                        return a.quantity - b.quantity;
                    }
                    return a.difference - b.difference;
                })[0];
            };

            // Notes Management Functions
            const addNoteCategory = () => {
                const newCategory = {
                    id: Date.now().toString(),
                    name: 'New Category',
                    notes: []
                };
                setNoteCategories([...noteCategories, newCategory]);

                // Auto-save
                setTimeout(() => {
                    saveAllToLocalStorage();
                }, 100);
            };

            const updateNoteCategory = (categoryId, newName) => {
                setNoteCategories(noteCategories.map(cat =>
                    cat.id === categoryId ? { ...cat, name: newName } : cat
                ));

                // Auto-save
                setTimeout(() => {
                    saveAllToLocalStorage();
                }, 100);
            };

            const deleteNoteCategory = (categoryId) => {
                if (noteCategories.length === 1) {
                    setSaveNotification('❌ Cannot delete the last category');
                    setTimeout(() => setSaveNotification(''), 3000);
                    return;
                }

                setNoteCategories(noteCategories.filter(cat => cat.id !== categoryId));

                // Auto-save
                setTimeout(() => {
                    saveAllToLocalStorage();
                }, 100);
            };

            const addNote = (categoryId) => {
                const newNote = '';
                setNoteCategories(noteCategories.map(cat =>
                    cat.id === categoryId
                        ? { ...cat, notes: [...cat.notes, newNote] }
                        : cat
                ));

                // Start editing the new note immediately
                const categoryIndex = noteCategories.findIndex(cat => cat.id === categoryId);
                if (categoryIndex !== -1) {
                    const newNoteIndex = noteCategories[categoryIndex].notes.length;
                    setEditingNote({ categoryId, noteIndex: newNoteIndex });
                }

                // Auto-save
                setTimeout(() => {
                    saveAllToLocalStorage();
                }, 100);
            };

            const updateNote = (categoryId, noteIndex, newText) => {
                setNoteCategories(noteCategories.map(cat =>
                    cat.id === categoryId
                        ? {
                            ...cat,
                            notes: cat.notes.map((note, idx) =>
                                idx === noteIndex ? newText : note
                            )
                        }
                        : cat
                ));

                // Auto-save
                setTimeout(() => {
                    saveAllToLocalStorage();
                }, 100);
            };

            const deleteNote = (categoryId, noteIndex) => {
                setNoteCategories(noteCategories.map(cat =>
                    cat.id === categoryId
                        ? { ...cat, notes: cat.notes.filter((_, idx) => idx !== noteIndex) }
                        : cat
                ));

                // Auto-save
                setTimeout(() => {
                    saveAllToLocalStorage();
                }, 100);
            };

            const toggleNoteEdit = (categoryId, noteIndex) => {
                if (editingNote.categoryId === categoryId && editingNote.noteIndex === noteIndex) {
                    setEditingNote({ categoryId: '', noteIndex: -1 });
                } else {
                    setEditingNote({ categoryId, noteIndex });
                }
            };

            const isNoteEditing = (categoryId, noteIndex) => {
                return editingNote.categoryId === categoryId && editingNote.noteIndex === noteIndex;
            };

            const toggleNoteCategoryCollapse = (categoryId) => {
                setCollapsedNoteCategories(prev => ({
                    ...prev,
                    [categoryId]: !prev[categoryId]
                }));
            };

            // Expand/Collapse all note categories
            const expandAllNoteCategories = () => {
                setCollapsedNoteCategories({});
                // Auto-save after expanding all
                setTimeout(() => {
                    saveAllToLocalStorage();
                }, 100);
            };

            const collapseAllNoteCategories = () => {
                const allCollapsed = {};
                noteCategories.forEach(cat => {
                    allCollapsed[cat.id] = true;
                });
                setCollapsedNoteCategories(allCollapsed);
                // Auto-save after collapsing all
                setTimeout(() => {
                    saveAllToLocalStorage();
                }, 100);
            };

            const handleNoteDragStart = (e, categoryId, noteIndex) => {
                setDraggedNote({ categoryId, noteIndex });
                e.dataTransfer.effectAllowed = 'move';
            };

            const handleNoteDragOver = (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            };

            const handleNoteDrop = (e, targetCategoryId) => {
                e.preventDefault();
                if (!draggedNote.categoryId || draggedNote.noteIndex === -1) return;

                if (draggedNote.categoryId !== targetCategoryId) {
                    // Move note between categories
                    const sourceCategory = noteCategories.find(cat => cat.id === draggedNote.categoryId);
                    const noteToMove = sourceCategory.notes[draggedNote.noteIndex];

                    setNoteCategories(noteCategories.map(cat => {
                        if (cat.id === draggedNote.categoryId) {
                            // Remove from source
                            return { ...cat, notes: cat.notes.filter((_, idx) => idx !== draggedNote.noteIndex) };
                        } else if (cat.id === targetCategoryId) {
                            // Add to target
                            return { ...cat, notes: [...cat.notes, noteToMove] };
                        }
                        return cat;
                    }));

                    // Auto-save
                    setTimeout(() => {
                        saveAllToLocalStorage();
                    }, 100);
                }

                setDraggedNote({ categoryId: '', noteIndex: -1 });
            };

            // Dasher Category Management Functions
            const addDasherCategory = () => {
                const categoryName = prompt('Enter category name:');
                if (categoryName && categoryName.trim()) {
                    const newCategory = {
                        id: Date.now().toString(),
                        name: categoryName.trim(),
                        dashers: []
                    };
                    setDasherCategories([...dasherCategories, newCategory]);
                }
            };

            const updateDasherCategory = (categoryId, newName) => {
                setDasherCategories(dasherCategories.map(cat =>
                    cat.id === categoryId ? { ...cat, name: newName } : cat
                ));
            };

            const deleteDasherCategory = (categoryId) => {
                // Don't delete if it's the last category
                if (dasherCategories.length === 1) {
                    alert("You must have at least one dasher category.");
                    return;
                }

                if (confirm(`Delete this category and all its dashers?`)) {
                    setDasherCategories(dasherCategories.filter(cat => cat.id !== categoryId));
                }
            };

            // Dasher Category Drag and Drop
            const handleDasherCategoryDragStart = (e, categoryId) => {
                setDraggedDasherCategory(categoryId);
                e.dataTransfer.effectAllowed = 'move';
            };

            const handleDasherCategoryDragOver = (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            };

            const handleDasherCategoryDrop = (e, targetCategoryId) => {
                e.preventDefault();
                e.stopPropagation();

                if (!draggedDasherCategory || draggedDasherCategory === targetCategoryId) {
                    return;
                }

                const sourceIndex = dasherCategories.findIndex(cat => cat.id === draggedDasherCategory);
                const targetIndex = dasherCategories.findIndex(cat => cat.id === targetCategoryId);

                if (sourceIndex === -1 || targetIndex === -1) return;

                const newCategories = [...dasherCategories];
                const [removed] = newCategories.splice(sourceIndex, 1);
                newCategories.splice(targetIndex, 0, removed);

                setDasherCategories(newCategories);
                setDraggedDasherCategory(null);
            };

            // Dasher Management Functions
            const addDasher = (categoryId) => {
                const newDasher = {
                    id: Date.now().toString(),
                    name: '',
                    email: '',
                    emailPw: '',
                    dasherPw: '',
                    phone: '',
                    balance: '',
                    crimson: false,
                    redCard: false,
                    appealed: false,
                    appealedAt: null,
                    crimsonAt: null,
                    redCardAt: null,
                    deactivated: false,
                    deactivatedAt: null,
                    ready: false,
                    readyAt: null,
                    lastUsed: null,
                    notes: ''
                };
                setDasherCategories(dasherCategories.map(cat =>
                    cat.id === categoryId
                        ? { ...cat, dashers: [...cat.dashers, newDasher] }
                        : cat
                ));

                // Auto-save
                setTimeout(() => {
                    saveAllToLocalStorage();
                }, 100);
            };

            const updateDasher = (categoryId, dasherId, field, value, options = {}) => {
                // Validate email if updating email field
                if (field === 'email' && value) {
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(value) && value.includes('@')) {
                        // Only validate if it looks like they're trying to enter an email
                        return; // Don't update if invalid email format
                    }

                    // Check for duplicate email across all categories
                    const isDuplicate = dasherCategories.some(cat =>
                        cat.dashers.some(dasher =>
                            dasher.id !== dasherId && dasher.email && dasher.email.toLowerCase() === value.toLowerCase()
                        )
                    );

                    if (isDuplicate) {
                        // Show a toast or alert for duplicate email
                        setSaveNotification('⚠️ A dasher with this email already exists');
                        setTimeout(() => setSaveNotification(''), 3000);
                        return; // Don't update if duplicate email
                    }
                }

                // Special handling for appealed / ready / crimson / redCard fields to set/clear timestamps
                const timestampMap = {
                    appealed: 'appealedAt',
                    ready: 'readyAt',
                    crimson: 'crimsonAt',
                    redCard: 'redCardAt'
                };
                if (timestampMap[field]) {
                    setDasherCategories(dasherCategories.map(cat =>
                        cat.id === categoryId
                            ? {
                                ...cat,
                                dashers: cat.dashers.map(dasher => {
                                    if (dasher.id === dasherId) {
                                        const tsField = timestampMap[field];
                                        if (value === true) {
                                            return { ...dasher, [field]: value, [tsField]: new Date().toISOString() };
                                        } else {
                                            // Clear timestamp when turning off
                                            return { ...dasher, [field]: value, [tsField]: null };
                                        }
                                    }
                                    return dasher;
                                })
                            }
                            : cat
                    ));
                } else {
                    setDasherCategories(dasherCategories.map(cat =>
                        cat.id === categoryId
                            ? {
                                ...cat,
                                dashers: cat.dashers.map(dasher =>
                                    dasher.id === dasherId ? { ...dasher, [field]: value } : dasher
                                )
                            }
                            : cat
                    ));
                }

                // Auto-save
                setTimeout(() => {
                    saveAllToLocalStorage();
                }, 100);
            };

            const deleteDasher = (categoryId, dasherId) => {
                setDasherCategories(dasherCategories.map(cat =>
                    cat.id === categoryId
                        ? { ...cat, dashers: cat.dashers.filter(dasher => dasher.id !== dasherId) }
                        : cat
                ));

                // Auto-save
                setTimeout(() => {
                    saveAllToLocalStorage();
                }, 100);
            };

            const archiveDasher = (categoryId, dasherId) => {
                // Find the dasher to archive
                let dasherToArchive = null;
                let foundCategory = dasherCategories.find(cat => {
                    const dasher = cat.dashers.find(d => d.id === dasherId);
                    if (dasher) {
                        dasherToArchive = {
                            ...dasher,
                            originalCategory: categoryId,
                            archivedAt: new Date().toISOString()
                        };
                        return true;
                    }
                    return false;
                });

                if (dasherToArchive) {
                    // Add to archived dashers (newest first)
                    setArchivedDashers([dasherToArchive, ...archivedDashers]);

                    // Remove from current category
                    setDasherCategories(dasherCategories.map(cat =>
                        cat.id === categoryId
                            ? { ...cat, dashers: cat.dashers.filter(d => d.id !== dasherId) }
                            : cat
                    ));

                    // Auto-save
                    setTimeout(() => {
                        saveAllToLocalStorage();
                    }, 100);
                }
            };

            const deactivateDasher = (categoryId, dasherId) => {
                const category = dasherCategories.find(cat => cat.id === categoryId);
                if (!category) return;
                const dasher = category.dashers.find(d => d.id === dasherId);
                if (!dasher) return;
                // Remove from category list
                const updatedCategories = dasherCategories.map(cat =>
                    cat.id === categoryId ? { ...cat, dashers: cat.dashers.filter(d => d.id !== dasherId) } : cat
                );
                setDasherCategories(updatedCategories);
                // Add to deactivated list (newest first)
                const moved = { ...dasher, deactivated: true, deactivatedAt: new Date().toISOString() };
                setDeactivatedDashers([moved, ...deactivatedDashers]);
                setTimeout(saveAllToLocalStorage, 100);
            };

            const reactivateDasher = (dasherId) => {
                const dasher = deactivatedDashers.find(d => d.id === dasherId);
                if (!dasher) return;
                // Remove from deactivated list
                setDeactivatedDashers(deactivatedDashers.filter(d => d.id !== dasherId));
                // Return to main category by default
                const updatedCategories = dasherCategories.map(cat => {
                    if (cat.id === 'main') {
                        return { ...cat, dashers: [...cat.dashers, { ...dasher, deactivated: false }] };
                    }
                    return cat;
                });
                setDasherCategories(updatedCategories);
                setTimeout(saveAllToLocalStorage, 100);
            };

            const unarchiveDasher = (dasherId) => {
                const archivedDasher = archivedDashers.find(d => d.id === dasherId);
                if (archivedDasher) {
                    const { originalCategory, archivedAt, ...dasherData } = archivedDasher;

                    // Check if original category still exists
                    const categoryExists = dasherCategories.some(cat => cat.id === originalCategory);
                    const targetCategory = categoryExists ? originalCategory : dasherCategories[0]?.id;

                    if (targetCategory) {
                        // Add back to the category
                        setDasherCategories(dasherCategories.map(cat =>
                            cat.id === targetCategory
                                ? { ...cat, dashers: [...cat.dashers, dasherData] }
                                : cat
                        ));

                        // Remove from archived
                        setArchivedDashers(archivedDashers.filter(d => d.id !== dasherId));

                        // Auto-save
                        setTimeout(() => {
                            saveAllToLocalStorage();
                        }, 100);
                    }
                }
            };

            // Move dasher to Ready category
            const moveDasherToReady = (categoryId, dasherId) => {
                const category = dasherCategories.find(cat => cat.id === categoryId);
                if (!category) return;
                const dasher = category.dashers.find(d => d.id === dasherId);
                if (!dasher) return;
                // Remove from source category
                const updatedCategories = dasherCategories.map(cat =>
                    cat.id === categoryId ? { ...cat, dashers: cat.dashers.filter(d => d.id !== dasherId) } : cat
                );
                setDasherCategories(updatedCategories);
                // Add to ready list (newest first)
                const moved = { ...dasher, ready: true, readyAt: new Date().toISOString() };
                setReadyDashers([moved, ...readyDashers]);
                setTimeout(saveAllToLocalStorage, 100);
            };

            // Move dasher to Currently Using category
            const moveDasherToCurrentlyUsing = (categoryId, dasherId) => {
                const category = dasherCategories.find(cat => cat.id === categoryId);
                if (!category) return;
                const dasher = category.dashers.find(d => d.id === dasherId);
                if (!dasher) return;
                // Remove from source category
                const updatedCategories = dasherCategories.map(cat =>
                    cat.id === categoryId ? { ...cat, dashers: cat.dashers.filter(d => d.id !== dasherId) } : cat
                );
                setDasherCategories(updatedCategories);
                // Add to currently using list (newest first)
                const moved = { ...dasher, currentlyUsing: true, currentlyUsingAt: new Date().toISOString() };
                setCurrentlyUsingDashers([moved, ...currentlyUsingDashers]);
                setTimeout(saveAllToLocalStorage, 100);
            };

            // Move dasher to Appealed category
            const moveDasherToAppealed = (categoryId, dasherId) => {
                const category = dasherCategories.find(cat => cat.id === categoryId);
                if (!category) return;
                const dasher = category.dashers.find(d => d.id === dasherId);
                if (!dasher) return;
                // Remove from source category
                const updatedCategories = dasherCategories.map(cat =>
                    cat.id === categoryId ? { ...cat, dashers: cat.dashers.filter(d => d.id !== dasherId) } : cat
                );
                setDasherCategories(updatedCategories);
                // Add to appealed list (newest first)
                const moved = { ...dasher, appealed: true, appealedAt: new Date().toISOString() };
                setAppealedDashers([moved, ...appealedDashers]);
                setTimeout(saveAllToLocalStorage, 100);
            };

            // Restore dasher to main category from any special category
            const restoreDasherToMain = (dasherId, sourceCategory) => {
                let dasher = null;

                // Find and remove from source category
                if (sourceCategory === 'ready') {
                    dasher = readyDashers.find(d => d.id === dasherId);
                    if (dasher) {
                        setReadyDashers(readyDashers.filter(d => d.id !== dasherId));
                        const { ready, readyAt, ...cleanedDasher } = dasher;
                        dasher = cleanedDasher;
                    }
                } else if (sourceCategory === 'currently-using') {
                    dasher = currentlyUsingDashers.find(d => d.id === dasherId);
                    if (dasher) {
                        setCurrentlyUsingDashers(currentlyUsingDashers.filter(d => d.id !== dasherId));
                        const { currentlyUsing, currentlyUsingAt, ...cleanedDasher } = dasher;
                        dasher = cleanedDasher;
                    }
                } else if (sourceCategory === 'appealed') {
                    dasher = appealedDashers.find(d => d.id === dasherId);
                    if (dasher) {
                        setAppealedDashers(appealedDashers.filter(d => d.id !== dasherId));
                        const { appealed, appealedAt, ...cleanedDasher } = dasher;
                        dasher = cleanedDasher;
                    }
                }

                if (!dasher) return;

                // Add back to main category
                const updatedCategories = dasherCategories.map(cat => {
                    if (cat.id === 'main') {
                        return { ...cat, dashers: [...cat.dashers, dasher] };
                    }
                    return cat;
                });
                setDasherCategories(updatedCategories);
                setTimeout(saveAllToLocalStorage, 100);
            };

            const toggleEditDasher = (categoryId, dasherId) => {
                if (editingDasher.categoryId === categoryId && editingDasher.dasherId === dasherId) {
                    setEditingDasher({ categoryId: '', dasherId: '' });
                } else {
                    setEditingDasher({ categoryId, dasherId });
                }
            };

            const isDasherEditing = (categoryId, dasherId) => {
                return editingDasher.categoryId === categoryId && editingDasher.dasherId === dasherId;
            };

            const toggleDasherCategoryCollapse = (categoryId) => {
                setCollapsedDasherCategories(prev => ({
                    ...prev,
                    [categoryId]: !prev[categoryId]
                }));
            };

            const startDasherTimer = (categoryId, dasherId) => {
                const now = new Date().toISOString();
                updateDasher(categoryId, dasherId, 'lastUsed', now);
                // Auto-save after timer start
                setTimeout(() => {
                    saveAllToLocalStorage();
                }, 100);
            };

            const resetDasherTimer = (categoryId, dasherId) => {
                updateDasher(categoryId, dasherId, 'lastUsed', null);
                // Auto-save after timer reset
                setTimeout(() => {
                    saveAllToLocalStorage();
                }, 100);
            };

            const resetAppealedTimer = (categoryId, dasherId) => {
                // Reset appealedAt without changing appealed status
                setDasherCategories(dasherCategories.map(cat =>
                    cat.id === categoryId
                        ? {
                            ...cat,
                            dashers: cat.dashers.map(dasher =>
                                dasher.id === dasherId ? { ...dasher, appealedAt: null } : dasher
                            )
                        }
                        : cat
                ));
                // Auto-save after timer reset
                setTimeout(() => {
                    saveAllToLocalStorage();
                }, 100);
            };

            const toggleDasherCollapse = (categoryId, dasherId) => {
                const key = categoryId + '-' + dasherId;
                setCollapsedDashers(prev => ({
                    ...prev,
                    [key]: !prev[key]
                }));
            };

            const isDasherCollapsed = (categoryId, dasherId) => {
                const key = categoryId + '-' + dasherId;
                // Default to collapsed (true) if no saved state exists
                return collapsedDashers[key] !== undefined ? collapsedDashers[key] : true;
            };

            const calculateAppealedTimeStatus = (appealedAtTime) => {
                if (!appealedAtTime) return null;

                const appealedAt = new Date(appealedAtTime);
                const now = new Date();
                const diffMs = now - appealedAt;
                const diffHours = diffMs / (1000 * 60 * 60);
                const diffMinutes = Math.floor((diffMs / (1000 * 60)) % 60);
                const diffSeconds = Math.floor((diffMs / 1000) % 60);
                const diffDays = Math.floor(diffHours / 24);

                // Format the date/time details
                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const dayName = days[appealedAt.getDay()];
                const month = (appealedAt.getMonth() + 1).toString().padStart(2, '0');
                const date = appealedAt.getDate().toString().padStart(2, '0');
                const hours = appealedAt.getHours().toString().padStart(2, '0');
                const minutes = appealedAt.getMinutes().toString().padStart(2, '0');
                const seconds = appealedAt.getSeconds().toString().padStart(2, '0');

                if (diffDays > 0) {
                    // Show days and hours if more than 24 hours
                    const remainingHours = Math.floor(diffHours % 24);
                    return {
                        text: `${diffDays}d ${remainingHours}h ago`,
                        fullDate: `${dayName} ${month}/${date} ${hours}:${minutes}:${seconds}`,
                        color: 'text-purple-400' // Purple for appealed timer
                    };
                } else if (diffHours >= 1) {
                    // Show hours and minutes
                    const wholeHours = Math.floor(diffHours);
                    return {
                        text: `${wholeHours}h ${diffMinutes}m ago`,
                        fullDate: `${dayName} ${month}/${date} ${hours}:${minutes}:${seconds}`,
                        color: 'text-purple-400'
                    };
                } else if (diffMinutes >= 1) {
                    // Show minutes and seconds
                    return {
                        text: `${diffMinutes}m ${diffSeconds}s ago`,
                        fullDate: `${dayName} ${month}/${date} ${hours}:${minutes}:${seconds}`,
                        color: 'text-purple-400'
                    };
                } else {
                    // Show seconds only
                    return {
                        text: `${diffSeconds}s ago`,
                        fullDate: `${dayName} ${month}/${date} ${hours}:${minutes}:${seconds}`,
                        color: 'text-purple-400'
                    };
                }
            };

            const calculateDasherTimeStatus = (lastUsedTime) => {
                if (!lastUsedTime) return null;

                const lastUsed = new Date(lastUsedTime);
                const now = new Date();
                const diffMs = now - lastUsed;
                const diffHours = diffMs / (1000 * 60 * 60);
                const diffMinutes = Math.floor((diffMs / (1000 * 60)) % 60);
                const diffSeconds = Math.floor((diffMs / 1000) % 60);
                const remainingHours = 24 - diffHours;

                // Format the date/time details
                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const dayOfWeek = days[lastUsed.getDay()];
                const date = lastUsed.toLocaleDateString();
                const time = lastUsed.toLocaleTimeString();
                const fullDateTime = `${dayOfWeek}, ${date} at ${time}`;

                if (diffHours < 24) {
                    // Still within 24 hours
                    const hoursLeft = Math.floor(remainingHours);
                    const minutesLeft = Math.floor((remainingHours - hoursLeft) * 60);
                    const secondsLeft = Math.floor(((remainingHours - hoursLeft) * 60 - minutesLeft) * 60);

                    let color = 'text-red-400'; // Default red for < 24 hours
                    if (remainingHours <= 1) {
                        color = 'text-orange-400'; // Orange for last hour
                    }

                    let timeText = '';
                    if (hoursLeft > 0) {
                        timeText = `${hoursLeft}h ${minutesLeft}m ${secondsLeft}s left`;
                    } else if (minutesLeft > 0) {
                        timeText = `${minutesLeft}m ${secondsLeft}s left`;
                    } else {
                        timeText = `${secondsLeft}s left`;
                    }

                    return {
                        status: 'countdown',
                        text: timeText,
                        color,
                        hoursRemaining: remainingHours,
                        fullDateTime: fullDateTime
                    };
                } else {
                    // More than 24 hours
                    const daysElapsed = Math.floor(diffHours / 24);
                    const hoursElapsed = Math.floor(diffHours % 24);
                    const minutesElapsed = Math.floor((diffMs / (1000 * 60)) % 60);

                    return {
                        status: 'elapsed',
                        text: daysElapsed > 0
                            ? `${daysElapsed}d ${hoursElapsed}h ${minutesElapsed}m ago`
                            : `${Math.floor(diffHours)}h ${diffMinutes}m ago`,
                        color: 'text-green-400',
                        hoursElapsed: diffHours,
                        fullDateTime: fullDateTime
                    };
                }
            };

            const getDasherTitle = (dasher) => {
                try {
                    if (!dasher) {
                        return React.createElement('span', { key: 'error' }, 'Invalid Dasher');
                    }

                    const parts = [];

                    // Name (purple - keep default color)
                    if (dasher.name) {
                        parts.push(React.createElement('span', { key: 'name' }, dasher.name));
                    }

                    // Email (blue)
                    if (dasher.email) {
                        if (parts.length > 0) parts.push(React.createElement('span', { key: 'sep1' }, ' - '));
                        parts.push(React.createElement('span', { key: 'email', className: 'text-blue-400' }, dasher.email));
                    }

                    // If no name or email
                    if (parts.length === 0) {
                        parts.push(React.createElement('span', { key: 'new' }, 'New Dasher'));
                    }

                    // (Legacy inline status indicators removed; unified flag badge row now handles status display.)

                    // Balance (green if $0, red otherwise)
                    if (dasher.balance) {
                        const balance = dasher.balance.toString().startsWith('$')
                            ? dasher.balance
                            : `$${dasher.balance}`;

                        // Check if balance is $0
                        const balanceValue = balance.replace('$', '');
                        const isZero = parseFloat(balanceValue) === 0;

                        parts.push(React.createElement('span', { key: 'sep2' }, ' - '));
                        parts.push(React.createElement('span', {
                            key: 'balance',
                            className: isZero ? 'text-green-400' : 'text-red-500'
                        }, balance));
                    }

                    // Add last used time if available
                    if (dasher.lastUsed) {
                        const timeStatus = calculateDasherTimeStatus(dasher.lastUsed);
                        if (timeStatus && timeStatus.text) {
                            parts.push(React.createElement('span', { key: 'time' }, ` (${timeStatus.text})`));
                        }
                    }

                    return React.createElement(React.Fragment, {}, parts);
                } catch (error) {
                    console.error('Error in getDasherTitle:', error, dasher);
                    return React.createElement('span', { key: 'error' }, 'Error displaying dasher');
                }
            };

            // Expand/Collapse all for Address Book
            const expandAllCategories = () => {
                setCollapsedCategories({});
                // Auto-save after expanding all
                setTimeout(() => {
                    saveAllToLocalStorage();
                }, 100);
            };

            const collapseAllCategories = () => {
                const allCollapsed = {};
                categories.forEach(cat => {
                    allCollapsed[cat.id] = true;
                });
                setCollapsedCategories(allCollapsed);
                // Auto-save after collapsing all
                setTimeout(() => {
                    saveAllToLocalStorage();
                }, 100);
            };

            // Expand/Collapse all dashers (keep categories visible, like Store Address Book)
            const expandAllDasherCategories = () => {
                // Expand all categories (make them visible)
                setCollapsedDasherCategories({});

                // Expand all individual dashers within categories
                const allDashersExpanded = {};
                dasherCategories.forEach(cat => {
                    cat.dashers.forEach(dasher => {
                        const key = `${cat.id}-${dasher.id}`;
                        allDashersExpanded[key] = false;
                    });
                });
                setCollapsedDashers(allDashersExpanded);

                // Auto-save after expanding all
                setTimeout(() => {
                    saveAllToLocalStorage();
                }, 100);
            };

            const collapseAllDasherCategories = () => {
                // Keep categories expanded/visible (don't collapse them)
                setCollapsedDasherCategories({});

                // Collapse all individual dashers only
                const allDashersCollapsed = {};
                dasherCategories.forEach(cat => {
                    cat.dashers.forEach(dasher => {
                        const key = `${cat.id}-${dasher.id}`;
                        allDashersCollapsed[key] = true;
                    });
                });
                setCollapsedDashers(allDashersCollapsed);

                // Auto-save after collapsing all
                setTimeout(() => {
                    saveAllToLocalStorage();
                }, 100);
            };

            // Selection Helper Functions for Edit Mode
            const toggleItemSelection = (type, id) => {
                setSelectedItems(prev => {
                    const newSelected = { ...prev };
                    const set = new Set(newSelected[type]);

                    if (set.has(id)) {
                        set.delete(id);
                    } else {
                        set.add(id);
                    }

                    newSelected[type] = set;
                    return newSelected;
                });
            };

            const toggleCategorySelection = (type, categoryId, items) => {
                setSelectedItems(prev => {
                    const newSelected = { ...prev };
                    const itemSet = new Set(newSelected[type]);
                    const categorySet = new Set(newSelected[type + 'Categories']);

                    // Check if all items in category are selected
                    const allSelected = items.every(item => itemSet.has(item));

                    if (allSelected) {
                        // Deselect all items in category
                        items.forEach(item => itemSet.delete(item));
                        categorySet.delete(categoryId);
                    } else {
                        // Select all items in category
                        items.forEach(item => itemSet.add(item));
                        categorySet.add(categoryId);
                    }

                    newSelected[type] = itemSet;
                    newSelected[type + 'Categories'] = categorySet;
                    return newSelected;
                });
            };

            const clearAllSelections = () => {
                setSelectedItems({
                    dashers: new Set(),
                    dasherCategories: new Set(),
                    notes: new Set(),
                    noteCategories: new Set(),
                    stores: new Set(),
                    storeCategories: new Set(),
                    messages: new Set(),
                    archivedDashers: new Set()
                });
            };

            const getSelectionCount = () => {
                let count = 0;
                Object.values(selectedItems).forEach(set => {
                    count += set.size;
                });
                return count;
            };

            // Archived Dasher Collapse Functions
            const toggleArchivedDasherCollapse = (dasherId) => {
                const newCollapsed = { ...collapsedArchivedDashers };
                if (newCollapsed[dasherId]) {
                    delete newCollapsed[dasherId];
                } else {
                    newCollapsed[dasherId] = true;
                }
                setCollapsedArchivedDashers(newCollapsed);

                // Auto-save
                setTimeout(() => {
                    saveAllToLocalStorage();
                }, 100);
            };

            const expandAllArchivedDashers = () => {
                setCollapsedArchivedDashers({});
                setTimeout(() => {
                    saveAllToLocalStorage();
                }, 100);
            };

            const collapseAllArchivedDashers = () => {
                const allCollapsed = {};
                archivedDashers.forEach(dasher => {
                    allCollapsed[dasher.id] = true;
                });
                setCollapsedArchivedDashers(allCollapsed);
                setTimeout(() => {
                    saveAllToLocalStorage();
                }, 100);
            };

            const isArchivedDasherCollapsed = (dasherId) => {
                return collapsedArchivedDashers[dasherId] || false;
            };

            // Expand/Collapse all for Dashers
            const expandAllDashers = () => {
                const allExpanded = {};
                dasherCategories.forEach(cat => {
                    cat.dashers.forEach(dasher => {
                        const key = `${cat.id}-${dasher.id}`;
                        allExpanded[key] = false;
                    });
                });
                setCollapsedDashers(allExpanded);
                // Auto-save after expanding all
                setTimeout(() => {
                    saveAllToLocalStorage();
                }, 100);
            };

            const collapseAllDashers = () => {
                const allCollapsed = {};
                dasherCategories.forEach(cat => {
                    cat.dashers.forEach(dasher => {
                        const key = `${cat.id}-${dasher.id}`;
                        allCollapsed[key] = true;
                    });
                });
                setCollapsedDashers(allCollapsed);
                // Auto-save after collapsing all
                setTimeout(() => {
                    saveAllToLocalStorage();
                }, 100);
            };

            // Expand/Collapse all dashers in a specific category
            const expandAllDashersInCategory = (categoryId) => {
                const category = dasherCategories.find(c => c.id === categoryId);
                if (category) {
                    const updatedCollapsed = { ...collapsedDashers };
                    category.dashers.forEach(dasher => {
                        const key = `${categoryId}-${dasher.id}`;
                        updatedCollapsed[key] = false;
                    });
                    setCollapsedDashers(updatedCollapsed);
                    setTimeout(() => saveAllToLocalStorage(), 100);
                }
            };

            const collapseAllDashersInCategory = (categoryId) => {
                const category = dasherCategories.find(c => c.id === categoryId);
                if (category) {
                    const updatedCollapsed = { ...collapsedDashers };
                    category.dashers.forEach(dasher => {
                        const key = `${categoryId}-${dasher.id}`;
                        updatedCollapsed[key] = true;
                    });
                    setCollapsedDashers(updatedCollapsed);
                    setTimeout(() => saveAllToLocalStorage(), 100);
                }
            };

            // Expand/Collapse all stores in a specific category
            const expandAllStoresInCategory = (categoryId) => {
                const category = categories.find(c => c.id === categoryId);
                if (category) {
                    const updatedCollapsed = { ...collapsedStores };
                    category.stores.forEach(store => {
                        const key = `${categoryId}-${store.id}`;
                        updatedCollapsed[key] = false;
                    });
                    setCollapsedStores(updatedCollapsed);
                    setTimeout(() => saveAllToLocalStorage(), 100);
                }
            };

            const collapseAllStoresInCategory = (categoryId) => {
                const category = categories.find(c => c.id === categoryId);
                if (category) {
                    const updatedCollapsed = { ...collapsedStores };
                    category.stores.forEach(store => {
                        const key = `${categoryId}-${store.id}`;
                        updatedCollapsed[key] = true;
                    });
                    setCollapsedStores(updatedCollapsed);
                    setTimeout(() => saveAllToLocalStorage(), 100);
                }
            };

            const handleDasherDragStart = (e, categoryId, dasherIndex) => {
                setDraggedDasher({ categoryId, dasherIndex });
                e.dataTransfer.effectAllowed = 'move';
            };

            const handleDasherDragEnd = () => {
                setDraggedDasher({ categoryId: '', dasherIndex: -1 });
                // Force a small delay to ensure state is fully reset
                setTimeout(() => {
                    setDraggedDasher({ categoryId: '', dasherIndex: -1 });
                }, 50);
            };

            const handleDasherDragOver = (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            };

            const handleDasherDrop = (e, targetCategoryId, targetDasherIndex) => {
                e.preventDefault();
                e.stopPropagation();

                if (!draggedDasher.categoryId || draggedDasher.dasherIndex === -1) {
                    setDraggedDasher({ categoryId: '', dasherIndex: -1 });
                    return;
                }

                const sourceCategoryId = draggedDasher.categoryId;
                const sourceDasherIndex = draggedDasher.dasherIndex;

                // Move dasher between or within categories
                const sourceCategory = dasherCategories.find(cat => cat.id === sourceCategoryId);
                const targetCategory = dasherCategories.find(cat => cat.id === targetCategoryId);

                if (!sourceCategory || !targetCategory) {
                    setDraggedDasher({ categoryId: '', dasherIndex: -1 });
                    return;
                }

                // Safety check: ensure dashers array exists
                if (!Array.isArray(sourceCategory.dashers) || !Array.isArray(targetCategory.dashers)) {
                    setDraggedDasher({ categoryId: '', dasherIndex: -1 });
                    return;
                }

                const dasherToMove = sourceCategory.dashers[sourceDasherIndex];
                if (!dasherToMove) {
                    setDraggedDasher({ categoryId: '', dasherIndex: -1 });
                    return;
                }

                if (sourceCategoryId === targetCategoryId) {
                    // Reordering within the same category
                    if (sourceDasherIndex !== targetDasherIndex) {
                        const newDashers = [...sourceCategory.dashers];
                        newDashers.splice(sourceDasherIndex, 1);
                        newDashers.splice(targetDasherIndex, 0, dasherToMove);

                        setDasherCategories(dasherCategories.map(cat =>
                            cat.id === targetCategoryId ? { ...cat, dashers: newDashers } : cat
                        ));

                        // Auto-save
                        setTimeout(() => {
                            saveAllToLocalStorage();
                        }, 100);
                    }
                } else {
                    // Moving between categories
                    setDasherCategories(dasherCategories.map(cat => {
                        if (cat.id === sourceCategoryId) {
                            // Remove from source
                            return { ...cat, dashers: cat.dashers.filter((_, idx) => idx !== sourceDasherIndex) };
                        } else if (cat.id === targetCategoryId) {
                            // Add to target at specific position
                            const newDashers = [...cat.dashers];
                            newDashers.splice(targetDasherIndex, 0, dasherToMove);
                            return { ...cat, dashers: newDashers };
                        }
                        return cat;
                    }));

                    // Auto-save
                    setTimeout(() => {
                        saveAllToLocalStorage();
                    }, 100);
                }

                setDraggedDasher({ categoryId: '', dasherIndex: -1 });
            };

            const targetAmount = parseFloat(target) || 0;

            return (
                <div className="min-h-screen text-white">
                    {/* Copy Notification */}
                    {copyNotification && (
                        <div className="fixed top-4 right-4 z-50 bg-green-900/90 border border-green-600/50 text-green-100 px-4 py-2 rounded-lg shadow-lg backdrop-blur-sm animate-pulse">
                            {copyNotification}
                        </div>
                    )}

                    {/* Save Notification - Beautiful Toast */}
                    {saveNotification && (
                        <div className="fixed top-20 right-6 z-50 transform transition-all duration-300 ease-out animate-in slide-in-from-right">
                            <div className="bg-gradient-to-r from-emerald-500 to-teal-600 text-white px-6 py-3 rounded-xl shadow-2xl backdrop-blur-sm flex items-center gap-3 border border-white/20">
                                <div className="flex-shrink-0">
                                    {saveNotification.includes('✅') && (
                                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                    )}
                                    {saveNotification.includes('❌') && (
                                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                    )}
                                    {saveNotification.includes('⚠️') && (
                                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                        </svg>
                                    )}
                                </div>
                                <div className="flex-1">
                                    <p className="font-medium">{saveNotification}</p>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Import Notification */}
                    {importNotification && (
                        <div className="fixed top-28 right-4 z-50 bg-purple-900/90 border border-purple-600/50 text-purple-100 px-4 py-2 rounded-lg shadow-lg backdrop-blur-sm animate-pulse">
                            {importNotification}
                        </div>
                    )}

                    <div className="max-w-[1240px] mx-auto">
                        {/* Header with time - Compact Japanese Style */}
                        <div className="text-center mb-3">
                            <h1 className="text-3xl md:text-4xl font-bold gradient-header mb-0.5">
                                Dash Bash Utility
                            </h1>
                            <div className="flex items-center justify-center gap-1.5 text-gray-500 text-xs">
                                <Clock size={12} />
                                <span className="opacity-70">
                                    {currentTime.toLocaleDateString([], { weekday: 'short', month: 'short', day: 'numeric' })} • {currentTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                </span>
                                <span className="opacity-50">• v1.5.0</span>
                            </div>
                        </div>

                        <div className="space-y-4">
                            {/* Target Calculator Section */}
                            <div className="bg-gray-800 rounded-lg overflow-hidden">
                                <button
                                    onClick={() => setIsCalculatorOpen(!isCalculatorOpen)}
                                    className="w-full flex items-center justify-between p-4 text-left hover:bg-gray-700/50 transition-colors"
                                >
                                    <div className="flex items-center gap-3">
                                        <Calculator size={20} className="text-blue-400" />
                                        <span className="text-lg font-medium">Target Calculator</span>
                                    </div>
                                    {isCalculatorOpen ? <ChevronUp size={20} /> : <ChevronDown size={20} />}
                                </button>

                                {isCalculatorOpen && (
                                    <div className="border-t border-gray-700 p-4">
                                        {/* Target Amount Selector */}
                                        <div className="mb-4">
                                            <label className="block text-sm font-medium mb-2">Target Amount ($)</label>
                                            <div className="flex gap-2 mb-2">
                                                <button
                                                    onClick={() => handleTargetPresetChange('99')}
                                                    className={`flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-colors ${
                                                        targetPreset === '99'
                                                            ? 'bg-blue-600 text-white'
                                                            : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                                                    }`}
                                                >
                                                    $99
                                                </button>
                                                <button
                                                    onClick={() => handleTargetPresetChange('120')}
                                                    className={`flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-colors ${
                                                        targetPreset === '120'
                                                            ? 'bg-blue-600 text-white'
                                                            : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                                                    }`}
                                                >
                                                    $120
                                                </button>
                                                <button
                                                    onClick={() => handleTargetPresetChange('custom')}
                                                    className={`flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-1 ${
                                                        targetPreset === 'custom'
                                                            ? 'bg-blue-600 text-white'
                                                            : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                                                    }`}
                                                >
                                                    <Edit2 size={14} />
                                                    Custom
                                                </button>
                                            </div>

                                            {/* Custom Target Input */}
                                            {isEditingTarget && (
                                                <div className="flex gap-2">
                                                    <input
                                                        type="number"
                                                        step="0.01"
                                                        value={customTarget}
                                                        onChange={(e) => setCustomTarget(e.target.value)}
                                                        onKeyPress={handleTargetKeyPress}
                                                        className="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-base font-mono focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                        placeholder="Enter custom amount"
                                                        autoFocus
                                                    />
                                                    <button
                                                        onClick={handleCustomTargetSave}
                                                        className="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg transition-colors flex items-center gap-1"
                                                    >
                                                        Set
                                                    </button>
                                                </div>
                                            )}

                                            {/* Current Target Display */}
                                            {!isEditingTarget && targetPreset === 'custom' && (
                                                <div className="text-sm text-gray-400 mt-1">
                                                    Current: ${target}
                                                </div>
                                            )}
                                        </div>

                                        {/* Price Input */}
                                        <div className="mb-4">
                                            <label className="block text-sm font-medium mb-2">Add Product Price ($) <span className="text-gray-400 text-xs">(Enter to add quickly)</span></label>
                                            <div className="flex gap-2">
                                                <input
                                                    ref={priceInputRef}
                                                    type="number"
                                                    step="0.01"
                                                    value={currentPrice}
                                                    onChange={(e) => setCurrentPrice(e.target.value)}
                                                    onKeyPress={handleKeyPress}
                                                    className="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-base font-mono focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                    placeholder="2.75"
                                                />
                                                <button
                                                    onClick={addPrice}
                                                    className="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg transition-colors flex items-center gap-2"
                                                >
                                                    <Plus size={16} />
                                                    Add
                                                </button>
                                            </div>
                                        </div>

                                        {/* Results */}
                                        {prices.length > 0 && (() => {
                                            const allOptions = prices.map((price, index) => {
                                                const calc = calculateQuantities(price, targetAmount);
                                                const bestOption = findBestOption(calc.validOptions);
                                                return { index, price, bestOption, validOptions: calc.validOptions };
                                            }).filter(item => item.bestOption);

                                            const globalBest = allOptions.reduce((best, current) =>
                                                current.bestOption.difference < best.bestOption.difference ? current : best
                                            , allOptions[0]);

                                            return (
                                                <div>
                                                    <div className="flex justify-between items-center mb-3">
                                                        <h3 className="text-sm font-medium text-gray-400">Results ({prices.length} item{prices.length !== 1 ? 's' : ''})</h3>
                                                        <button
                                                            onClick={clearAll}
                                                            className="text-red-400 hover:text-red-300 text-xs px-3 py-1 rounded border border-red-600/30 hover:border-red-500/50 transition-colors"
                                                        >
                                                            Clear All
                                                        </button>
                                                    </div>

                                                    <div className="space-y-2">
                                                        {allOptions.map(({ index, price, bestOption }) => {
                                                            const isGlobalBest = globalBest && bestOption.difference === globalBest.bestOption.difference;
                                                            const diffRatio = targetAmount > 0 ? Math.min(bestOption.difference / targetAmount, 0.8) : 0;

                                                            let bgColor = 'bg-gray-800';
                                                            let borderColor = 'border-transparent';
                                                            let underColor = 'text-gray-400';

                                                            if (isGlobalBest) {
                                                                bgColor = 'bg-green-900/40';
                                                                borderColor = 'border-green-500/50';
                                                                underColor = 'text-green-400';
                                                            } else if (diffRatio < 0.05) {
                                                                bgColor = 'bg-lime-900/30';
                                                                borderColor = 'border-lime-600/40';
                                                                underColor = 'text-lime-400';
                                                            } else if (diffRatio < 0.15) {
                                                                bgColor = 'bg-yellow-900/30';
                                                                borderColor = 'border-yellow-600/40';
                                                                underColor = 'text-yellow-400';
                                                            } else if (diffRatio < 0.3) {
                                                                bgColor = 'bg-amber-900/30';
                                                                borderColor = 'border-amber-600/40';
                                                                underColor = 'text-amber-400';
                                                            } else if (diffRatio < 0.5) {
                                                                bgColor = 'bg-orange-900/30';
                                                                borderColor = 'border-orange-600/40';
                                                                underColor = 'text-orange-400';
                                                            } else {
                                                                bgColor = 'bg-red-900/30';
                                                                borderColor = 'border-red-600/40';
                                                                underColor = 'text-red-400';
                                                            }

                                                            return (
                                                                <div key={index} className={`${bgColor} border ${borderColor} rounded-lg p-3 flex justify-between items-center transition-colors`}>
                                                                    <div className="flex-1">
                                                                        <span className="font-medium text-base tracking-tight">${price.toFixed(2)} per item</span>
                                                                    </div>
                                                                    <div className="flex-1 text-right mr-3">
                                                                        <div className="font-semibold text-base leading-tight">{bestOption.quantity} items</div>
                                                                        <div className="text-xs text-gray-300 leading-tight">
                                                                            ${bestOption.total.toFixed(2)} • <span className={`font-medium ${underColor}`}>-${bestOption.difference.toFixed(2)}</span>
                                                                            {isGlobalBest && <span className="text-green-400 ml-1">✓</span>}
                                                                        </div>
                                                                    </div>
                                                                    <div>
                                                                        <button
                                                                            onClick={() => removePrice(index)}
                                                                            className="text-gray-500 hover:text-red-400 p-1 transition-colors"
                                                                        >
                                                                            <Trash2 size={14} />
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            );
                                                        })}

                                                        {prices.map((price, index) => {
                                                            const calc = calculateQuantities(price, targetAmount);
                                                            if (calc.validOptions.length > 0) return null;

                                                            return (
                                                                <div key={`expensive-${index}`} className="bg-red-900/20 border border-red-600/30 rounded-lg p-3 flex justify-between items-center">
                                                                    <span className="font-medium text-base">${price.toFixed(2)} per item</span>
                                                                    <div className="flex items-center gap-3">
                                                                        <span className="text-red-400 text-xs">Too expensive</span>
                                                                        <button
                                                                            onClick={() => removePrice(index)}
                                                                            className="text-red-400 hover:text-red-300 p-1"
                                                                        >
                                                                            <Trash2 size={14} />
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                </div>
                                            );
                                        })()}

                                        {prices.length === 0 && (
                                            <div className="text-center text-gray-400 py-6">
                                                <div className="text-sm">Add product prices to see calculations</div>
                                                <div className="text-xs mt-1">Focus is on the price input - just start typing!</div>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>

                            {/* Quick Messages Section */}
                            <div className="bg-gray-800 rounded-lg overflow-hidden">
                                <button
                                    onClick={() => setIsMessagesOpen(!isMessagesOpen)}
                                    className="w-full flex items-center justify-between p-4 text-left hover:bg-gray-700/50 transition-colors"
                                >
                                    <div className="flex items-center gap-3">
                                        <MessageSquare size={20} className="text-green-400" />
                                        <span className="text-lg font-medium">Quick Copy Messages ({messages.length})</span>
                                    </div>
                                    {isMessagesOpen ? <ChevronUp size={20} /> : <ChevronDown size={20} />}
                                </button>

                                {isMessagesOpen && (
                                    <div className="border-t border-gray-700 p-4 space-y-2">
                                        {messages.map((message, index) => (
                                            <div
                                                key={index}
                                                className={`bg-gray-700/60 hover:bg-gray-700 rounded-lg p-2 transition-colors border border-gray-600/30 ${
                                                    draggedIndex === index ? 'opacity-50 bg-gray-600' : ''
                                                }`}
                                                draggable
                                                onDragStart={(e) => handleDragStart(e, index)}
                                                onDragOver={handleDragOver}
                                                onDrop={(e) => handleDrop(e, index)}
                                            >
                                                <div className="flex items-center gap-2">
                                                    <button className="text-gray-500 hover:text-gray-400 cursor-move p-1">
                                                        <GripVertical size={18} />
                                                    </button>

                                                    <div className="flex-1 min-w-0">
                                                        {editingIndex === index ? (
                                                            <textarea
                                                                value={editText}
                                                                onChange={(e) => setEditText(e.target.value)}
                                                                className="w-full bg-gray-600 border border-gray-500 rounded px-2 py-1 text-base text-white resize-y min-h-[3rem] focus:outline-none focus:ring-1 focus:ring-blue-500"
                                                                rows={Math.max(1, editText.split('\n').length)}
                                                                autoFocus
                                                            />
                                                        ) : (
                                                            <div
                                                                className="text-base text-gray-100 leading-relaxed whitespace-pre-wrap break-words cursor-pointer hover:text-blue-300 transition-colors"
                                                                onClick={() => copyToClipboard(message)}
                                                                title="Click to copy"
                                                            >
                                                                {message}
                                                            </div>
                                                        )}
                                                    </div>

                                                    <div className="flex items-center gap-0.5 flex-shrink-0">
                                                        {editingIndex === index ? (
                                                            <>
                                                                <button onClick={saveEdit} className="text-green-400 hover:text-green-300 p-1" title="Done">
                                                                    ✓
                                                                </button>
                                                                <button onClick={cancelEdit} className="text-gray-400 hover:text-gray-300 p-1" title="Cancel">
                                                                    <X size={12} />
                                                                </button>
                                                            </>
                                                        ) : (
                                                            <>
                                                                <button onClick={() => startEdit(index)} className="text-yellow-400 hover:text-yellow-300 p-1" title="Edit">
                                                                    <Edit2 size={12} />
                                                                </button>
                                                                <button onClick={() => deleteMessage(index)} className="text-red-400 hover:text-red-300 p-1" title="Delete">
                                                                    <Trash2 size={12} />
                                                                </button>
                                                            </>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                        ))}

                                        {isAddingNew ? (
                                            <div className="bg-gray-700/60 rounded-lg p-2 border border-gray-600/30 border-dashed">
                                                <div className="flex items-start gap-2">
                                                    <div className="w-4" />
                                                    <textarea
                                                        value={newMessageText}
                                                        onChange={(e) => setNewMessageText(e.target.value)}
                                                        className="flex-1 bg-gray-600 border border-gray-500 rounded px-2 py-1 text-base text-white resize-y min-h-[3rem] focus:outline-none focus:ring-1 focus:ring-blue-500"
                                                        rows={2}
                                                        autoFocus
                                                        placeholder="Enter your new message..."
                                                    />
                                                    <div className="flex gap-0.5">
                                                        <button onClick={addNewMessage} className="text-green-400 hover:text-green-300 p-1" title="Add">
                                                            ✓
                                                        </button>
                                                        <button onClick={cancelAddNew} className="text-gray-400 hover:text-gray-300 p-1" title="Cancel">
                                                            <X size={12} />
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        ) : (
                                            <button
                                                onClick={() => setIsAddingNew(true)}
                                                className="w-full bg-gray-700/40 hover:bg-gray-700/60 border border-dashed border-gray-600 rounded-lg p-2 text-xs text-gray-300 hover:text-white transition-colors flex items-center justify-center gap-1"
                                            >
                                                <Plus size={12} />
                                                Add New Message
                                            </button>
                                        )}
                                    </div>
                                )}
                            </div>

                            {/* Address Book Section */}
                            <div className="bg-gray-800 rounded-lg overflow-hidden">
                                <button
                                    onClick={() => setIsAddressBookOpen(!isAddressBookOpen)}
                                    className="w-full flex items-center justify-between p-4 text-left hover:bg-gray-700/50 transition-colors"
                                >
                                    <div className="flex items-center gap-3">
                                        <Building2 size={20} className="text-orange-400" />
                                        <span className="text-lg font-medium">Store Address Book ({categories.reduce((total, cat) => total + cat.stores.length, 0)} locations)</span>
                                        {/* Category Expand/Collapse Chevrons */}
                                        <div
                                            className="flex items-center gap-1 ml-2"
                                            onClick={(e) => e.stopPropagation()}
                                            style={{
                                                opacity: isAddressBookOpen && categories.length > 0 ? 1 : 0,
                                                pointerEvents: isAddressBookOpen && categories.length > 0 ? 'auto' : 'none',
                                                transition: 'opacity 200ms'
                                            }}
                                        >
                                            <button
                                                onClick={(e) => {
                                                    e.stopPropagation();
                                                    collapseAllCategories();
                                                }}
                                                className="text-orange-400 hover:text-orange-300 p-1 hover:bg-gray-600/50 rounded transition-colors"
                                                title="Collapse all categories"
                                            >
                                                <ChevronUp size={16} />
                                            </button>
                                            <button
                                                onClick={(e) => {
                                                    e.stopPropagation();
                                                    expandAllCategories();
                                                }}
                                                className="text-orange-400 hover:text-orange-300 p-1 hover:bg-gray-600/50 rounded transition-colors"
                                                title="Expand all categories"
                                            >
                                                <ChevronDown size={16} />
                                            </button>
                                        </div>
                                    </div>
                                    {isAddressBookOpen ? <ChevronUp size={20} /> : <ChevronDown size={20} />}
                                </button>

                                {isAddressBookOpen && (
                                    <div className="border-t border-gray-700 p-4 space-y-3">
                                        {categories.map((category) => {
                                            const { openCount, closedCount } = getStoresStatusCount(category.stores);
                                            const isCategoryCollapsed = collapsedCategories[category.id];

                                            return (
                                                <div key={category.id} className="bg-gray-700/40 rounded-lg overflow-hidden border border-gray-600/30">
                                                    {/* Category Header */}
                                                    <div className="flex items-center justify-between p-3 hover:bg-gray-700/60 transition-colors">
                                                        <button
                                                            onClick={() => toggleCategoryCollapse(category.id)}
                                                            className="flex items-center gap-2 flex-1 text-left"
                                                        >
                                                            {isCategoryCollapsed ? <ChevronDown size={16} /> : <ChevronUp size={16} />}
                                                            {editingCategory === category.id ? (
                                                                <input
                                                                    type="text"
                                                                    value={category.name}
                                                                    onChange={(e) => updateCategory(category.id, e.target.value)}
                                                                    className="bg-gray-600 border border-gray-500 rounded px-2 py-1 text-sm text-white focus:outline-none focus:ring-1 focus:ring-blue-500"
                                                                    onBlur={() => setEditingCategory(-1)}
                                                                    onKeyPress={(e) => e.key === 'Enter' && setEditingCategory(-1)}
                                                                    onClick={(e) => e.stopPropagation()}
                                                                    autoFocus
                                                                />
                                                            ) : (
                                                                <h4 className="font-medium text-blue-300 flex items-center gap-2">
                                                                    <MapPin size={14} />
                                                                    {category.name} ({category.stores.length})
                                                                    {category.stores.length > 0 && (
                                                                        <span className="text-xs text-gray-400 ml-2">
                                                                            {openCount > 0 && <span className="text-green-400">{openCount} open</span>}
                                                                            {openCount > 0 && closedCount > 0 && <span className="text-gray-500"> • </span>}
                                                                            {closedCount > 0 && <span className="text-red-400">{closedCount} closed</span>}
                                                                        </span>
                                                                    )}
                                                                </h4>
                                                            )}
                                                        </button>

                                                        <div className="flex items-center gap-1">
                                                            {/* Always-reserved chevron group to prevent layout shift */}
                                                            <div className="flex items-center gap-1 w-[66px] justify-end">
                                                                <button
                                                                    onClick={(e) => {
                                                                        e.stopPropagation();
                                                                        collapseAllStoresInCategory(category.id);
                                                                    }}
                                                                    className="p-1 transition-colors text-amber-400 hover:text-amber-300 disabled:opacity-30 disabled:cursor-default"
                                                                    title="Collapse all stores in this category"
                                                                    disabled={category.stores.length === 0}
                                                                >
                                                                    <ChevronsUp size={14} />
                                                                </button>
                                                                <button
                                                                    onClick={(e) => {
                                                                        e.stopPropagation();
                                                                        expandAllStoresInCategory(category.id);
                                                                    }}
                                                                    className="p-1 transition-colors text-amber-400 hover:text-amber-300 disabled:opacity-30 disabled:cursor-default"
                                                                    title="Expand all stores in this category"
                                                                    disabled={category.stores.length === 0}
                                                                >
                                                                    <ChevronsDown size={14} />
                                                                </button>
                                                            </div>
                                                            <div className="w-px h-4 bg-gray-600 mx-1" />
                                                            <button
                                                                onClick={() => addStore(category.id)}
                                                                className="text-green-400 hover:text-green-300 p-1"
                                                                title="Add store"
                                                            >
                                                                <Plus size={14} />
                                                            </button>
                                                            <button
                                                                onClick={() => setEditingCategory(category.id)}
                                                                className="text-yellow-400 hover:text-yellow-300 p-1"
                                                                title="Edit category"
                                                            >
                                                                <Edit2 size={14} />
                                                            </button>
                                                            <button
                                                                onClick={() => deleteCategory(category.id)}
                                                                className="text-red-400 hover:text-red-300 p-1"
                                                                title="Delete category"
                                                            >
                                                                <Trash2 size={14} />
                                                            </button>
                                                        </div>
                                                    </div>

                                                    {/* Stores */}
                                                    {!isCategoryCollapsed && (
                                                        <div className="border-t border-gray-600/30 p-3 space-y-2">
                                                            {category.stores.map((store, storeIndex) => {
                                                                const cityState = extractCityState(store.address);
                                                                const timeStatus = calculateTimeStatus(store.closeTime);
                                                                const isEditing = isStoreEditing(category.id, store.id);
                                                                const isCollapsed = isStoreCollapsed(category.id, store.id);

                                                                return (
                                                                    <div
                                                                        key={store.id}
                                                                        className={`bg-gray-600/50 rounded-lg overflow-hidden border border-gray-500/30 transition-opacity ${
                                                                            draggedStore.categoryId === category.id && draggedStore.storeIndex === storeIndex ? 'opacity-50' : ''
                                                                        }`}
                                                                        draggable={!isEditing}
                                                                        onDragStart={(e) => { if (!isEditing) handleStoreDragStart(e, category.id, storeIndex); }}
                                                                        onDragOver={handleStoreDragOver}
                                                                        onDrop={(e) => handleStoreDrop(e, category.id, storeIndex)}
                                                                    >
                                                                        {/* Store Header */}
                                                                        <div className="flex items-center justify-between p-3 hover:bg-gray-600/70 transition-colors">
                                                                            <div className="flex items-center gap-2 flex-1">
                                                                                {!isEditing && (
                                                                                    <button
                                                                                        className="text-gray-400 hover:text-gray-300 cursor-move"
                                                                                        aria-label="Drag to reorder"
                                                                                    >
                                                                                        <GripVertical size={14} />
                                                                                    </button>
                                                                                )}
                                                                                <button
                                                                                    onClick={() => toggleStoreCollapse(category.id, store.id)}
                                                                                    className="flex items-center gap-2 flex-1 text-left"
                                                                                >
                                                                                    {isCollapsed ? <ChevronDown size={14} /> : <ChevronUp size={14} />}
                                                                                    <div className="flex-1">
                                                                                        {cityState ? (
                                                                                            <h5 className="font-medium text-green-300 text-sm flex items-center gap-2">
                                                                                                {cityState}
                                                                                                {timeStatus && (
                                                                                                    <span className={`text-xs ${timeStatus.color}`}>
                                                                                                        ({timeStatus.status === 'open' ? 'Open' : 'Closed'})
                                                                                                    </span>
                                                                                                )}
                                                                                            </h5>
                                                                                        ) : (
                                                                                            <h5 className="font-medium text-gray-400 text-sm italic">New Store</h5>
                                                                                        )}
                                                                                    </div>
                                                                                </button>
                                                                            </div>
                                                                            <div className="flex items-center gap-1">
                                                                                <button
                                                                                    onClick={() => toggleEditStore(category.id, store.id)}
                                                                                    className={`p-1 transition-colors ${
                                                                                        isEditing
                                                                                            ? 'text-green-400 hover:text-green-300'
                                                                                            : 'text-yellow-400 hover:text-yellow-300'
                                                                                    }`}
                                                                                    title={isEditing ? 'Save changes' : 'Edit store'}
                                                                                >
                                                                                    {isEditing ? <Check size={14} /> : <Edit2 size={14} />}
                                                                                </button>
                                                                                <button
                                                                                    onClick={() => deleteStore(category.id, store.id)}
                                                                                    className="text-red-400 hover:text-red-300 p-1"
                                                                                    title="Delete store"
                                                                                >
                                                                                    <Trash2 size={14} />
                                                                                </button>
                                                                            </div>
                                                                        </div>

                                                                        {/* Store Details */}
                                                                        {!isCollapsed && (
                                                                            <div className="border-t border-gray-500/30 p-3 space-y-2">
                                                                                {/* Address */}
                                                                                <div className="flex items-start gap-2">
                                                                                    <label className="text-xs text-gray-400 w-16 mt-1 flex-shrink-0">Address:</label>
                                                                                    {isEditing ? (
                                                                                        <input
                                                                                            type="text"
                                                                                            value={store.address}
                                                                                            onChange={(e) => updateStore(category.id, store.id, 'address', e.target.value)}
                                                                                            className="flex-1 bg-gray-700 border border-gray-600 rounded px-2 py-0.5 text-xs text-white focus:outline-none focus:ring-1 focus:ring-blue-500"
                                                                                            placeholder="Enter address..."
                                                                                        />
                                                                                    ) : (
                                                                                        <div className="flex-1 text-xs text-gray-200 mt-1">
                                                                                            {store.address || <span className="italic text-gray-500">No address entered</span>}
                                                                                        </div>
                                                                                    )}
                                                                                    <button
                                                                                        onClick={(e) => {
                                                                                            e.stopPropagation();
                                                                                            copyToClipboard(store.address);
                                                                                        }}
                                                                                        className="text-blue-400 hover:text-blue-300 p-1"
                                                                                        title="Copy address"
                                                                                        disabled={!store.address}
                                                                                    >
                                                                                        <Copy size={12} />
                                                                                    </button>
                                                                                </div>

                                                                                {/* Times */}
                                                                                <div className="grid grid-cols-2 gap-2">
                                                                                    <div className="flex items-center gap-2">
                                                                                        <label className="text-xs text-gray-400 w-12">Open:</label>
                                                                                        {isEditing ? (
                                                                                            <input
                                                                                                type="text"
                                                                                                value={store.openTime}
                                                                                                onChange={(e) => updateStore(category.id, store.id, 'openTime', e.target.value)}
                                                                                                className="flex-1 bg-gray-700 border border-gray-600 rounded px-2 py-0.5 text-xs text-white font-mono focus:outline-none focus:ring-1 focus:ring-blue-500"
                                                                                                placeholder="0800"
                                                                                                maxLength={4}
                                                                                            />
                                                                                        ) : (
                                                                                            <div className="flex-1 text-xs text-gray-200 font-mono">
                                                                                                {formatTime(store.openTime) || <span className="italic text-gray-500">Not set</span>}
                                                                                            </div>
                                                                                        )}
                                                                                    </div>
                                                                                    <div className="flex items-center gap-2">
                                                                                        <label className="text-xs text-gray-400 w-12">Close:</label>
                                                                                        {isEditing ? (
                                                                                            <input
                                                                                                type="text"
                                                                                                value={store.closeTime}
                                                                                                onChange={(e) => updateStore(category.id, store.id, 'closeTime', e.target.value)}
                                                                                                className="flex-1 bg-gray-700 border border-gray-600 rounded px-2 py-0.5 text-xs text-white font-mono focus:outline-none focus:ring-1 focus:ring-blue-500"
                                                                                                placeholder="2100"
                                                                                                maxLength={4}
                                                                                            />
                                                                                        ) : (
                                                                                            <div className="flex-1 text-xs text-gray-200 font-mono">
                                                                                                {formatTime(store.closeTime) || <span className="italic text-gray-500">Not set</span>}
                                                                                            </div>
                                                                                        )}
                                                                                    </div>
                                                                                </div>

                                                                                {/* Notes */}
                                                                                <div className="flex items-start gap-2">
                                                                                    <label className="text-xs text-gray-400 w-16 mt-1 flex-shrink-0">Notes:</label>
                                                                                    {isEditing ? (
                                                                                        <textarea
                                                                                            value={store.notes}
                                                                                            onChange={(e) => updateStore(category.id, store.id, 'notes', e.target.value)}
                                                                                            className="flex-1 bg-gray-700 border border-gray-600 rounded px-2 py-0.5 text-xs text-white resize-y min-h-[2rem] focus:outline-none focus:ring-1 focus:ring-blue-500"
                                                                                            rows={1}
                                                                                            placeholder="Any notes..."
                                                                                        />
                                                                                    ) : (
                                                                                        <div className="flex-1 text-xs text-gray-200 mt-1">
                                                                                            {store.notes || <span className="italic text-gray-500">No notes</span>}
                                                                                        </div>
                                                                                    )}
                                                                                </div>
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                );
                                                            })}

                                                            {category.stores.length === 0 && (
                                                                <div className="text-center text-gray-500 py-2 text-xs">
                                                                    No stores yet. Click + to add one.
                                                                </div>
                                                            )}
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}

                                        {/* Add New Category */}
                                        {isAddingCategory ? (
                                            <div className="bg-gray-700/40 rounded-lg p-3 border border-gray-600/30 border-dashed">
                                                <div className="flex items-center gap-2">
                                                    <input
                                                        type="text"
                                                        value={newCategoryName}
                                                        onChange={(e) => setNewCategoryName(e.target.value)}
                                                        className="flex-1 bg-gray-600 border border-gray-500 rounded px-2 py-1 text-sm text-white focus:outline-none focus:ring-1 focus:ring-blue-500"
                                                        placeholder="Category name (e.g., Walgreens)"
                                                        autoFocus
                                                    />
                                                    <button onClick={addCategory} className="text-green-400 hover:text-green-300 p-1" title="Add">
                                                        ✓
                                                    </button>
                                                    <button onClick={() => { setIsAddingCategory(false); setNewCategoryName(''); }} className="text-gray-400 hover:text-gray-300 p-1" title="Cancel">
                                                        <X size={14} />
                                                    </button>
                                                </div>
                                            </div>
                                        ) : (
                                            <button
                                                onClick={() => setIsAddingCategory(true)}
                                                className="w-full bg-gray-700/40 hover:bg-gray-700/60 border border-dashed border-gray-600 rounded-lg p-3 text-sm text-gray-300 hover:text-white transition-colors flex items-center justify-center gap-2"
                                            >
                                                <Plus size={14} />
                                                Add New Store Category
                                            </button>
                                        )}

                                        {categories.length === 0 && !isAddingCategory && (
                                            <div className="text-center text-gray-500 py-6 text-sm">
                                                No store categories yet
                                            </div>
                                        )}

                                    </div>
                                )}
                            </div>

                            {/* Notes Section */}
                            <div className="bg-gray-800 rounded-lg overflow-hidden">
                                <button
                                    onClick={() => setIsNotesOpen(!isNotesOpen)}
                                    className="w-full flex items-center justify-between p-4 text-left hover:bg-gray-700/50 transition-colors"
                                >
                                    <div className="flex items-center gap-3">
                                        <FileText size={20} className="text-purple-400" />
                                        <span className="text-lg font-medium">
                                            Notes ({noteCategories.reduce((total, cat) => total + cat.notes.length, 0)} items)
                                        </span>
                                        {/* Category Expand/Collapse Chevrons */}
                                        <div
                                            className="flex items-center gap-1 ml-2"
                                            onClick={(e) => e.stopPropagation()}
                                            style={{
                                                opacity: isNotesOpen && noteCategories.length > 0 ? 1 : 0,
                                                pointerEvents: isNotesOpen && noteCategories.length > 0 ? 'auto' : 'none',
                                                transition: 'opacity 200ms'
                                            }}
                                        >
                                            <button
                                                onClick={(e) => {
                                                    e.stopPropagation();
                                                    collapseAllNoteCategories();
                                                }}
                                                className="text-purple-400 hover:text-purple-300 p-1 hover:bg-gray-600/50 rounded transition-colors"
                                                title="Collapse all categories"
                                            >
                                                <ChevronUp size={16} />
                                            </button>
                                            <button
                                                onClick={(e) => {
                                                    e.stopPropagation();
                                                    expandAllNoteCategories();
                                                }}
                                                className="text-purple-400 hover:text-purple-300 p-1 hover:bg-gray-600/50 rounded transition-colors"
                                                title="Expand all categories"
                                            >
                                                <ChevronDown size={16} />
                                            </button>
                                        </div>
                                    </div>
                                    {isNotesOpen ? <ChevronUp size={20} /> : <ChevronDown size={20} />}
                                </button>

                                {isNotesOpen && (
                                    <div className="border-t border-gray-700 p-4">
                                        <div className="mb-3 text-center">
                                            <p className="text-xs text-gray-400">Organize your notes by category</p>
                                        </div>

                                        <div className="space-y-3">
                                            {noteCategories.map((category) => {
                                                const isCategoryCollapsed = collapsedNoteCategories[category.id];

                                                return (
                                                    <div
                                                        key={category.id}
                                                        className="bg-gray-700/40 rounded-lg overflow-hidden border border-gray-600/30"
                                                        onDragOver={handleNoteDragOver}
                                                        onDrop={(e) => handleNoteDrop(e, category.id)}
                                                    >
                                                        {/* Category Header */}
                                                        <div className="flex items-center justify-between p-3 hover:bg-gray-700/60 transition-colors">
                                                            <button
                                                                onClick={() => toggleNoteCategoryCollapse(category.id)}
                                                                className="flex items-center gap-2 flex-1 text-left"
                                                            >
                                                                {isCategoryCollapsed ? <ChevronDown size={16} /> : <ChevronUp size={16} />}
                                                                {editingNoteCategory === category.id ? (
                                                                    <input
                                                                        type="text"
                                                                        value={category.name}
                                                                        onChange={(e) => updateNoteCategory(category.id, e.target.value)}
                                                                        className="bg-gray-600 border border-gray-500 rounded px-2 py-1 text-sm text-white focus:outline-none focus:ring-1 focus:ring-purple-500"
                                                                        onBlur={() => setEditingNoteCategory(-1)}
                                                                        onKeyPress={(e) => e.key === 'Enter' && setEditingNoteCategory(-1)}
                                                                        onClick={(e) => e.stopPropagation()}
                                                                        autoFocus
                                                                    />
                                                                ) : (
                                                                    <h4 className="font-medium text-purple-300 flex items-center gap-2">
                                                                        <FileText size={14} />
                                                                        {category.name} ({category.notes.length})
                                                                    </h4>
                                                                )}
                                                            </button>

                                                            <div className="flex items-center gap-1">
                                                                <button
                                                                    onClick={() => addNote(category.id)}
                                                                    className="text-green-400 hover:text-green-300 p-1"
                                                                    title="Add note"
                                                                >
                                                                    <Plus size={14} />
                                                                </button>
                                                                <button
                                                                    onClick={(e) => {
                                                                        e.stopPropagation();
                                                                        setEditingNoteCategory(category.id);
                                                                    }}
                                                                    className="text-yellow-400 hover:text-yellow-300 p-1"
                                                                    title="Rename category"
                                                                >
                                                                    <Edit2 size={14} />
                                                                </button>
                                                                <button
                                                                    onClick={() => deleteNoteCategory(category.id)}
                                                                    className="text-red-400 hover:text-red-300 p-1"
                                                                    title="Delete category"
                                                                >
                                                                    <Trash2 size={14} />
                                                                </button>
                                                            </div>
                                                        </div>

                                                        {/* Notes */}
                                                        {!isCategoryCollapsed && (
                                                            <div className="border-t border-gray-600/30 p-3 space-y-2">
                                                                {category.notes.map((note, noteIndex) => {
                                                                    const isEditing = isNoteEditing(category.id, noteIndex);

                                                                    return (
                                                                        <div
                                                                            key={noteIndex}
                                                                            className={`bg-gray-600/50 rounded-lg p-2 transition-opacity ${
                                                                                draggedNote.categoryId === category.id && draggedNote.noteIndex === noteIndex ? 'opacity-50' : ''
                                                                            }`}
                                                                            draggable={!isEditing}
                                                                            onDragStart={(e) => { if (!isEditing) handleNoteDragStart(e, category.id, noteIndex); }}
                                                                        >
                                                                            <div className="flex items-start gap-2">
                                                                                {!isEditing && (
                                                                                    <button
                                                                                        className="text-gray-400 hover:text-gray-300 cursor-move mt-1"
                                                                                        aria-label="Drag to reorder"
                                                                                    >
                                                                                        <GripVertical size={14} />
                                                                                    </button>
                                                                                )}

                                                                                <div className="flex-1">
                                                                                    {isEditing ? (
                                                                                        <textarea
                                                                                            value={note}
                                                                                            onChange={(e) => updateNote(category.id, noteIndex, e.target.value)}
                                                                                            className="w-full bg-gray-700 border border-gray-600 rounded px-2 py-0.5 text-sm text-white resize-y min-h-[4rem] focus:outline-none focus:ring-1 focus:ring-blue-500"
                                                                                            rows={3}
                                                                                            autoFocus
                                                                                            placeholder="Enter your note..."
                                                                                        />
                                                                                    ) : (
                                                                                        <div className="text-sm text-gray-100 whitespace-pre-wrap">
                                                                                            {note || <span className="italic text-gray-500">Empty note - click edit to add content</span>}
                                                                                        </div>
                                                                                    )}
                                                                                </div>

                                                                                <div className="flex items-start gap-1 mt-1">
                                                                                    {!isEditing && (
                                                                                        <button
                                                                                            onClick={(e) => {
                                                                                                e.stopPropagation();
                                                                                                copyToClipboard(note);
                                                                                            }}
                                                                                            className="text-blue-400 hover:text-blue-300 p-1"
                                                                                            title="Copy note"
                                                                                            disabled={!note}
                                                                                        >
                                                                                            <Copy size={14} />
                                                                                        </button>
                                                                                    )}
                                                                                    <button
                                                                                        onClick={() => toggleNoteEdit(category.id, noteIndex)}
                                                                                        className={`p-1 transition-colors ${
                                                                                            isEditing
                                                                                                ? 'text-green-400 hover:text-green-300'
                                                                                                : 'text-yellow-400 hover:text-yellow-300'
                                                                                        }`}
                                                                                        title={isEditing ? 'Save' : 'Edit'}
                                                                                    >
                                                                                        {isEditing ? <Check size={14} /> : <Edit2 size={14} />}
                                                                                    </button>
                                                                                    <button
                                                                                        onClick={() => deleteNote(category.id, noteIndex)}
                                                                                        className="text-red-400 hover:text-red-300 p-1"
                                                                                        title="Delete"
                                                                                    >
                                                                                        <Trash2 size={14} />
                                                                                    </button>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    );
                                                                })}

                                                                {category.notes.length === 0 && (
                                                                    <div className="text-center text-gray-500 py-2 text-xs">
                                                                        No notes yet. Click + to add one.
                                                                    </div>
                                                                )}
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                        </div>

                                        {/* Add Category Button */}
                                        <button
                                            onClick={addNoteCategory}
                                            className="w-full mt-3 bg-gray-700/40 hover:bg-gray-700/60 border border-dashed border-gray-600 rounded-lg p-3 text-sm text-gray-300 hover:text-white transition-colors flex items-center justify-center gap-2"
                                        >
                                            <Plus size={14} />
                                            Add New Category
                                        </button>

                                    </div>
                                )}
                            </div>

                            {/* ========== DELIVERY MANAGEMENT SECTION ========== */}
                            <div className="flex items-center gap-3 my-8">
                                <div className="flex-1 h-px bg-gradient-to-r from-transparent via-gray-700 to-transparent opacity-50"></div>
                                <span className="text-xs uppercase tracking-wider text-gray-500 font-medium">Delivery Management</span>
                                <div className="flex-1 h-px bg-gradient-to-r from-transparent via-gray-700 to-transparent opacity-50"></div>
                            </div>

                            {/* Dashers Section */}
                            <div className="bg-gray-800 rounded-lg overflow-hidden">
                                <button
                                    onClick={() => setIsDashersOpen(!isDashersOpen)}
                                    className="w-full flex items-center justify-between p-4 text-left hover:bg-gray-700/50 transition-colors"
                                >
                                    <div className="flex items-center gap-3">
                                        <Users size={20} className="text-indigo-400" />
                                        <span className="text-lg font-medium">
                                            {(() => {
                                                const total = dasherCategories.flatMap(c => c.dashers).length;
                                                return `Dashers ${total > 0 ? `(${total})` : ''}`;
                                            })()}
                                        </span>
                                        {/* Category Expand/Collapse Chevrons */}
                                        <div
                                            className="flex items-center gap-1 ml-2"
                                            onClick={(e) => e.stopPropagation()}
                                            style={{
                                                opacity: isDashersOpen && dasherCategories.length > 0 ? 1 : 0,
                                                pointerEvents: isDashersOpen && dasherCategories.length > 0 ? 'auto' : 'none',
                                                transition: 'opacity 200ms'
                                            }}
                                        >
                                            <button
                                                onClick={(e) => {
                                                    e.stopPropagation();
                                                    collapseAllDasherCategories();
                                                }}
                                                className="text-indigo-400 hover:text-indigo-300 p-1 hover:bg-gray-600/50 rounded transition-colors"
                                                title="Collapse all categories"
                                            >
                                                <ChevronUp size={16} />
                                            </button>
                                            <button
                                                onClick={(e) => {
                                                    e.stopPropagation();
                                                    expandAllDasherCategories();
                                                }}
                                                className="text-indigo-400 hover:text-indigo-300 p-1 hover:bg-gray-600/50 rounded transition-colors"
                                                title="Expand all categories"
                                            >
                                                <ChevronDown size={16} />
                                            </button>
                                        </div>
                                    </div>
                                    {isDashersOpen ? <ChevronUp size={20} /> : <ChevronDown size={20} />}
                                </button>

                                {isDashersOpen && (
                                    <div className="border-t border-gray-700 p-4 space-y-3">
                                        {dasherCategories && dasherCategories.length > 0 && dasherCategories.map((category) => {
                                            if (!category || !category.dashers) return null;
                                            const isCategoryCollapsed = collapsedDasherCategories[category.id];

                                            return (
                                                <div
                                                    key={category.id}
                                                    className="bg-gray-700/40 rounded-lg overflow-hidden border border-gray-600/30"
                                                >
                                                    {/* Category Header */}
                                                    <div className="flex items-center justify-between p-3 hover:bg-gray-700/60 transition-colors">
                                                        <div className="flex items-center gap-2">
                                                            {/* Category selection checkbox (only visible in edit mode) */}
                                                            {isEditMode && (
                                                                <input
                                                                    type="checkbox"
                                                                    checked={selectedItems.dasherCategories.has(category.id) ||
                                                                             (category.dashers && category.dashers.length > 0 && category.dashers.every(d => selectedItems.dashers.has(d.id)))}
                                                                    onChange={(e) => {
                                                                        e.stopPropagation();
                                                                        toggleCategorySelection('dashers', category.id, category.dashers.map(d => d.id));
                                                                    }}
                                                                    onClick={(e) => e.stopPropagation()}
                                                                    className="w-4 h-4 text-blue-600 bg-gray-700 border-gray-500 rounded focus:ring-blue-500 focus:ring-2"
                                                                />
                                                            )}
                                                            <button
                                                                onClick={() => toggleDasherCategoryCollapse(category.id)}
                                                                className="flex items-center gap-2 text-left flex-1"
                                                            >
                                                                {isCategoryCollapsed ? <ChevronDown size={16} /> : <ChevronUp size={16} />}
                                                                {editingDasherCategory === category.id ? (
                                                                    <input
                                                                        type="text"
                                                                        value={category.name}
                                                                        onChange={(e) => updateDasherCategory(category.id, e.target.value)}
                                                                        className="bg-gray-600 border border-gray-500 rounded px-2 py-1 text-sm text-white focus:outline-none focus:ring-1 focus:ring-indigo-500"
                                                                        onBlur={() => setEditingDasherCategory(-1)}
                                                                        onKeyPress={(e) => e.key === 'Enter' && setEditingDasherCategory(-1)}
                                                                        onClick={(e) => e.stopPropagation()}
                                                                        autoFocus
                                                                    />
                                                                ) : (
                                                                    <h4 className="font-medium text-indigo-300 flex items-center gap-2">
                                                                        <Users size={14} />
                                                                        {category.name} ({category.dashers.length})
                                                                    </h4>
                                                                )}
                                                            </button>
                                                        </div>

                                                        <div className="flex items-center gap-1">
                                                            {/* Always-reserved chevron group to prevent layout shift */}
                                                            <div className="flex items-center gap-1 w-[66px] justify-end">
                                                                <button
                                                                    onClick={(e) => {
                                                                        e.stopPropagation();
                                                                        collapseAllDashersInCategory(category.id);
                                                                    }}
                                                                    className="p-1 transition-colors text-indigo-400 hover:text-indigo-300 disabled:opacity-30 disabled:cursor-default"
                                                                    title="Collapse all dashers in this category"
                                                                    disabled={category.dashers.length === 0}
                                                                >
                                                                    <ChevronsUp size={14} />
                                                                </button>
                                                                <button
                                                                    onClick={(e) => {
                                                                        e.stopPropagation();
                                                                        expandAllDashersInCategory(category.id);
                                                                    }}
                                                                    className="p-1 transition-colors text-indigo-400 hover:text-indigo-300 disabled:opacity-30 disabled:cursor-default"
                                                                    title="Expand all dashers in this category"
                                                                    disabled={category.dashers.length === 0}
                                                                >
                                                                    <ChevronsDown size={14} />
                                                                </button>
                                                            </div>
                                                            <div className="w-px h-4 bg-gray-600 mx-1" />
                                                            <button
                                                                onClick={() => addDasher(category.id)}
                                                                className="text-green-400 hover:text-green-300 p-1"
                                                                title="Add dasher"
                                                            >
                                                                <Plus size={14} />
                                                            </button>
                                                            <button
                                                                onClick={(e) => {
                                                                    e.stopPropagation();
                                                                    setEditingDasherCategory(category.id);
                                                                }}
                                                                className="text-yellow-400 hover:text-yellow-300 p-1"
                                                                title="Rename category"
                                                            >
                                                                <Edit2 size={14} />
                                                            </button>
                                                            <button
                                                                onClick={() => deleteDasherCategory(category.id)}
                                                                className="text-red-400 hover:text-red-300 p-1"
                                                                title="Delete category"
                                                            >
                                                                <Trash2 size={14} />
                                                            </button>
                                                        </div>
                                                    </div>

                                                    {/* Dashers */}
                                                    {!isCategoryCollapsed && (
                                                        <div
                                                            className="border-t border-gray-600/30 p-3 space-y-2 min-h-[50px]"
                                                            onDragOver={(e) => {
                                                                e.preventDefault();
                                                                e.dataTransfer.dropEffect = 'move';
                                                            }}
                                                            onDrop={(e) => {
                                                                e.preventDefault();
                                                                if (category.dashers.length === 0) {
                                                                    handleDasherDrop(e, category.id, 0);
                                                                }
                                                            }}
                                                        >
                                                            {category.dashers.map((dasher, dasherIndex) => {
                                                                const isEditing = isDasherEditing(category.id, dasher.id);
                                                                const isCollapsed = isDasherCollapsed(category.id, dasher.id);
                                                                // Re-calculate on timerTick changes
                                                                const timeStatus = calculateDasherTimeStatus(dasher.lastUsed);
                                                                const dasherTitle = getDasherTitle(dasher);

                                                                return (
                                                                    <div
                                                                        key={dasher.id}
                                                                        className={`bg-gray-600/50 rounded-lg overflow-hidden border border-gray-500/30 transition-opacity ${
                                                                            dasher.deactivated ? 'dasher-card--deactivated' : ''
                                                                        } ${
                                                                            dasher.ready ? 'dasher-card--ready' : ''
                                                                        } ${
                                                                            dasher.appealed ? 'dasher-card--appealed' : ''
                                                                        } ${
                                                                            draggedDasher.categoryId === category.id && draggedDasher.dasherIndex === dasherIndex ? 'opacity-50' : ''
                                                                        }`}
                                                                        draggable={!isEditing}
                                                                        onDragStart={(e) => { if (!isEditing) handleDasherDragStart(e, category.id, dasherIndex); }}
                                                                        onDragEnd={handleDasherDragEnd}
                                                                        onDragOver={(e) => {
                                                                            e.preventDefault();
                                                                            e.stopPropagation();
                                                                        }}
                                                                        onDrop={(e) => {
                                                                            e.stopPropagation();
                                                                            handleDasherDrop(e, category.id, dasherIndex);
                                                                        }}
                                                                    >
                                                                        {/* Dasher Header */}
                                                                        <div className="flex items-center justify-between p-3">
                                                                            <div className="flex items-center gap-2 flex-1">
                                                                                {/* Checkbox for selection (only visible in edit mode) */}
                                                                                {isEditMode && (
                                                                                    <input
                                                                                        type="checkbox"
                                                                                        checked={selectedItems.dashers.has(dasher.id)}
                                                                                        onChange={(e) => {
                                                                                            e.stopPropagation();
                                                                                            toggleItemSelection('dashers', dasher.id);
                                                                                        }}
                                                                                        onClick={(e) => e.stopPropagation()}
                                                                                        className="w-4 h-4 text-blue-600 bg-gray-700 border-gray-500 rounded focus:ring-blue-500 focus:ring-2"
                                                                                    />
                                                                                )}
                                                                                <div
                                                                                    className={`${isEditing ? 'text-gray-700 cursor-not-allowed' : 'text-gray-400 hover:text-gray-300 cursor-move'}`}
                                                                                    aria-label="Drag to reorder"
                                                                                    style={{ pointerEvents: isEditing ? 'none' : 'auto' }}
                                                                                >
                                                                                    <GripVertical size={14} />
                                                                                </div>
                                                                                <button
                                                                                    onClick={() => toggleDasherCollapse(category.id, dasher.id)}
                                                                                    className="flex items-center gap-2 flex-1 text-left"
                                                                                >
                                                                                    {isCollapsed ? <ChevronDown size={14} /> : <ChevronUp size={14} />}
                                                                                    <div className="flex-1">
                                                                                        <h5 className="font-medium text-purple-300 text-sm flex items-center gap-2">
                                                                                            {dasherTitle}
                                                                                            {/* Status Badges */}
                                                                                            <span className="flag-badges" aria-label="Dasher status flags (Crimson, Red Card, Appealed)">
                                                                                                <span
                                                                                                    className="flag-badge"
                                                                                                    data-flag="C"
                                                                                                    data-active={dasher.crimson ? 'true' : 'false'}
                                                                                                    title={dasher.crimson ? (dasher.crimsonAt ? `Crimson since ${new Date(dasher.crimsonAt).toLocaleString()}` : 'Crimson active') : 'Crimson inactive'}
                                                                                                >CRIMSON</span>
                                                                                                <span
                                                                                                    className="flag-badge"
                                                                                                    data-flag="RC"
                                                                                                    data-active={dasher.redCard ? 'true' : 'false'}
                                                                                                    title={dasher.redCard ? (dasher.redCardAt ? `Red Card since ${new Date(dasher.redCardAt).toLocaleString()}` : 'Red Card active') : 'Red Card inactive'}
                                                                                                >RED CARD</span>
                                                                                                <span
                                                                                                    className="flag-badge"
                                                                                                    data-flag="AP"
                                                                                                    data-active={dasher.appealed ? 'true' : 'false'}
                                                                                                    title={dasher.appealed ? (dasher.appealedAt ? `Appealed since ${new Date(dasher.appealedAt).toLocaleString()}` : 'Appealed active') : 'Appealed inactive'}
                                                                                                >APPEALED</span>
                                                                                            </span>
                                                                                            {dasher.lastUsed && (
                                                                                                <button
                                                                                                    onClick={(e) => {
                                                                                                        e.stopPropagation();
                                                                                                        resetDasherTimer(category.id, dasher.id);
                                                                                                    }}
                                                                                                    className="text-orange-400 hover:text-orange-300 p-0.5"
                                                                                                    title="Reset timer"
                                                                                                >
                                                                                                    <TimerOff size={12} />
                                                                                                </button>
                                                                                            )}
                                                                                        </h5>
                                                                                    </div>
                                                                                </button>
                                                                            </div>
                                                                            <div className="flex items-center gap-2">
                                                                                {/* Category Movement Group */}
                                                                                <div className="flex items-center gap-1 pr-2 border-r border-gray-600">
                                                                                    <button
                                                                                        onClick={() => moveDasherToReady(category.id, dasher.id)}
                                                                                        className="icon-btn text-green-400 hover:text-green-300"
                                                                                        title="Move to Ready"
                                                                                    >
                                                                                        <CircleCheck size={14} />
                                                                                    </button>
                                                                                    <button
                                                                                        onClick={() => moveDasherToCurrentlyUsing(category.id, dasher.id)}
                                                                                        className="icon-btn text-blue-400 hover:text-blue-300"
                                                                                        title="Move to Currently Using"
                                                                                    >
                                                                                        <Activity size={14} />
                                                                                    </button>
                                                                                    <button
                                                                                        onClick={() => moveDasherToAppealed(category.id, dasher.id)}
                                                                                        className="icon-btn text-amber-400 hover:text-amber-300"
                                                                                        title="Move to Appealed"
                                                                                    >
                                                                                        <CircleCheck size={14} />
                                                                                    </button>
                                                                                </div>
                                                                                
                                                                                {/* Control Buttons Group */}
                                                                                <div className="flex items-center gap-1">
                                                                                    <button
                                                                                        onClick={() => startDasherTimer(category.id, dasher.id)}
                                                                                        className="icon-btn text-purple-400 hover:text-purple-300"
                                                                                        title="Start 24hr timer"
                                                                                    >
                                                                                        <Timer size={14} />
                                                                                    </button>
                                                                                    <button
                                                                                        onClick={() => toggleEditDasher(category.id, dasher.id)}
                                                                                        className={`icon-btn transition-colors ${
                                                                                            isEditing
                                                                                                ? 'text-green-400 hover:text-green-300'
                                                                                                : 'text-yellow-400 hover:text-yellow-300'
                                                                                        }`}
                                                                                        title={isEditing ? 'Save' : 'Edit'}
                                                                                    >
                                                                                        {isEditing ? <Check size={14} /> : <Edit2 size={14} />}
                                                                                    </button>
                                                                                    {category.id === 'deactivated' ? (
                                                                                        <button
                                                                                            onClick={() => reactivateDasher(dasher.id)}
                                                                                            className="icon-btn text-green-400 hover:text-green-300"
                                                                                            title="Reactivate"
                                                                                        >
                                                                                            <UserCheck size={14} />
                                                                                        </button>
                                                                                    ) : (
                                                                                        <button
                                                                                            onClick={() => deactivateDasher(category.id, dasher.id)}
                                                                                            className="icon-btn text-orange-400 hover:text-orange-300"
                                                                                            title="Deactivate"
                                                                                        >
                                                                                            <UserX size={14} />
                                                                                        </button>
                                                                                    )}
                                                                                    <button
                                                                                        onClick={() => archiveDasher(category.id, dasher.id)}
                                                                                        className="icon-btn text-amber-400 hover:text-amber-300"
                                                                                        title="Archive"
                                                                                    >
                                                                                        <Archive size={14} />
                                                                                    </button>
                                                                                    <button
                                                                                        onClick={() => deleteDasher(category.id, dasher.id)}
                                                                                        className="icon-btn text-red-400 hover:text-red-300"
                                                                                        title="Delete"
                                                                                    >
                                                                                        <Trash2 size={14} />
                                                                                    </button>
                                                                                </div>
                                                                            </div>
                                                                        </div>

                                                                        {/* Dasher Details */}
                                                                        {!isCollapsed && (
                                                                            <div className="space-y-2 p-3 pt-0 border-t border-gray-600/30">
                                                                            {/* Name */}
                                                                            <div className="flex items-center gap-2">
                                                                                <label className="text-xs text-gray-400 w-20">Name:</label>
                                                                                {isEditing ? (
                                                                                    <input
                                                                                        type="text"
                                                                                        value={dasher.name}
                                                                                        onChange={(e) => updateDasher(category.id, dasher.id, 'name', e.target.value)}
                                                                                        className="flex-1 bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs text-white focus:outline-none focus:ring-1 focus:ring-blue-500"
                                                                                        placeholder="Enter name..."
                                                                                    />
                                                                                ) : (
                                                                                    <>
                                                                                        <div className="flex-1 text-xs text-gray-200">
                                                                                            {dasher.name || <span className="italic text-gray-500">No name</span>}
                                                                                        </div>
                                                                                        {dasher.name && (
                                                                                            <button
                                                                                                onClick={() => copyToClipboard(dasher.name)}
                                                                                                className="text-blue-400 hover:text-blue-300 p-1"
                                                                                                title="Copy name"
                                                                                            >
                                                                                                <Copy size={12} />
                                                                                            </button>
                                                                                        )}
                                                                                    </>
                                                                                )}
                                                                            </div>

                                                                            {/* Email */}
                                                                            <div className="flex items-center gap-2">
                                                                                <label className="text-xs text-gray-400 w-20">Email:</label>
                                                                                {isEditing ? (
                                                                                    <input
                                                                                        type="email"
                                                                                        value={dasher.email}
                                                                                        onChange={(e) => updateDasher(category.id, dasher.id, 'email', e.target.value)}
                                                                                        className="flex-1 bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs text-white focus:outline-none focus:ring-1 focus:ring-blue-500"
                                                                                        placeholder="Enter email..."
                                                                                    />
                                                                                ) : (
                                                                                    <>
                                                                                        <div className="flex-1 text-xs text-gray-200">
                                                                                            {dasher.email || <span className="italic text-gray-500">No email</span>}
                                                                                        </div>
                                                                                        {dasher.email && (
                                                                                            <button
                                                                                                onClick={() => copyToClipboard(dasher.email)}
                                                                                                className="text-blue-400 hover:text-blue-300 p-1"
                                                                                                title="Copy email"
                                                                                            >
                                                                                                <Copy size={12} />
                                                                                            </button>
                                                                                        )}
                                                                                    </>
                                                                                )}
                                                                            </div>

                                                                            {/* Email Password */}
                                                                            <div className="flex items-center gap-2">
                                                                                <label className="text-xs text-gray-400 w-20">Email pw:</label>
                                                                                {isEditing ? (
                                                                                    <input
                                                                                        type="text"
                                                                                        value={dasher.emailPw || ''}
                                                                                        onChange={(e) => updateDasher(category.id, dasher.id, 'emailPw', e.target.value)}
                                                                                        className="flex-1 bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs text-white focus:outline-none focus:ring-1 focus:ring-blue-500"
                                                                                        placeholder="Enter email password..."
                                                                                    />
                                                                                ) : (
                                                                                    <>
                                                                                        <div className="flex-1 text-xs text-gray-200">
                                                                                            {dasher.emailPw ? '••••••••' : <span className="italic text-gray-500">No password</span>}
                                                                                        </div>
                                                                                        {dasher.emailPw && (
                                                                                            <button
                                                                                                onClick={() => copyToClipboard(dasher.emailPw)}
                                                                                                className="text-blue-400 hover:text-blue-300 p-1"
                                                                                                title="Copy email password"
                                                                                            >
                                                                                                <Copy size={12} />
                                                                                            </button>
                                                                                        )}
                                                                                    </>
                                                                                )}
                                                                            </div>

                                                                            {/* Dasher Password */}
                                                                            <div className="flex items-center gap-2">
                                                                                <label className="text-xs text-gray-400 w-20">Dasher pw:</label>
                                                                                {isEditing ? (
                                                                                    <input
                                                                                        type="text"
                                                                                        value={dasher.dasherPw || ''}
                                                                                        onChange={(e) => updateDasher(category.id, dasher.id, 'dasherPw', e.target.value)}
                                                                                        className="flex-1 bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs text-white focus:outline-none focus:ring-1 focus:ring-blue-500"
                                                                                        placeholder="Enter dasher password..."
                                                                                    />
                                                                                ) : (
                                                                                    <>
                                                                                        <div className="flex-1 text-xs text-gray-200">
                                                                                            {dasher.dasherPw ? '••••••••' : <span className="italic text-gray-500">No password</span>}
                                                                                        </div>
                                                                                        {dasher.dasherPw && (
                                                                                            <button
                                                                                                onClick={() => copyToClipboard(dasher.dasherPw)}
                                                                                                className="text-blue-400 hover:text-blue-300 p-1"
                                                                                                title="Copy dasher password"
                                                                                            >
                                                                                                <Copy size={12} />
                                                                                            </button>
                                                                                        )}
                                                                                    </>
                                                                                )}
                                                                            </div>

                                                                            {/* Phone */}
                                                                            <div className="flex items-center gap-2">
                                                                                <label className="text-xs text-gray-400 w-20">Phone:</label>
                                                                                {isEditing ? (
                                                                                    <input
                                                                                        type="tel"
                                                                                        value={dasher.phone || ''}
                                                                                        onChange={(e) => updateDasher(category.id, dasher.id, 'phone', e.target.value)}
                                                                                        className="flex-1 bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs text-white focus:outline-none focus:ring-1 focus:ring-blue-500"
                                                                                        placeholder="Enter phone number..."
                                                                                    />
                                                                                ) : (
                                                                                    <>
                                                                                        <div className="flex-1 text-xs text-gray-200">
                                                                                            {dasher.phone || <span className="italic text-gray-500">No phone</span>}
                                                                                        </div>
                                                                                        {dasher.phone && (
                                                                                            <button
                                                                                                onClick={() => copyToClipboard(dasher.phone)}
                                                                                                className="text-blue-400 hover:text-blue-300 p-1"
                                                                                                title="Copy phone"
                                                                                            >
                                                                                                <Copy size={12} />
                                                                                            </button>
                                                                                        )}
                                                                                    </>
                                                                                )}
                                                                            </div>

                                                                            {/* Balance */}
                                                                            <div className="flex items-center gap-2">
                                                                                <label className="text-xs text-gray-400 w-20">Balance:</label>
                                                                                {isEditing ? (
                                                                                    <input
                                                                                        type="text"
                                                                                        value={dasher.balance || ''}
                                                                                        onChange={(e) => updateDasher(category.id, dasher.id, 'balance', e.target.value)}
                                                                                        className="flex-1 bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs text-white focus:outline-none focus:ring-1 focus:ring-blue-500"
                                                                                        placeholder="Enter balance..."
                                                                                    />
                                                                                ) : (
                                                                                    <>
                                                                                        <div className="flex-1 text-xs text-gray-200">
                                                                                            {dasher.balance || <span className="italic text-gray-500">No balance</span>}
                                                                                        </div>
                                                                                        {dasher.balance && (
                                                                                            <button
                                                                                                onClick={() => copyToClipboard(dasher.balance)}
                                                                                                className="text-blue-400 hover:text-blue-300 p-1"
                                                                                                title="Copy balance"
                                                                                            >
                                                                                                <Copy size={12} />
                                                                                            </button>
                                                                                        )}
                                                                                    </>
                                                                                )}
                                                                            </div>

                                                                            {/* Crimson Checkbox */}
                                                                            <div className="flex items-center gap-2">
                                                                                <label className="text-xs text-gray-400 w-20">Crimson:</label>
                                                                                <input
                                                                                    type="checkbox"
                                                                                    checked={dasher.crimson || false}
                                                                                    onChange={(e) => updateDasher(category.id, dasher.id, 'crimson', e.target.checked)}
                                                                                    disabled={!isEditing}
                                                                                    className="h-3 w-3 text-purple-500 bg-gray-700 border-gray-600 rounded focus:ring-purple-500 focus:ring-1 disabled:opacity-50"
                                                                                />
                                                                                <span className="text-xs text-gray-400">{dasher.crimson ? 'Yes' : 'No'}</span>
                                                                            </div>

                                                                            {/* Red Card Checkbox */}
                                                                            <div className="flex items-center gap-2">
                                                                                <label className="text-xs text-gray-400 w-20">Red card:</label>
                                                                                <input
                                                                                    type="checkbox"
                                                                                    checked={dasher.redCard || false}
                                                                                    onChange={(e) => updateDasher(category.id, dasher.id, 'redCard', e.target.checked)}
                                                                                    disabled={!isEditing}
                                                                                    className="h-3 w-3 text-red-500 bg-gray-700 border-gray-600 rounded focus:ring-red-500 focus:ring-1 disabled:opacity-50"
                                                                                />
                                                                                <span className="text-xs text-gray-400">{dasher.redCard ? 'Yes' : 'No'}</span>
                                                                            </div>

                                                                            {/* Appealed Checkbox */}
                                                                            <div className="flex items-center gap-2">
                                                                                <label className="text-xs text-gray-400 w-20">Appealed:</label>
                                                                                <input
                                                                                    type="checkbox"
                                                                                    checked={dasher.appealed || false}
                                                                                    onChange={(e) => updateDasher(category.id, dasher.id, 'appealed', e.target.checked)}
                                                                                    disabled={!isEditing}
                                                                                    className="h-3 w-3 text-yellow-500 bg-gray-700 border-gray-600 rounded focus:ring-yellow-500 focus:ring-1 disabled:opacity-50"
                                                                                />
                                                                                <span className="text-xs text-gray-400">{dasher.appealed ? 'Yes' : 'No'}</span>
                                                                            </div>

                                                                            {/* Appealed Timer */}
                                                                            {dasher.appealed && dasher.appealedAt && (
                                                                                <div className="flex items-center gap-2">
                                                                                    <label className="text-xs text-gray-400 w-20">Appealed at:</label>
                                                                                    <div className="flex-1 text-xs">
                                                                                        {(() => {
                                                                                            const appealedStatus = calculateAppealedTimeStatus(dasher.appealedAt);
                                                                                            return appealedStatus ? (
                                                                                                <span className="flex items-center gap-1">
                                                                                                    <span className={appealedStatus.color} title={appealedStatus.fullDate}>
                                                                                                        {appealedStatus.text}
                                                                                                    </span>
                                                                                                    <button
                                                                                                        onClick={() => resetAppealedTimer(category.id, dasher.id)}
                                                                                                        className="text-purple-400 hover:text-purple-300 p-0.5"
                                                                                                        title="Reset appealed timer"
                                                                                                        disabled={!isEditing}
                                                                                                    >
                                                                                                        <TimerOff size={12} />
                                                                                                    </button>
                                                                                                </span>
                                                                                            ) : (
                                                                                                <span className="text-gray-400">Not tracked</span>
                                                                                            );
                                                                                        })()}
                                                                                    </div>
                                                                                </div>
                                                                            )}

                                                                            {/* Last Used Timer */}
                                                                            <div className="flex items-center gap-2">
                                                                                <label className="text-xs text-gray-400 w-20">Last used:</label>
                                                                                <div className="flex-1 text-xs">
                                                                                    {timeStatus ? (
                                                                                        <div>
                                                                                            <span className={`font-mono ${timeStatus.color}`}>
                                                                                                {timeStatus.text}
                                                                                            </span>
                                                                                            <div className="text-gray-500 text-[10px] mt-1">
                                                                                                {timeStatus.fullDateTime}
                                                                                            </div>
                                                                                        </div>
                                                                                    ) : (
                                                                                        <span className="italic text-gray-500">Timer not started</span>
                                                                                    )}
                                                                                </div>
                                                                            </div>

                                                                            {/* Notes - Expandable */}
                                                                            <div className="flex items-start gap-2">
                                                                                <label className="text-xs text-gray-400 w-20 mt-1">Notes:</label>
                                                                                {isEditing ? (
                                                                                    <textarea
                                                                                        value={dasher.notes || ''}
                                                                                        onChange={(e) => updateDasher(category.id, dasher.id, 'notes', e.target.value)}
                                                                                        className="flex-1 bg-gray-700 border border-gray-600 rounded px-2 py-0.5 text-xs text-white resize-y min-h-[2.5rem] focus:outline-none focus:ring-1 focus:ring-blue-500"
                                                                                        rows={2}
                                                                                        placeholder="Any notes..."
                                                                                        style={{ minHeight: '2.5rem' }}
                                                                                    />
                                                                                ) : (
                                                                                    <>
                                                                                        <div className="flex-1 text-xs text-gray-200 whitespace-pre-wrap">
                                                                                            {dasher.notes || <span className="italic text-gray-500">No notes</span>}
                                                                                        </div>
                                                                                        {dasher.notes && (
                                                                                            <button
                                                                                                onClick={() => copyToClipboard(dasher.notes)}
                                                                                                className="text-blue-400 hover:text-blue-300 p-1 self-start"
                                                                                                title="Copy notes"
                                                                                            >
                                                                                                <Copy size={12} />
                                                                                            </button>
                                                                                        )}
                                                                                    </>
                                                                                )}
                                                                            </div>
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                );
                                                            })}

                                                            {category.dashers.length === 0 && (
                                                                <div className="text-center text-gray-500 py-2 text-xs">
                                                                    No dashers in this category. Click + to add one.
                                                                </div>
                                                            )}
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}

                                        {/* Add New Category Button */}
                                        <button
                                            onClick={addDasherCategory}
                                            className="w-full bg-gray-700/40 hover:bg-gray-700/60 border border-dashed border-gray-600 rounded-lg p-3 text-sm text-gray-300 hover:text-white transition-colors flex items-center justify-center gap-2"
                                        >
                                            <Plus size={14} />
                                            Add New Category
                                        </button>
                                    </div>
                                )}
                            </div>

                            {/* Dashers - Ready Section */}
                            <div className="bg-gray-800 rounded-lg overflow-hidden mt-3">
                                <button
                                    onClick={() => setIsReadyDashersOpen(!isReadyDashersOpen)}
                                    className="w-full flex items-center justify-between p-4 text-left hover:bg-gray-700/50 transition-colors"
                                >
                                    <div className="flex items-center gap-3">
                                        <CircleCheck size={20} className="text-green-400" />
                                        <span className="text-lg font-medium">
                                            Dashers - Ready {readyDashers.length > 0 && `(${readyDashers.length})`}
                                        </span>
                                    </div>
                                    {isReadyDashersOpen ? <ChevronUp size={20} /> : <ChevronDown size={20} />}
                                </button>
                                {isReadyDashersOpen && (
                                    <div className="p-4 pt-2 space-y-2">
                                        {!readyDashers || readyDashers.length === 0 ? (
                                            <div className="text-center text-gray-500 py-8 text-sm italic">No ready dashers</div>
                                        ) : (
                                            readyDashers.map((dasher) => {
                                                const timeStatus = calculateDasherTimeStatus(dasher.lastUsed);
                                                const dasherTitle = getDasherTitle(dasher);
                                                const isCollapsed = collapsedDashers[dasher.id] || false;
                                                const isEditing = editingDasher.dasherId === dasher.id;

                                                return (
                                                    <div
                                                        key={dasher.id}
                                                        className="bg-gray-600/50 rounded-lg overflow-hidden border border-gray-500/30 dasher-card--ready"
                                                    >
                                                        {/* Dasher Header */}
                                                        <div className="flex items-center justify-between p-3">
                                                            <div className="flex items-center gap-2 flex-1">
                                                                <button
                                                                    onClick={() => {
                                                                        setCollapsedDashers({...collapsedDashers, [dasher.id]: !isCollapsed});
                                                                        setTimeout(saveAllToLocalStorage, 100);
                                                                    }}
                                                                    className="flex items-center gap-2 flex-1 text-left"
                                                                >
                                                                    {isCollapsed ? <ChevronDown size={14} /> : <ChevronUp size={14} />}
                                                                    <div className="flex-1">
                                                                        <h5 className="font-medium text-purple-300 text-sm flex items-center gap-2">
                                                                            {dasherTitle}
                                                                            {/* Status Badges */}
                                                                            <span className="flag-badges" aria-label="Dasher status flags">
                                                                                <span
                                                                                    className="flag-badge"
                                                                                    data-flag="C"
                                                                                    data-active={dasher.crimson ? 'true' : 'false'}
                                                                                    title={dasher.crimson ? (dasher.crimsonAt ? `Crimson since ${new Date(dasher.crimsonAt).toLocaleString()}` : 'Crimson active') : 'Crimson inactive'}
                                                                                >CRIMSON</span>
                                                                                <span
                                                                                    className="flag-badge"
                                                                                    data-flag="RC"
                                                                                    data-active={dasher.redCard ? 'true' : 'false'}
                                                                                    title={dasher.redCard ? (dasher.redCardAt ? `Red Card since ${new Date(dasher.redCardAt).toLocaleString()}` : 'Red Card active') : 'Red Card inactive'}
                                                                                >RED CARD</span>
                                                                                <span
                                                                                    className="flag-badge"
                                                                                    data-flag="AP"
                                                                                    data-active={dasher.appealed ? 'true' : 'false'}
                                                                                    title={dasher.appealed ? (dasher.appealedAt ? `Appealed since ${new Date(dasher.appealedAt).toLocaleString()}` : 'Appealed active') : 'Appealed inactive'}
                                                                                >APPEALED</span>
                                                                            </span>
                                                                            {dasher.lastUsed && (
                                                                                <button
                                                                                    onClick={(e) => {
                                                                                        e.stopPropagation();
                                                                                        const updated = readyDashers.map(d => d.id === dasher.id ? {...d, lastUsed: null} : d);
                                                                                        setReadyDashers(updated);
                                                                                        setTimeout(saveAllToLocalStorage, 100);
                                                                                    }}
                                                                                    className="text-orange-400 hover:text-orange-300 p-0.5"
                                                                                    title="Reset timer"
                                                                                >
                                                                                    <TimerOff size={12} />
                                                                                </button>
                                                                            )}
                                                                        </h5>
                                                                    </div>
                                                                </button>
                                                            </div>
                                                            <div className="flex items-center gap-2">
                                                                {/* Category Movement Group */}
                                                                <div className="flex items-center gap-1 pr-2 border-r border-gray-600">
                                                                    <button
                                                                        onClick={() => restoreDasherToMain(dasher.id, 'ready')}
                                                                        className="icon-btn text-blue-400 hover:text-blue-300"
                                                                        title="Return to Main"
                                                                    >
                                                                        <UserCheck size={14} />
                                                                    </button>
                                                                    <button
                                                                        onClick={() => {
                                                                            const updated = readyDashers.filter(d => d.id !== dasher.id);
                                                                            setReadyDashers(updated);
                                                                            const moved = {...dasher, currentlyUsing: true, currentlyUsingAt: new Date().toISOString()};
                                                                            delete moved.ready;
                                                                            delete moved.readyAt;
                                                                            setCurrentlyUsingDashers([moved, ...currentlyUsingDashers]);
                                                                            setTimeout(saveAllToLocalStorage, 100);
                                                                        }}
                                                                        className="icon-btn text-blue-400 hover:text-blue-300"
                                                                        title="Move to Using"
                                                                    >
                                                                        <Activity size={14} />
                                                                    </button>
                                                                    <button
                                                                        onClick={() => {
                                                                            const updated = readyDashers.filter(d => d.id !== dasher.id);
                                                                            setReadyDashers(updated);
                                                                            const moved = {...dasher, appealed: true, appealedAt: new Date().toISOString()};
                                                                            delete moved.ready;
                                                                            delete moved.readyAt;
                                                                            setAppealedDashers([moved, ...appealedDashers]);
                                                                            setTimeout(saveAllToLocalStorage, 100);
                                                                        }}
                                                                        className="icon-btn text-amber-400 hover:text-amber-300"
                                                                        title="Move to Appealed"
                                                                    >
                                                                        <CircleCheck size={14} />
                                                                    </button>
                                                                </div>

                                                                {/* Control Buttons Group */}
                                                                <div className="flex items-center gap-1">
                                                                    <button
                                                                        onClick={() => {
                                                                            const updated = readyDashers.map(d => d.id === dasher.id ? {...d, lastUsed: new Date().toISOString()} : d);
                                                                            setReadyDashers(updated);
                                                                            setTimeout(saveAllToLocalStorage, 100);
                                                                        }}
                                                                        className="icon-btn text-purple-400 hover:text-purple-300"
                                                                        title="Start Timer"
                                                                    >
                                                                        <Timer size={14} />
                                                                    </button>
                                                                    <button
                                                                        onClick={() => {
                                                                            const updated = readyDashers.filter(d => d.id !== dasher.id);
                                                                            setReadyDashers(updated);
                                                                            const moved = {...dasher, deactivated: true, deactivatedAt: new Date().toISOString()};
                                                                            delete moved.ready;
                                                                            delete moved.readyAt;
                                                                            setDeactivatedDashers([moved, ...deactivatedDashers]);
                                                                            setTimeout(saveAllToLocalStorage, 100);
                                                                        }}
                                                                        className="icon-btn text-red-400 hover:text-red-300"
                                                                        title="Deactivate"
                                                                    >
                                                                        <UserX size={14} />
                                                                    </button>
                                                                    <button
                                                                        onClick={() => {
                                                                            const updated = readyDashers.filter(d => d.id !== dasher.id);
                                                                            setReadyDashers(updated);
                                                                            const moved = {...dasher, archived: true, archivedAt: new Date().toISOString()};
                                                                            delete moved.ready;
                                                                            delete moved.readyAt;
                                                                            setArchivedDashers([moved, ...archivedDashers]);
                                                                            setTimeout(saveAllToLocalStorage, 100);
                                                                        }}
                                                                        className="icon-btn text-amber-400 hover:text-amber-300"
                                                                        title="Archive"
                                                                    >
                                                                        <Archive size={14} />
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        {/* Dasher Details (when expanded) */}
                                                        {!isCollapsed && (
                                                            <div className="border-t border-gray-500/30 p-3 space-y-2 text-xs">
                                                                {isEditing ? (
                                                                    <>
                                                                        <input
                                                                            type="text"
                                                                            value={editingDasher.name}
                                                                            onChange={(e) => setEditingDasher({...editingDasher, name: e.target.value})}
                                                                            className="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm"
                                                                            placeholder="Name"
                                                                        />
                                                                        <input
                                                                            type="email"
                                                                            value={editingDasher.email}
                                                                            onChange={(e) => setEditingDasher({...editingDasher, email: e.target.value})}
                                                                            className="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm"
                                                                            placeholder="Email"
                                                                        />
                                                                        <input
                                                                            type="number"
                                                                            step="0.01"
                                                                            value={editingDasher.balance}
                                                                            onChange={(e) => setEditingDasher({...editingDasher, balance: parseFloat(e.target.value) || 0})}
                                                                            className="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm"
                                                                            placeholder="Balance"
                                                                        />
                                                                        <textarea
                                                                            value={editingDasher.notes}
                                                                            onChange={(e) => setEditingDasher({...editingDasher, notes: e.target.value})}
                                                                            className="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm resize-y"
                                                                            placeholder="Notes"
                                                                            rows={2}
                                                                        />
                                                                        <button
                                                                            onClick={() => {
                                                                                const updated = readyDashers.map(d => d.id === dasher.id ? {...d, ...editingDasher} : d);
                                                                                setReadyDashers(updated);
                                                                                setEditingDasher({categoryId: null, dasherId: null, name: '', email: '', balance: 0, notes: ''});
                                                                                setTimeout(saveAllToLocalStorage, 100);
                                                                            }}
                                                                            className="w-full bg-green-600 hover:bg-green-700 text-white rounded px-3 py-1.5 text-sm flex items-center justify-center gap-2"
                                                                        >
                                                                            <Check size={14} /> Save Changes
                                                                        </button>
                                                                    </>
                                                                ) : (
                                                                    <>
                                                                        <div className="flex items-center justify-between">
                                                                            <span className="text-gray-400">Name:</span>
                                                                            <div className="flex items-center gap-1">
                                                                                <span className="text-purple-300">{dasher.name}</span>
                                                                                <button onClick={() => copyToClipboard(dasher.name)} className="copy-btn">
                                                                                    <Copy size={10} />
                                                                                </button>
                                                                            </div>
                                                                        </div>
                                                                        <div className="flex items-center justify-between">
                                                                            <span className="text-gray-400">Email:</span>
                                                                            <div className="flex items-center gap-1">
                                                                                <span className="text-blue-300">{dasher.email}</span>
                                                                                <button onClick={() => copyToClipboard(dasher.email)} className="copy-btn">
                                                                                    <Copy size={10} />
                                                                                </button>
                                                                            </div>
                                                                        </div>
                                                                        <div className="flex items-center justify-between">
                                                                            <span className="text-gray-400">Balance:</span>
                                                                            <div className="flex items-center gap-1">
                                                                                <span className={(Number(dasher.balance) || 0) === 0 ? 'text-green-400' : 'text-red-400'}>
                                                                                    ${(Number(dasher.balance) || 0).toFixed(2)}
                                                                                </span>
                                                                                <button onClick={() => copyToClipboard((Number(dasher.balance) || 0).toString())} className="copy-btn">
                                                                                    <Copy size={10} />
                                                                                </button>
                                                                            </div>
                                                                        </div>
                                                                        {dasher.lastUsed && (
                                                                            <div className="flex items-center justify-between">
                                                                                <span className="text-gray-400">Timer:</span>
                                                                                <span className={`font-mono ${timeStatus.color}`}>
                                                                                    {timeStatus.display}
                                                                                </span>
                                                                            </div>
                                                                        )}
                                                                        {dasher.notes && (
                                                                            <div className="pt-1">
                                                                                <div className="flex items-center justify-between mb-1">
                                                                                    <span className="text-gray-400">Notes:</span>
                                                                                    <button onClick={() => copyToClipboard(dasher.notes)} className="copy-btn">
                                                                                        <Copy size={10} />
                                                                                    </button>
                                                                                </div>
                                                                                <p className="text-gray-300 text-xs whitespace-pre-wrap bg-gray-700/30 rounded p-2">
                                                                                    {dasher.notes}
                                                                                </p>
                                                                            </div>
                                                                        )}
                                                                        <div className="flex items-center gap-3 pt-1">
                                                                            <label className="flex items-center gap-1.5 cursor-pointer text-red-400 hover:text-red-300">
                                                                                <input
                                                                                    type="checkbox"
                                                                                    checked={dasher.crimson || false}
                                                                                    onChange={(e) => {
                                                                                        const updated = readyDashers.map(d => d.id === dasher.id ? {...d, crimson: e.target.checked, crimsonAt: e.target.checked ? new Date().toISOString() : null} : d);
                                                                                        setReadyDashers(updated);
                                                                                        setTimeout(saveAllToLocalStorage, 100);
                                                                                    }}
                                                                                    className="w-3.5 h-3.5"
                                                                                />
                                                                                <span className="text-xs">Crimson</span>
                                                                            </label>
                                                                            <label className="flex items-center gap-1.5 cursor-pointer text-red-400 hover:text-red-300">
                                                                                <input
                                                                                    type="checkbox"
                                                                                    checked={dasher.redCard || false}
                                                                                    onChange={(e) => {
                                                                                        const updated = readyDashers.map(d => d.id === dasher.id ? {...d, redCard: e.target.checked, redCardAt: e.target.checked ? new Date().toISOString() : null} : d);
                                                                                        setReadyDashers(updated);
                                                                                        setTimeout(saveAllToLocalStorage, 100);
                                                                                    }}
                                                                                    className="w-3.5 h-3.5"
                                                                                />
                                                                                <span className="text-xs">Red Card</span>
                                                                            </label>
                                                                        </div>
                                                                        <button
                                                                            onClick={() => {
                                                                                setEditingDasher({
                                                                                    categoryId: 'ready',
                                                                                    dasherId: dasher.id,
                                                                                    name: dasher.name,
                                                                                    email: dasher.email,
                                                                                    balance: dasher.balance,
                                                                                    notes: dasher.notes || ''
                                                                                });
                                                                            }}
                                                                            className="w-full bg-yellow-600 hover:bg-yellow-700 text-white rounded px-3 py-1.5 text-sm flex items-center justify-center gap-2 mt-2"
                                                                        >
                                                                            <Edit2 size={14} /> Edit Dasher
                                                                        </button>
                                                                    </>
                                                                )}
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })
                                        )}
                                    </div>
                                )}
                            </div>

                            {/* Dashers - Currently Using Section */}
                            <div className="bg-gray-800 rounded-lg overflow-hidden mt-3">
                                <button
                                    onClick={() => setIsCurrentlyUsingDashersOpen(!isCurrentlyUsingDashersOpen)}
                                    className="w-full flex items-center justify-between p-4 text-left hover:bg-gray-700/50 transition-colors"
                                >
                                    <div className="flex items-center gap-3">
                                        <Activity size={20} className="text-blue-400" />
                                        <span className="text-lg font-medium">
                                            Dashers - Currently Using {currentlyUsingDashers.length > 0 && `(${currentlyUsingDashers.length})`}
                                        </span>
                                    </div>
                                    {isCurrentlyUsingDashersOpen ? <ChevronUp size={20} /> : <ChevronDown size={20} />}
                                </button>
                                {isCurrentlyUsingDashersOpen && (
                                    <div className="p-4 pt-2 space-y-2">
                                        {currentlyUsingDashers.length === 0 ? (
                                            <div className="text-center text-gray-500 py-8 text-sm italic">No dashers currently in use</div>
                                        ) : (
                                            currentlyUsingDashers.map((dasher) => {
                                                const timeStatus = calculateDasherTimeStatus(dasher.lastUsed);
                                                const dasherTitle = getDasherTitle(dasher);
                                                const isCollapsed = collapsedDashers[dasher.id] || false;
                                                const isEditing = editingDasher.dasherId === dasher.id;

                                                return (
                                                    <div
                                                        key={dasher.id}
                                                        className="bg-gray-600/50 rounded-lg overflow-hidden border border-gray-500/30 dasher-card--currently-using"
                                                    >
                                                        <div className="flex items-center justify-between p-3">
                                                            <div className="flex items-center gap-2 flex-1">
                                                                <button
                                                                    onClick={() => {
                                                                        setCollapsedDashers({...collapsedDashers, [dasher.id]: !isCollapsed});
                                                                        setTimeout(saveAllToLocalStorage, 100);
                                                                    }}
                                                                    className="flex items-center gap-2 flex-1 text-left"
                                                                >
                                                                    {isCollapsed ? <ChevronDown size={14} /> : <ChevronUp size={14} />}
                                                                    <div className="flex-1">
                                                                        <h5 className="font-medium text-purple-300 text-sm flex items-center gap-2">
                                                                            {dasherTitle}
                                                                            <span className="flag-badges">
                                                                                <span className="flag-badge" data-flag="C" data-active={dasher.crimson ? 'true' : 'false'}>CRIMSON</span>
                                                                                <span className="flag-badge" data-flag="RC" data-active={dasher.redCard ? 'true' : 'false'}>RED CARD</span>
                                                                                <span className="flag-badge" data-flag="AP" data-active={dasher.appealed ? 'true' : 'false'}>APPEALED</span>
                                                                            </span>
                                                                            {dasher.lastUsed && (
                                                                                <button
                                                                                    onClick={(e) => {
                                                                                        e.stopPropagation();
                                                                                        const updated = currentlyUsingDashers.map(d => d.id === dasher.id ? {...d, lastUsed: null} : d);
                                                                                        setCurrentlyUsingDashers(updated);
                                                                                        setTimeout(saveAllToLocalStorage, 100);
                                                                                    }}
                                                                                    className="text-orange-400 hover:text-orange-300 p-0.5"
                                                                                    title="Reset timer"
                                                                                >
                                                                                    <TimerOff size={12} />
                                                                                </button>
                                                                            )}
                                                                        </h5>
                                                                    </div>
                                                                </button>
                                                            </div>
                                                            <div className="flex items-center gap-2">
                                                                {/* Category Movement Group */}
                                                                <div className="flex items-center gap-1 pr-2 border-r border-gray-600">
                                                                    <button
                                                                        onClick={() => restoreDasherToMain(dasher.id, 'currently-using')}
                                                                        className="icon-btn text-blue-400 hover:text-blue-300"
                                                                        title="Return to Main"
                                                                    >
                                                                        <UserCheck size={14} />
                                                                    </button>
                                                                    <button
                                                                        onClick={() => {
                                                                            const updated = currentlyUsingDashers.filter(d => d.id !== dasher.id);
                                                                            setCurrentlyUsingDashers(updated);
                                                                            const moved = {...dasher, ready: true, readyAt: new Date().toISOString()};
                                                                            delete moved.currentlyUsing;
                                                                            delete moved.currentlyUsingAt;
                                                                            setReadyDashers([moved, ...readyDashers]);
                                                                            setTimeout(saveAllToLocalStorage, 100);
                                                                        }}
                                                                        className="icon-btn text-green-400 hover:text-green-300"
                                                                        title="Move to Ready"
                                                                    >
                                                                        <CircleCheck size={14} />
                                                                    </button>
                                                                    <button
                                                                        onClick={() => {
                                                                            const updated = currentlyUsingDashers.filter(d => d.id !== dasher.id);
                                                                            setCurrentlyUsingDashers(updated);
                                                                            const moved = {...dasher, appealed: true, appealedAt: new Date().toISOString()};
                                                                            delete moved.currentlyUsing;
                                                                            delete moved.currentlyUsingAt;
                                                                            setAppealedDashers([moved, ...appealedDashers]);
                                                                            setTimeout(saveAllToLocalStorage, 100);
                                                                        }}
                                                                        className="icon-btn text-amber-400 hover:text-amber-300"
                                                                        title="Move to Appealed"
                                                                    >
                                                                        <CircleCheck size={14} />
                                                                    </button>
                                                                </div>

                                                                {/* Control Buttons Group */}
                                                                <div className="flex items-center gap-1">
                                                                    <button
                                                                        onClick={() => {
                                                                            const updated = currentlyUsingDashers.map(d => d.id === dasher.id ? {...d, lastUsed: new Date().toISOString()} : d);
                                                                            setCurrentlyUsingDashers(updated);
                                                                            setTimeout(saveAllToLocalStorage, 100);
                                                                        }}
                                                                        className="icon-btn text-purple-400 hover:text-purple-300"
                                                                        title="Start Timer"
                                                                    >
                                                                        <Timer size={14} />
                                                                    </button>
                                                                    <button
                                                                        onClick={() => {
                                                                            const updated = currentlyUsingDashers.filter(d => d.id !== dasher.id);
                                                                            setCurrentlyUsingDashers(updated);
                                                                            const moved = {...dasher, deactivated: true, deactivatedAt: new Date().toISOString()};
                                                                            delete moved.currentlyUsing;
                                                                            delete moved.currentlyUsingAt;
                                                                            setDeactivatedDashers([moved, ...deactivatedDashers]);
                                                                            setTimeout(saveAllToLocalStorage, 100);
                                                                        }}
                                                                        className="icon-btn text-red-400 hover:text-red-300"
                                                                        title="Deactivate"
                                                                    >
                                                                        <UserX size={14} />
                                                                    </button>
                                                                    <button
                                                                        onClick={() => {
                                                                            const updated = currentlyUsingDashers.filter(d => d.id !== dasher.id);
                                                                            setCurrentlyUsingDashers(updated);
                                                                            const moved = {...dasher, archived: true, archivedAt: new Date().toISOString()};
                                                                            delete moved.currentlyUsing;
                                                                            delete moved.currentlyUsingAt;
                                                                            setArchivedDashers([moved, ...archivedDashers]);
                                                                            setTimeout(saveAllToLocalStorage, 100);
                                                                        }}
                                                                        className="icon-btn text-amber-400 hover:text-amber-300"
                                                                        title="Archive"
                                                                    >
                                                                        <Archive size={14} />
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        {!isCollapsed && (
                                                            <div className="border-t border-gray-500/30 p-3 space-y-2 text-xs">
                                                                {isEditing ? (
                                                                    <>
                                                                        <input type="text" value={editingDasher.name} onChange={(e) => setEditingDasher({...editingDasher, name: e.target.value})} className="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm" placeholder="Name" />
                                                                        <input type="email" value={editingDasher.email} onChange={(e) => setEditingDasher({...editingDasher, email: e.target.value})} className="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm" placeholder="Email" />
                                                                        <input type="number" step="0.01" value={editingDasher.balance} onChange={(e) => setEditingDasher({...editingDasher, balance: parseFloat(e.target.value) || 0})} className="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm" placeholder="Balance" />
                                                                        <textarea value={editingDasher.notes} onChange={(e) => setEditingDasher({...editingDasher, notes: e.target.value})} className="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm resize-y" placeholder="Notes" rows={2} />
                                                                        <button onClick={() => { const updated = currentlyUsingDashers.map(d => d.id === dasher.id ? {...d, ...editingDasher} : d); setCurrentlyUsingDashers(updated); setEditingDasher({categoryId: null, dasherId: null, name: '', email: '', balance: 0, notes: ''}); setTimeout(saveAllToLocalStorage, 100); }} className="w-full bg-green-600 hover:bg-green-700 text-white rounded px-3 py-1.5 text-sm flex items-center justify-center gap-2"><Check size={14} /> Save Changes</button>
                                                                    </>
                                                                ) : (
                                                                    <>
                                                                        <div className="flex items-center justify-between"><span className="text-gray-400">Name:</span><div className="flex items-center gap-1"><span className="text-purple-300">{dasher.name}</span><button onClick={() => copyToClipboard(dasher.name)} className="copy-btn"><Copy size={10} /></button></div></div>
                                                                        <div className="flex items-center justify-between"><span className="text-gray-400">Email:</span><div className="flex items-center gap-1"><span className="text-blue-300">{dasher.email}</span><button onClick={() => copyToClipboard(dasher.email)} className="copy-btn"><Copy size={10} /></button></div></div>
                                                                        <div className="flex items-center justify-between"><span className="text-gray-400">Balance:</span><div className="flex items-center gap-1"><span className={(Number(dasher.balance) || 0) === 0 ? 'text-green-400' : 'text-red-400'}>${(Number(dasher.balance) || 0).toFixed(2)}</span><button onClick={() => copyToClipboard((Number(dasher.balance) || 0).toString())} className="copy-btn"><Copy size={10} /></button></div></div>
                                                                        {dasher.lastUsed && (<div className="flex items-center justify-between"><span className="text-gray-400">Timer:</span><span className={`font-mono ${timeStatus.color}`}>{timeStatus.display}</span></div>)}
                                                                        {dasher.notes && (<div className="pt-1"><div className="flex items-center justify-between mb-1"><span className="text-gray-400">Notes:</span><button onClick={() => copyToClipboard(dasher.notes)} className="copy-btn"><Copy size={10} /></button></div><p className="text-gray-300 text-xs whitespace-pre-wrap bg-gray-700/30 rounded p-2">{dasher.notes}</p></div>)}
                                                                        <div className="flex items-center gap-3 pt-1">
                                                                            <label className="flex items-center gap-1.5 cursor-pointer text-red-400 hover:text-red-300"><input type="checkbox" checked={dasher.crimson || false} onChange={(e) => { const updated = currentlyUsingDashers.map(d => d.id === dasher.id ? {...d, crimson: e.target.checked, crimsonAt: e.target.checked ? new Date().toISOString() : null} : d); setCurrentlyUsingDashers(updated); setTimeout(saveAllToLocalStorage, 100); }} className="w-3.5 h-3.5" /><span className="text-xs">Crimson</span></label>
                                                                            <label className="flex items-center gap-1.5 cursor-pointer text-red-400 hover:text-red-300"><input type="checkbox" checked={dasher.redCard || false} onChange={(e) => { const updated = currentlyUsingDashers.map(d => d.id === dasher.id ? {...d, redCard: e.target.checked, redCardAt: e.target.checked ? new Date().toISOString() : null} : d); setCurrentlyUsingDashers(updated); setTimeout(saveAllToLocalStorage, 100); }} className="w-3.5 h-3.5" /><span className="text-xs">Red Card</span></label>
                                                                        </div>
                                                                        <button onClick={() => { setEditingDasher({ categoryId: 'currently-using', dasherId: dasher.id, name: dasher.name, email: dasher.email, balance: dasher.balance, notes: dasher.notes || '' }); }} className="w-full bg-yellow-600 hover:bg-yellow-700 text-white rounded px-3 py-1.5 text-sm flex items-center justify-center gap-2 mt-2"><Edit2 size={14} /> Edit Dasher</button>
                                                                    </>
                                                                )}
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })
                                        )}
                                    </div>
                                )}
                            </div>

                            {/* Dashers - Appealed Section */}
                            <div className="bg-gray-800 rounded-lg overflow-hidden mt-3">
                                <button
                                    onClick={() => setIsAppealedDashersOpen(!isAppealedDashersOpen)}
                                    className="w-full flex items-center justify-between p-4 text-left hover:bg-gray-700/50 transition-colors"
                                >
                                    <div className="flex items-center gap-3">
                                        <CircleCheck size={20} className="text-amber-400" />
                                        <span className="text-lg font-medium">
                                            Dashers - Appealed {appealedDashers.length > 0 && `(${appealedDashers.length})`}
                                        </span>
                                    </div>
                                    {isAppealedDashersOpen ? <ChevronUp size={20} /> : <ChevronDown size={20} />}
                                </button>
                                {isAppealedDashersOpen && (
                                    <div className="p-4 pt-2 space-y-2">
                                        {appealedDashers.length === 0 ? (
                                            <div className="text-center text-gray-500 py-8 text-sm italic">No appealed dashers</div>
                                        ) : (
                                            appealedDashers.map((dasher) => {
                                                const timeStatus = calculateDasherTimeStatus(dasher.lastUsed);
                                                const dasherTitle = getDasherTitle(dasher);
                                                const isCollapsed = collapsedDashers[dasher.id] || false;
                                                const isEditing = editingDasher.dasherId === dasher.id;

                                                return (
                                                    <div key={dasher.id} className="bg-gray-600/50 rounded-lg overflow-hidden border border-gray-500/30 dasher-card--appealed">
                                                        <div className="flex items-center justify-between p-3">
                                                            <div className="flex items-center gap-2 flex-1">
                                                                <button onClick={() => { setCollapsedDashers({...collapsedDashers, [dasher.id]: !isCollapsed}); setTimeout(saveAllToLocalStorage, 100); }} className="flex items-center gap-2 flex-1 text-left">
                                                                    {isCollapsed ? <ChevronDown size={14} /> : <ChevronUp size={14} />}
                                                                    <div className="flex-1">
                                                                        <h5 className="font-medium text-purple-300 text-sm flex items-center gap-2">
                                                                            {dasherTitle}
                                                                            <span className="flag-badges">
                                                                                <span className="flag-badge" data-flag="C" data-active={dasher.crimson ? 'true' : 'false'}>CRIMSON</span>
                                                                                <span className="flag-badge" data-flag="RC" data-active={dasher.redCard ? 'true' : 'false'}>RED CARD</span>
                                                                                <span className="flag-badge" data-flag="AP" data-active={dasher.appealed ? 'true' : 'false'}>APPEALED</span>
                                                                            </span>
                                                                            {dasher.lastUsed && (<button onClick={(e) => { e.stopPropagation(); const updated = appealedDashers.map(d => d.id === dasher.id ? {...d, lastUsed: null} : d); setAppealedDashers(updated); setTimeout(saveAllToLocalStorage, 100); }} className="text-orange-400 hover:text-orange-300 p-0.5" title="Reset timer"><TimerOff size={12} /></button>)}
                                                                        </h5>
                                                                    </div>
                                                                </button>
                                                            </div>
                                                            <div className="flex items-center gap-2">
                                                                {/* Category Movement Group */}
                                                                <div className="flex items-center gap-1 pr-2 border-r border-gray-600">
                                                                    <button
                                                                        onClick={() => restoreDasherToMain(dasher.id, 'appealed')}
                                                                        className="icon-btn text-blue-400 hover:text-blue-300"
                                                                        title="Return to Main"
                                                                    >
                                                                        <UserCheck size={14} />
                                                                    </button>
                                                                    <button
                                                                        onClick={() => {
                                                                            const updated = appealedDashers.filter(d => d.id !== dasher.id);
                                                                            setAppealedDashers(updated);
                                                                            const moved = {...dasher, ready: true, readyAt: new Date().toISOString()};
                                                                            delete moved.appealed;
                                                                            delete moved.appealedAt;
                                                                            setReadyDashers([moved, ...readyDashers]);
                                                                            setTimeout(saveAllToLocalStorage, 100);
                                                                        }}
                                                                        className="icon-btn text-green-400 hover:text-green-300"
                                                                        title="Move to Ready"
                                                                    >
                                                                        <CircleCheck size={14} />
                                                                    </button>
                                                                    <button
                                                                        onClick={() => {
                                                                            const updated = appealedDashers.filter(d => d.id !== dasher.id);
                                                                            setAppealedDashers(updated);
                                                                            const moved = {...dasher, currentlyUsing: true, currentlyUsingAt: new Date().toISOString()};
                                                                            delete moved.appealed;
                                                                            delete moved.appealedAt;
                                                                            setCurrentlyUsingDashers([moved, ...currentlyUsingDashers]);
                                                                            setTimeout(saveAllToLocalStorage, 100);
                                                                        }}
                                                                        className="icon-btn text-blue-400 hover:text-blue-300"
                                                                        title="Move to Using"
                                                                    >
                                                                        <Activity size={14} />
                                                                    </button>
                                                                </div>

                                                                {/* Control Buttons Group */}
                                                                <div className="flex items-center gap-1">
                                                                    <button
                                                                        onClick={() => {
                                                                            const updated = appealedDashers.map(d => d.id === dasher.id ? {...d, lastUsed: new Date().toISOString()} : d);
                                                                            setAppealedDashers(updated);
                                                                            setTimeout(saveAllToLocalStorage, 100);
                                                                        }}
                                                                        className="icon-btn text-purple-400 hover:text-purple-300"
                                                                        title="Start Timer"
                                                                    >
                                                                        <Timer size={14} />
                                                                    </button>
                                                                    <button
                                                                        onClick={() => {
                                                                            const updated = appealedDashers.filter(d => d.id !== dasher.id);
                                                                            setAppealedDashers(updated);
                                                                            const moved = {...dasher, deactivated: true, deactivatedAt: new Date().toISOString()};
                                                                            delete moved.appealed;
                                                                            delete moved.appealedAt;
                                                                            setDeactivatedDashers([moved, ...deactivatedDashers]);
                                                                            setTimeout(saveAllToLocalStorage, 100);
                                                                        }}
                                                                        className="icon-btn text-red-400 hover:text-red-300"
                                                                        title="Deactivate"
                                                                    >
                                                                        <UserX size={14} />
                                                                    </button>
                                                                    <button
                                                                        onClick={() => {
                                                                            const updated = appealedDashers.filter(d => d.id !== dasher.id);
                                                                            setAppealedDashers(updated);
                                                                            const moved = {...dasher, archived: true, archivedAt: new Date().toISOString()};
                                                                            delete moved.appealed;
                                                                            delete moved.appealedAt;
                                                                            setArchivedDashers([moved, ...archivedDashers]);
                                                                            setTimeout(saveAllToLocalStorage, 100);
                                                                        }}
                                                                        className="icon-btn text-amber-400 hover:text-amber-300"
                                                                        title="Archive"
                                                                    >
                                                                        <Archive size={14} />
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        {!isCollapsed && (
                                                            <div className="border-t border-gray-500/30 p-3 space-y-2 text-xs">
                                                                {isEditing ? (
                                                                    <>
                                                                        <input type="text" value={editingDasher.name} onChange={(e) => setEditingDasher({...editingDasher, name: e.target.value})} className="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm" placeholder="Name" />
                                                                        <input type="email" value={editingDasher.email} onChange={(e) => setEditingDasher({...editingDasher, email: e.target.value})} className="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm" placeholder="Email" />
                                                                        <input type="number" step="0.01" value={editingDasher.balance} onChange={(e) => setEditingDasher({...editingDasher, balance: parseFloat(e.target.value) || 0})} className="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm" placeholder="Balance" />
                                                                        <textarea value={editingDasher.notes} onChange={(e) => setEditingDasher({...editingDasher, notes: e.target.value})} className="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm resize-y" placeholder="Notes" rows={2} />
                                                                        <button onClick={() => { const updated = appealedDashers.map(d => d.id === dasher.id ? {...d, ...editingDasher} : d); setAppealedDashers(updated); setEditingDasher({categoryId: null, dasherId: null, name: '', email: '', balance: 0, notes: ''}); setTimeout(saveAllToLocalStorage, 100); }} className="w-full bg-green-600 hover:bg-green-700 text-white rounded px-3 py-1.5 text-sm flex items-center justify-center gap-2"><Check size={14} /> Save Changes</button>
                                                                    </>
                                                                ) : (
                                                                    <>
                                                                        <div className="flex items-center justify-between"><span className="text-gray-400">Name:</span><div className="flex items-center gap-1"><span className="text-purple-300">{dasher.name}</span><button onClick={() => copyToClipboard(dasher.name)} className="copy-btn"><Copy size={10} /></button></div></div>
                                                                        <div className="flex items-center justify-between"><span className="text-gray-400">Email:</span><div className="flex items-center gap-1"><span className="text-blue-300">{dasher.email}</span><button onClick={() => copyToClipboard(dasher.email)} className="copy-btn"><Copy size={10} /></button></div></div>
                                                                        <div className="flex items-center justify-between"><span className="text-gray-400">Balance:</span><div className="flex items-center gap-1"><span className={(Number(dasher.balance) || 0) === 0 ? 'text-green-400' : 'text-red-400'}>${(Number(dasher.balance) || 0).toFixed(2)}</span><button onClick={() => copyToClipboard((Number(dasher.balance) || 0).toString())} className="copy-btn"><Copy size={10} /></button></div></div>
                                                                        {dasher.lastUsed && (<div className="flex items-center justify-between"><span className="text-gray-400">Timer:</span><span className={`font-mono ${timeStatus.color}`}>{timeStatus.display}</span></div>)}
                                                                        {dasher.notes && (<div className="pt-1"><div className="flex items-center justify-between mb-1"><span className="text-gray-400">Notes:</span><button onClick={() => copyToClipboard(dasher.notes)} className="copy-btn"><Copy size={10} /></button></div><p className="text-gray-300 text-xs whitespace-pre-wrap bg-gray-700/30 rounded p-2">{dasher.notes}</p></div>)}
                                                                        <div className="flex items-center gap-3 pt-1">
                                                                            <label className="flex items-center gap-1.5 cursor-pointer text-red-400 hover:text-red-300"><input type="checkbox" checked={dasher.crimson || false} onChange={(e) => { const updated = appealedDashers.map(d => d.id === dasher.id ? {...d, crimson: e.target.checked, crimsonAt: e.target.checked ? new Date().toISOString() : null} : d); setAppealedDashers(updated); setTimeout(saveAllToLocalStorage, 100); }} className="w-3.5 h-3.5" /><span className="text-xs">Crimson</span></label>
                                                                            <label className="flex items-center gap-1.5 cursor-pointer text-red-400 hover:text-red-300"><input type="checkbox" checked={dasher.redCard || false} onChange={(e) => { const updated = appealedDashers.map(d => d.id === dasher.id ? {...d, redCard: e.target.checked, redCardAt: e.target.checked ? new Date().toISOString() : null} : d); setAppealedDashers(updated); setTimeout(saveAllToLocalStorage, 100); }} className="w-3.5 h-3.5" /><span className="text-xs">Red Card</span></label>
                                                                        </div>
                                                                        <button onClick={() => { setEditingDasher({ categoryId: 'appealed', dasherId: dasher.id, name: dasher.name, email: dasher.email, balance: dasher.balance, notes: dasher.notes || '' }); }} className="w-full bg-yellow-600 hover:bg-yellow-700 text-white rounded px-3 py-1.5 text-sm flex items-center justify-center gap-2 mt-2"><Edit2 size={14} /> Edit Dasher</button>
                                                                    </>
                                                                )}
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })
                                        )}
                                    </div>
                                )}
                            </div>

                            {/* Dashers - Deactivated Section */}
                            <div className="bg-gray-800 rounded-lg overflow-hidden mt-3">
                                <button
                                    onClick={() => setIsDeactivatedDashersOpen(!isDeactivatedDashersOpen)}
                                    className="w-full flex items-center justify-between p-4 text-left hover:bg-gray-700/50 transition-colors"
                                >
                                    <div className="flex items-center gap-3">
                                        <UserX size={20} className="text-red-400" />
                                        <span className="text-lg font-medium">
                                            Dashers - Deactivated {deactivatedDashers.length > 0 && `(${deactivatedDashers.length})`}
                                        </span>
                                        {isDeactivatedDashersOpen && deactivatedDashers.length > 0 && (
                                            <div className="flex items-center gap-1 ml-2" onClick={(e) => e.stopPropagation()}>
                                                <button
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        const all = {};
                                                        deactivatedDashers.forEach(d => { all[d.id] = true; });
                                                        setCollapsedDeactivatedDashers(all);
                                                    }}
                                                    className="text-gray-400 hover:text-gray-300 p-0.5"
                                                    title="Collapse all deactivated dashers"
                                                >
                                                    <ChevronUp size={14} />
                                                </button>
                                                <button
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        setCollapsedDeactivatedDashers({});
                                                    }}
                                                    className="text-gray-400 hover:text-gray-300 p-0.5"
                                                    title="Expand all deactivated dashers"
                                                >
                                                    <ChevronDown size={14} />
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                    {isDeactivatedDashersOpen ? <ChevronUp size={20} /> : <ChevronDown size={20} />}
                                </button>
                                {isDeactivatedDashersOpen && (
                                    <div className="p-4 pt-2 space-y-2">
                                        {deactivatedDashers.length === 0 ? (
                                            <div className="text-center text-gray-500 py-8 text-sm italic">No deactivated dashers</div>
                                        ) : (
                                            deactivatedDashers.map((dasher) => {
                                                const isEditing = isDasherEditing('deactivated', dasher.id);
                                                const isCollapsed = collapsedDeactivatedDashers[dasher.id];
                                                const timeStatus = calculateDasherTimeStatus(dasher.lastUsed);
                                                const dasherTitle = getDasherTitle(dasher);

                                                return (
                                                    <div
                                                        key={dasher.id}
                                                        className={`bg-gray-600/50 rounded-lg overflow-hidden border border-gray-500/30 transition-opacity dasher-card--deactivated ${
                                                            dasher.ready ? 'dasher-card--ready' : ''
                                                        } ${
                                                            dasher.appealed ? 'dasher-card--appealed' : ''
                                                        }`}
                                                    >
                                                        {/* Dasher Header */}
                                                        <div className="flex items-center justify-between p-3">
                                                            <div className="flex items-center gap-2 flex-1">
                                                                {/* Checkbox for selection (only visible in edit mode) */}
                                                                {isEditMode && (
                                                                    <input
                                                                        type="checkbox"
                                                                        checked={selectedItems.deactivatedDashers && selectedItems.deactivatedDashers.has ? selectedItems.deactivatedDashers.has(dasher.id) : false}
                                                                        onChange={(e) => {
                                                                            e.stopPropagation();
                                                                            toggleItemSelection('deactivatedDashers', dasher.id);
                                                                        }}
                                                                        onClick={(e) => e.stopPropagation()}
                                                                        className="w-4 h-4 text-blue-600 bg-gray-700 border-gray-500 rounded focus:ring-blue-500 focus:ring-2"
                                                                    />
                                                                )}
                                                                <div
                                                                    className={`${isEditing ? 'text-gray-700 cursor-not-allowed' : 'text-gray-400 hover:text-gray-300 cursor-move'}`}
                                                                    aria-label="Drag to reorder"
                                                                    style={{ pointerEvents: isEditing ? 'none' : 'auto' }}
                                                                >
                                                                    <GripVertical size={14} />
                                                                </div>
                                                                <button
                                                                    onClick={() => setCollapsedDeactivatedDashers(prev => ({ ...prev, [dasher.id]: !prev[dasher.id] }))}
                                                                    className="flex items-center gap-2 flex-1 text-left"
                                                                >
                                                                    {isCollapsed ? <ChevronDown size={14} /> : <ChevronUp size={14} />}
                                                                    <div className="flex-1">
                                                                        <h5 className="font-medium text-purple-300 text-sm flex items-center gap-2">
                                                                            {dasherTitle}
                                                                            {/* Status Badges */}
                                                                            <span className="flag-badges" aria-label="Dasher status flags (Crimson, Red Card, Appealed)">
                                                                                <span
                                                                                    className="flag-badge"
                                                                                    data-flag="C"
                                                                                    data-active={dasher.crimson ? 'true' : 'false'}
                                                                                    title={dasher.crimson ? (dasher.crimsonAt ? `Crimson since ${new Date(dasher.crimsonAt).toLocaleString()}` : 'Crimson active') : 'Crimson inactive'}
                                                                                >CRIMSON</span>
                                                                                <span
                                                                                    className="flag-badge"
                                                                                    data-flag="RC"
                                                                                    data-active={dasher.redCard ? 'true' : 'false'}
                                                                                    title={dasher.redCard ? (dasher.redCardAt ? `Red Card since ${new Date(dasher.redCardAt).toLocaleString()}` : 'Red Card active') : 'Red Card inactive'}
                                                                                >RED CARD</span>
                                                                                <span
                                                                                    className="flag-badge"
                                                                                    data-flag="AP"
                                                                                    data-active={dasher.appealed ? 'true' : 'false'}
                                                                                    title={dasher.appealed ? (dasher.appealedAt ? `Appealed since ${new Date(dasher.appealedAt).toLocaleString()}` : 'Appealed active') : 'Appealed inactive'}
                                                                                >APPEALED</span>
                                                                            </span>
                                                                            {dasher.lastUsed && (
                                                                                <button
                                                                                    onClick={(e) => {
                                                                                        e.stopPropagation();
                                                                                        resetDasherTimer('deactivated', dasher.id);
                                                                                    }}
                                                                                    className="text-orange-400 hover:text-orange-300 p-0.5"
                                                                                    title="Reset timer"
                                                                                >
                                                                                    <TimerOff size={12} />
                                                                                </button>
                                                                            )}
                                                                        </h5>
                                                                    </div>
                                                                </button>
                                                            </div>
                                                            <div className="flex items-center gap-2">
                                                                {/* Category Movement Group */}
                                                                <div className="flex items-center gap-1 pr-2 border-r border-gray-600">
                                                                    <button
                                                                        onClick={() => reactivateDasher(dasher.id)}
                                                                        className="icon-btn text-blue-400 hover:text-blue-300"
                                                                        title="Reactivate"
                                                                    >
                                                                        <UserCheck size={14} />
                                                                    </button>
                                                                    <button
                                                                        onClick={() => {
                                                                            const updated = deactivatedDashers.filter(d => d.id !== dasher.id);
                                                                            setDeactivatedDashers(updated);
                                                                            const moved = {...dasher, ready: true, readyAt: new Date().toISOString()};
                                                                            delete moved.deactivated;
                                                                            delete moved.deactivatedAt;
                                                                            setReadyDashers([moved, ...readyDashers]);
                                                                            setTimeout(saveAllToLocalStorage, 100);
                                                                        }}
                                                                        className="icon-btn text-green-400 hover:text-green-300"
                                                                        title="Move to Ready"
                                                                    >
                                                                        <CircleCheck size={14} />
                                                                    </button>
                                                                    <button
                                                                        onClick={() => {
                                                                            const updated = deactivatedDashers.filter(d => d.id !== dasher.id);
                                                                            setDeactivatedDashers(updated);
                                                                            const moved = {...dasher, currentlyUsing: true, currentlyUsingAt: new Date().toISOString()};
                                                                            delete moved.deactivated;
                                                                            delete moved.deactivatedAt;
                                                                            setCurrentlyUsingDashers([moved, ...currentlyUsingDashers]);
                                                                            setTimeout(saveAllToLocalStorage, 100);
                                                                        }}
                                                                        className="icon-btn text-blue-400 hover:text-blue-300"
                                                                        title="Move to Using"
                                                                    >
                                                                        <Activity size={14} />
                                                                    </button>
                                                                    <button
                                                                        onClick={() => {
                                                                            const updated = deactivatedDashers.filter(d => d.id !== dasher.id);
                                                                            setDeactivatedDashers(updated);
                                                                            const moved = {...dasher, appealed: true, appealedAt: new Date().toISOString()};
                                                                            delete moved.deactivated;
                                                                            delete moved.deactivatedAt;
                                                                            setAppealedDashers([moved, ...appealedDashers]);
                                                                            setTimeout(saveAllToLocalStorage, 100);
                                                                        }}
                                                                        className="icon-btn text-amber-400 hover:text-amber-300"
                                                                        title="Move to Appealed"
                                                                    >
                                                                        <CircleCheck size={14} />
                                                                    </button>
                                                                </div>

                                                                {/* Control Buttons Group */}
                                                                <div className="flex items-center gap-1">
                                                                    <button
                                                                        onClick={() => startDasherTimer('deactivated', dasher.id)}
                                                                        className="icon-btn text-purple-400 hover:text-purple-300"
                                                                        title="Start Timer"
                                                                    >
                                                                        <Timer size={14} />
                                                                    </button>
                                                                    <button
                                                                        onClick={() => archiveDasher('deactivated', dasher.id)}
                                                                        className="icon-btn text-amber-400 hover:text-amber-300"
                                                                        title="Archive"
                                                                    >
                                                                        <Archive size={14} />
                                                                    </button>
                                                                    <button
                                                                        onClick={() => deleteDasher('deactivated', dasher.id)}
                                                                        className="icon-btn text-red-400 hover:text-red-300"
                                                                        title="Delete"
                                                                    >
                                                                        <Trash2 size={14} />
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        {/* Dasher Details */}
                                                        {!isCollapsed && (
                                                            <div className="space-y-2 p-3 pt-0 border-t border-gray-600/30">
                                                            {/* Name */}
                                                            <div className="flex items-center gap-2">
                                                                <label className="text-xs text-gray-400 w-20">Name:</label>
                                                                {isEditing ? (
                                                                    <input
                                                                        type="text"
                                                                        value={dasher.name}
                                                                        onChange={(e) => updateDasher('deactivated', dasher.id, 'name', e.target.value)}
                                                                        className="flex-1 bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs text-white focus:outline-none focus:ring-1 focus:ring-blue-500"
                                                                        placeholder="Enter name..."
                                                                    />
                                                                ) : (
                                                                    <>
                                                                        <div className="flex-1 text-xs text-gray-200">
                                                                            {dasher.name || <span className="italic text-gray-500">No name</span>}
                                                                        </div>
                                                                        {dasher.name && (
                                                                            <button
                                                                                onClick={() => copyToClipboard(dasher.name)}
                                                                                className="text-blue-400 hover:text-blue-300 p-1"
                                                                                title="Copy name"
                                                                            >
                                                                                <Copy size={12} />
                                                                            </button>
                                                                        )}
                                                                    </>
                                                                )}
                                                            </div>

                                                            {/* Email */}
                                                            <div className="flex items-center gap-2">
                                                                <label className="text-xs text-gray-400 w-20">Email:</label>
                                                                {isEditing ? (
                                                                    <input
                                                                        type="email"
                                                                        value={dasher.email}
                                                                        onChange={(e) => updateDasher('deactivated', dasher.id, 'email', e.target.value)}
                                                                        className="flex-1 bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs text-white focus:outline-none focus:ring-1 focus:ring-blue-500"
                                                                        placeholder="Enter email..."
                                                                    />
                                                                ) : (
                                                                    <>
                                                                        <div className="flex-1 text-xs text-gray-200">
                                                                            {dasher.email || <span className="italic text-gray-500">No email</span>}
                                                                        </div>
                                                                        {dasher.email && (
                                                                            <button
                                                                                onClick={() => copyToClipboard(dasher.email)}
                                                                                className="text-blue-400 hover:text-blue-300 p-1"
                                                                                title="Copy email"
                                                                            >
                                                                                <Copy size={12} />
                                                                            </button>
                                                                        )}
                                                                    </>
                                                                )}
                                                            </div>

                                                            {/* Email Password */}
                                                            <div className="flex items-center gap-2">
                                                                <label className="text-xs text-gray-400 w-20">Email pw:</label>
                                                                {isEditing ? (
                                                                    <input
                                                                        type="text"
                                                                        value={dasher.emailPw || ''}
                                                                        onChange={(e) => updateDasher('deactivated', dasher.id, 'emailPw', e.target.value)}
                                                                        className="flex-1 bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs text-white focus:outline-none focus:ring-1 focus:ring-blue-500"
                                                                        placeholder="Enter email password..."
                                                                    />
                                                                ) : (
                                                                    <>
                                                                        <div className="flex-1 text-xs text-gray-200">
                                                                            {dasher.emailPw ? '••••••••' : <span className="italic text-gray-500">No password</span>}
                                                                        </div>
                                                                        {dasher.emailPw && (
                                                                            <button
                                                                                onClick={() => copyToClipboard(dasher.emailPw)}
                                                                                className="text-blue-400 hover:text-blue-300 p-1"
                                                                                title="Copy email password"
                                                                            >
                                                                                <Copy size={12} />
                                                                            </button>
                                                                        )}
                                                                    </>
                                                                )}
                                                            </div>

                                                            {/* Dasher Password */}
                                                            <div className="flex items-center gap-2">
                                                                <label className="text-xs text-gray-400 w-20">Dasher pw:</label>
                                                                {isEditing ? (
                                                                    <input
                                                                        type="text"
                                                                        value={dasher.dasherPw || ''}
                                                                        onChange={(e) => updateDasher('deactivated', dasher.id, 'dasherPw', e.target.value)}
                                                                        className="flex-1 bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs text-white focus:outline-none focus:ring-1 focus:ring-blue-500"
                                                                        placeholder="Enter dasher password..."
                                                                    />
                                                                ) : (
                                                                    <>
                                                                        <div className="flex-1 text-xs text-gray-200">
                                                                            {dasher.dasherPw ? '••••••••' : <span className="italic text-gray-500">No password</span>}
                                                                        </div>
                                                                        {dasher.dasherPw && (
                                                                            <button
                                                                                onClick={() => copyToClipboard(dasher.dasherPw)}
                                                                                className="text-blue-400 hover:text-blue-300 p-1"
                                                                                title="Copy dasher password"
                                                                            >
                                                                                <Copy size={12} />
                                                                            </button>
                                                                        )}
                                                                    </>
                                                                )}
                                                            </div>

                                                            {/* Phone */}
                                                            <div className="flex items-center gap-2">
                                                                <label className="text-xs text-gray-400 w-20">Phone:</label>
                                                                {isEditing ? (
                                                                    <input
                                                                        type="tel"
                                                                        value={dasher.phone || ''}
                                                                        onChange={(e) => updateDasher('deactivated', dasher.id, 'phone', e.target.value)}
                                                                        className="flex-1 bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs text-white focus:outline-none focus:ring-1 focus:ring-blue-500"
                                                                        placeholder="Enter phone number..."
                                                                    />
                                                                ) : (
                                                                    <>
                                                                        <div className="flex-1 text-xs text-gray-200">
                                                                            {dasher.phone || <span className="italic text-gray-500">No phone</span>}
                                                                        </div>
                                                                        {dasher.phone && (
                                                                            <button
                                                                                onClick={() => copyToClipboard(dasher.phone)}
                                                                                className="text-blue-400 hover:text-blue-300 p-1"
                                                                                title="Copy phone"
                                                                            >
                                                                                <Copy size={12} />
                                                                            </button>
                                                                        )}
                                                                    </>
                                                                )}
                                                            </div>

                                                            {/* Balance */}
                                                            <div className="flex items-center gap-2">
                                                                <label className="text-xs text-gray-400 w-20">Balance:</label>
                                                                {isEditing ? (
                                                                    <input
                                                                        type="text"
                                                                        value={dasher.balance || ''}
                                                                        onChange={(e) => updateDasher('deactivated', dasher.id, 'balance', e.target.value)}
                                                                        className="flex-1 bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs text-white focus:outline-none focus:ring-1 focus:ring-blue-500"
                                                                        placeholder="Enter balance..."
                                                                    />
                                                                ) : (
                                                                    <>
                                                                        <div className="flex-1 text-xs text-gray-200">
                                                                            {dasher.balance || <span className="italic text-gray-500">No balance</span>}
                                                                        </div>
                                                                        {dasher.balance && (
                                                                            <button
                                                                                onClick={() => copyToClipboard(dasher.balance)}
                                                                                className="text-blue-400 hover:text-blue-300 p-1"
                                                                                title="Copy balance"
                                                                            >
                                                                                <Copy size={12} />
                                                                            </button>
                                                                        )}
                                                                    </>
                                                                )}
                                                            </div>

                                                            {/* Crimson Checkbox */}
                                                            <div className="flex items-center gap-2">
                                                                <label className="text-xs text-gray-400 w-20">Crimson:</label>
                                                                <input
                                                                    type="checkbox"
                                                                    checked={dasher.crimson || false}
                                                                    onChange={(e) => updateDasher('deactivated', dasher.id, 'crimson', e.target.checked)}
                                                                    disabled={!isEditing}
                                                                    className="h-3 w-3 text-purple-500 bg-gray-700 border-gray-600 rounded focus:ring-purple-500 focus:ring-1 disabled:opacity-50"
                                                                />
                                                                <span className="text-xs text-gray-400">{dasher.crimson ? 'Yes' : 'No'}</span>
                                                            </div>

                                                            {/* Red Card Checkbox */}
                                                            <div className="flex items-center gap-2">
                                                                <label className="text-xs text-gray-400 w-20">Red card:</label>
                                                                <input
                                                                    type="checkbox"
                                                                    checked={dasher.redCard || false}
                                                                    onChange={(e) => updateDasher('deactivated', dasher.id, 'redCard', e.target.checked)}
                                                                    disabled={!isEditing}
                                                                    className="h-3 w-3 text-red-500 bg-gray-700 border-gray-600 rounded focus:ring-red-500 focus:ring-1 disabled:opacity-50"
                                                                />
                                                                <span className="text-xs text-gray-400">{dasher.redCard ? 'Yes' : 'No'}</span>
                                                            </div>

                                                            {/* Appealed Checkbox */}
                                                            <div className="flex items-center gap-2">
                                                                <label className="text-xs text-gray-400 w-20">Appealed:</label>
                                                                <input
                                                                    type="checkbox"
                                                                    checked={dasher.appealed || false}
                                                                    onChange={(e) => updateDasher('deactivated', dasher.id, 'appealed', e.target.checked)}
                                                                    disabled={!isEditing}
                                                                    className="h-3 w-3 text-yellow-500 bg-gray-700 border-gray-600 rounded focus:ring-yellow-500 focus:ring-1 disabled:opacity-50"
                                                                />
                                                                <span className="text-xs text-gray-400">{dasher.appealed ? 'Yes' : 'No'}</span>
                                                            </div>

                                                            {/* Appealed Timer */}
                                                            {dasher.appealed && dasher.appealedAt && (
                                                                <div className="flex items-center gap-2">
                                                                    <label className="text-xs text-gray-400 w-20">Appealed at:</label>
                                                                    <div className="flex-1 text-xs">
                                                                        {(() => {
                                                                            const appealedStatus = calculateAppealedTimeStatus(dasher.appealedAt);
                                                                            return appealedStatus ? (
                                                                                <span className="flex items-center gap-1">
                                                                                    <span className={appealedStatus.color} title={appealedStatus.fullDate}>
                                                                                        {appealedStatus.text}
                                                                                    </span>
                                                                                    <button
                                                                                        onClick={() => resetAppealedTimer('deactivated', dasher.id)}
                                                                                        className="text-purple-400 hover:text-purple-300 p-0.5"
                                                                                        title="Reset appealed timer"
                                                                                        disabled={!isEditing}
                                                                                    >
                                                                                        <TimerOff size={12} />
                                                                                    </button>
                                                                                </span>
                                                                            ) : (
                                                                                <span className="text-gray-400">Not tracked</span>
                                                                            );
                                                                        })()}
                                                                    </div>
                                                                </div>
                                                            )}

                                                            {/* Last Used Timer */}
                                                            <div className="flex items-center gap-2">
                                                                <label className="text-xs text-gray-400 w-20">Last used:</label>
                                                                <div className="flex-1 text-xs">
                                                                    {timeStatus ? (
                                                                        <div>
                                                                            <span className={`font-mono ${timeStatus.color}`}>
                                                                                {timeStatus.text}
                                                                            </span>
                                                                            <div className="text-gray-500 text-[10px] mt-1">
                                                                                {timeStatus.fullDateTime}
                                                                            </div>
                                                                        </div>
                                                                    ) : (
                                                                        <span className="italic text-gray-500">Timer not started</span>
                                                                    )}
                                                                </div>
                                                            </div>

                                                            {/* Notes - Expandable */}
                                                            <div className="flex items-start gap-2">
                                                                <label className="text-xs text-gray-400 w-20 mt-1">Notes:</label>
                                                                {isEditing ? (
                                                                    <textarea
                                                                        value={dasher.notes || ''}
                                                                        onChange={(e) => updateDasher('deactivated', dasher.id, 'notes', e.target.value)}
                                                                        className="flex-1 bg-gray-700 border border-gray-600 rounded px-2 py-0.5 text-xs text-white resize-y min-h-[2.5rem] focus:outline-none focus:ring-1 focus:ring-blue-500"
                                                                        rows={2}
                                                                        placeholder="Add notes..."
                                                                    />
                                                                ) : (
                                                                    <>
                                                                        <div className="flex-1 text-xs text-gray-200 whitespace-pre-wrap">
                                                                            {dasher.notes || <span className="italic text-gray-500">No notes</span>}
                                                                        </div>
                                                                        {dasher.notes && (
                                                                            <button
                                                                                onClick={() => copyToClipboard(dasher.notes)}
                                                                                className="text-blue-400 hover:text-blue-300 p-1"
                                                                                title="Copy notes"
                                                                            >
                                                                                <Copy size={12} />
                                                                            </button>
                                                                        )}
                                                                    </>
                                                                )}
                                                            </div>
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })
                                        )}
                                    </div>
                                )}
                            </div>
                            <div className="bg-gray-800 rounded-lg overflow-hidden mt-3">
                                <button
                                    onClick={() => setIsArchivedDashersOpen(!isArchivedDashersOpen)}
                                    className="w-full flex items-center justify-between p-4 text-left hover:bg-gray-700/50 transition-colors"
                                >
                                    <div className="flex items-center gap-3">
                                        <Archive size={20} className="text-amber-400" />
                                        <span className="text-lg font-medium">
                                            Dashers - Archived {archivedDashers.length > 0 && `(${archivedDashers.length})`}
                                        </span>
                                        {isArchivedDashersOpen && archivedDashers.length > 0 && (
                                            <div className="flex items-center gap-1 ml-2" onClick={(e) => e.stopPropagation()}>
                                                <button
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        collapseAllArchivedDashers();
                                                    }}
                                                    className="text-gray-400 hover:text-gray-300 p-0.5"
                                                    title="Collapse all archived dashers"
                                                >
                                                    <ChevronUp size={14} />
                                                </button>
                                                <button
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        expandAllArchivedDashers();
                                                    }}
                                                    className="text-gray-400 hover:text-gray-300 p-0.5"
                                                    title="Expand all archived dashers"
                                                >
                                                    <ChevronDown size={14} />
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                    {isArchivedDashersOpen ? <ChevronUp size={20} /> : <ChevronDown size={20} />}
                                </button>

                                {isArchivedDashersOpen && (
                                    <div className="border-t border-gray-700 p-4 space-y-3">
                                        {archivedDashers.length === 0 ? (
                                            <p className="text-sm text-gray-400 text-center py-4">No archived dashers</p>
                                        ) : (
                                            archivedDashers.map((dasher) => {
                                                const timeStatus = calculateDasherTimeStatus(dasher.lastUsed);
                                                const dasherTitle = getDasherTitle(dasher);
                                                const isCollapsed = isArchivedDasherCollapsed(dasher.id);
                                                const archivedDate = new Date(dasher.archivedAt);
                                                const formattedArchiveDate = archivedDate.toLocaleString('en-US', {
                                                    month: 'short',
                                                    day: 'numeric',
                                                    year: 'numeric',
                                                    hour: 'numeric',
                                                    minute: '2-digit',
                                                    hour12: true
                                                });

                                                return (
                                                    <div
                                                        key={dasher.id}
                                                        className="bg-gray-600/50 rounded-lg overflow-hidden border border-gray-500/30"
                                                    >
                                                        {/* Archived Dasher Header */}
                                                        <div className="flex items-center justify-between p-3">
                                                            <div className="flex items-center gap-2 flex-1">
                                                                {/* Checkbox for selection (only visible in edit mode) */}
                                                                {isEditMode && (
                                                                    <input
                                                                        type="checkbox"
                                                                        checked={selectedItems.archivedDashers.has(dasher.id)}
                                                                        onChange={(e) => {
                                                                            e.stopPropagation();
                                                                            toggleItemSelection('archivedDashers', dasher.id);
                                                                        }}
                                                                        onClick={(e) => e.stopPropagation()}
                                                                        className="w-4 h-4 text-blue-600 bg-gray-700 border-gray-500 rounded focus:ring-blue-500 focus:ring-2"
                                                                    />
                                                                )}
                                                                <button
                                                                    onClick={() => toggleArchivedDasherCollapse(dasher.id)}
                                                                    className="flex items-center gap-2 flex-1 text-left"
                                                                >
                                                                    {isCollapsed ? <ChevronDown size={14} /> : <ChevronUp size={14} />}
                                                                    <div className="flex-1">
                                                                        <h5 className="font-medium text-purple-300 text-sm flex items-center gap-2">
                                                                            {dasherTitle}
                                                                            {dasher.lastUsed && (
                                                                                <button
                                                                                    onClick={(e) => {
                                                                                        e.stopPropagation();
                                                                                        resetDasherLastUsed('archived', dasher.id);
                                                                                    }}
                                                                                    className="text-orange-400 hover:text-orange-300 p-0.5"
                                                                                    title="Reset timer"
                                                                                    style={{ display: timeStatus.showResetButton ? 'inline-flex' : 'none' }}
                                                                                >
                                                                                    <TimerOff size={12} />
                                                                                </button>
                                                                            )}
                                                                        </h5>
                                                                        <p className="text-xs text-amber-400/70 mt-1">
                                                                            Archived: {formattedArchiveDate}
                                                                        </p>
                                                                    </div>
                                                                </button>
                                                            </div>
                                                            <div className="flex items-center gap-2">
                                                                {/* Category Movement Group */}
                                                                <div className="flex items-center gap-1 pr-2 border-r border-gray-600">
                                                                    <button
                                                                        onClick={() => unarchiveDasher(dasher.id)}
                                                                        className="icon-btn text-blue-400 hover:text-blue-300"
                                                                        title="Unarchive"
                                                                    >
                                                                        <ArchiveRestore size={14} />
                                                                    </button>
                                                                    <button
                                                                        onClick={() => {
                                                                            const updated = archivedDashers.filter(d => d.id !== dasher.id);
                                                                            setArchivedDashers(updated);
                                                                            const moved = {...dasher, ready: true, readyAt: new Date().toISOString()};
                                                                            delete moved.archived;
                                                                            delete moved.archivedAt;
                                                                            setReadyDashers([moved, ...readyDashers]);
                                                                            setTimeout(saveAllToLocalStorage, 100);
                                                                        }}
                                                                        className="icon-btn text-green-400 hover:text-green-300"
                                                                        title="Move to Ready"
                                                                    >
                                                                        <CircleCheck size={14} />
                                                                    </button>
                                                                    <button
                                                                        onClick={() => {
                                                                            const updated = archivedDashers.filter(d => d.id !== dasher.id);
                                                                            setArchivedDashers(updated);
                                                                            const moved = {...dasher, currentlyUsing: true, currentlyUsingAt: new Date().toISOString()};
                                                                            delete moved.archived;
                                                                            delete moved.archivedAt;
                                                                            setCurrentlyUsingDashers([moved, ...currentlyUsingDashers]);
                                                                            setTimeout(saveAllToLocalStorage, 100);
                                                                        }}
                                                                        className="icon-btn text-blue-400 hover:text-blue-300"
                                                                        title="Move to Using"
                                                                    >
                                                                        <Activity size={14} />
                                                                    </button>
                                                                    <button
                                                                        onClick={() => {
                                                                            const updated = archivedDashers.filter(d => d.id !== dasher.id);
                                                                            setArchivedDashers(updated);
                                                                            const moved = {...dasher, appealed: true, appealedAt: new Date().toISOString()};
                                                                            delete moved.archived;
                                                                            delete moved.archivedAt;
                                                                            setAppealedDashers([moved, ...appealedDashers]);
                                                                            setTimeout(saveAllToLocalStorage, 100);
                                                                        }}
                                                                        className="icon-btn text-amber-400 hover:text-amber-300"
                                                                        title="Move to Appealed"
                                                                    >
                                                                        <CircleCheck size={14} />
                                                                    </button>
                                                                </div>

                                                                {/* Control Buttons Group */}
                                                                <div className="flex items-center gap-1">
                                                                    <button
                                                                        onClick={() => {
                                                                            const updated = archivedDashers.map(d => d.id === dasher.id ? {...d, lastUsed: new Date().toISOString()} : d);
                                                                            setArchivedDashers(updated);
                                                                            setTimeout(saveAllToLocalStorage, 100);
                                                                        }}
                                                                        className="icon-btn text-purple-400 hover:text-purple-300"
                                                                        title="Start Timer"
                                                                    >
                                                                        <Timer size={14} />
                                                                    </button>
                                                                    <button
                                                                        onClick={() => {
                                                                            const updated = archivedDashers.filter(d => d.id !== dasher.id);
                                                                            setArchivedDashers(updated);
                                                                            const moved = {...dasher, deactivated: true, deactivatedAt: new Date().toISOString()};
                                                                            delete moved.archived;
                                                                            delete moved.archivedAt;
                                                                            setDeactivatedDashers([moved, ...deactivatedDashers]);
                                                                            setTimeout(saveAllToLocalStorage, 100);
                                                                        }}
                                                                        className="icon-btn text-red-400 hover:text-red-300"
                                                                        title="Deactivate"
                                                                    >
                                                                        <UserX size={14} />
                                                                    </button>
                                                                    <button
                                                                        onClick={() => {
                                                                            setArchivedDashers(archivedDashers.filter(d => d.id !== dasher.id));
                                                                            setTimeout(saveAllToLocalStorage, 100);
                                                                        }}
                                                                        className="icon-btn text-red-400 hover:text-red-300"
                                                                        title="Delete"
                                                                    >
                                                                        <Trash2 size={14} />
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        {/* Dasher Details - Expandable */}
                                                        {!isCollapsed && (
                                                            <div className="space-y-2 p-3 pt-0 border-t border-gray-600/30">
                                                            {/* Name */}
                                                            <div className="flex items-center gap-2">
                                                                <label className="text-xs text-gray-400 w-20">Name:</label>
                                                                <div className="flex-1 text-xs text-gray-200">
                                                                    {dasher.name || <span className="italic text-gray-500">No name</span>}
                                                                </div>
                                                                {dasher.name && (
                                                                    <button
                                                                        onClick={() => copyToClipboard(dasher.name)}
                                                                        className="text-blue-400 hover:text-blue-300 p-1"
                                                                        title="Copy name"
                                                                    >
                                                                        <Copy size={12} />
                                                                    </button>
                                                                )}
                                                            </div>

                                                            {/* Email */}
                                                            <div className="flex items-center gap-2">
                                                                <label className="text-xs text-gray-400 w-20">Email:</label>
                                                                <div className="flex-1 text-xs text-blue-300">
                                                                    {dasher.email || <span className="italic text-gray-500">No email</span>}
                                                                </div>
                                                                {dasher.email && (
                                                                    <button
                                                                        onClick={() => copyToClipboard(dasher.email)}
                                                                        className="text-blue-400 hover:text-blue-300 p-1"
                                                                        title="Copy email"
                                                                    >
                                                                        <Copy size={12} />
                                                                    </button>
                                                                )}
                                                            </div>

                                                            {/* Email Password */}
                                                            <div className="flex items-center gap-2">
                                                                <label className="text-xs text-gray-400 w-20">Email PW:</label>
                                                                <div className="flex-1 text-xs text-gray-200 font-mono">
                                                                    {dasher.emailPw || <span className="italic text-gray-500">No password</span>}
                                                                </div>
                                                                {dasher.emailPw && (
                                                                    <button
                                                                        onClick={() => copyToClipboard(dasher.emailPw)}
                                                                        className="text-blue-400 hover:text-blue-300 p-1"
                                                                        title="Copy email password"
                                                                    >
                                                                        <Copy size={12} />
                                                                    </button>
                                                                )}
                                                            </div>

                                                            {/* Dasher Password */}
                                                            <div className="flex items-center gap-2">
                                                                <label className="text-xs text-gray-400 w-20">Dasher PW:</label>
                                                                <div className="flex-1 text-xs text-gray-200 font-mono">
                                                                    {dasher.dasherPw || <span className="italic text-gray-500">No password</span>}
                                                                </div>
                                                                {dasher.dasherPw && (
                                                                    <button
                                                                        onClick={() => copyToClipboard(dasher.dasherPw)}
                                                                        className="text-blue-400 hover:text-blue-300 p-1"
                                                                        title="Copy dasher password"
                                                                    >
                                                                        <Copy size={12} />
                                                                    </button>
                                                                )}
                                                            </div>

                                                            {/* Phone */}
                                                            <div className="flex items-center gap-2">
                                                                <label className="text-xs text-gray-400 w-20">Phone:</label>
                                                                <div className="flex-1 text-xs text-gray-200">
                                                                    {dasher.phone || <span className="italic text-gray-500">No phone</span>}
                                                                </div>
                                                                {dasher.phone && (
                                                                    <button
                                                                        onClick={() => copyToClipboard(dasher.phone)}
                                                                        className="text-blue-400 hover:text-blue-300 p-1"
                                                                        title="Copy phone"
                                                                    >
                                                                        <Copy size={12} />
                                                                    </button>
                                                                )}
                                                            </div>

                                                            {/* Balance */}
                                                            <div className="flex items-center gap-2">
                                                                <label className="text-xs text-gray-400 w-20">Balance:</label>
                                                                <div className={`flex-1 text-xs font-medium ${dasher.balance && parseFloat(dasher.balance.replace(/[$,]/g, '')) !== 0 ? 'text-red-500' : 'text-green-400'}`}>
                                                                    ${dasher.balance || '0.00'}
                                                                </div>
                                                                {dasher.balance && (
                                                                    <button
                                                                        onClick={() => copyToClipboard(dasher.balance)}
                                                                        className="text-blue-400 hover:text-blue-300 p-1"
                                                                        title="Copy balance"
                                                                    >
                                                                        <Copy size={12} />
                                                                    </button>
                                                                )}
                                                            </div>

                                                            {/* Crimson and Red Card Status */}
                                                            <div className="flex items-center gap-4">
                                                                <div className="flex items-center gap-2">
                                                                    <input
                                                                        type="checkbox"
                                                                        checked={dasher.crimson || false}
                                                                        readOnly
                                                                        className="w-3.5 h-3.5 text-red-500 bg-gray-700 border-gray-600 rounded focus:ring-red-500 focus:ring-1"
                                                                    />
                                                                    <label className="text-xs text-gray-400">Crimson</label>
                                                                </div>
                                                                <div className="flex items-center gap-2">
                                                                    <input
                                                                        type="checkbox"
                                                                        checked={dasher.redCard || false}
                                                                        readOnly
                                                                        className="w-3.5 h-3.5 text-red-600 bg-gray-700 border-gray-600 rounded focus:ring-red-600 focus:ring-1"
                                                                    />
                                                                    <label className="text-xs text-gray-400">Red Card</label>
                                                                </div>
                                                                <div className="flex items-center gap-2">
                                                                    <input
                                                                        type="checkbox"
                                                                        checked={dasher.appealed || false}
                                                                        readOnly
                                                                        className="w-3.5 h-3.5 text-yellow-500 bg-gray-700 border-gray-600 rounded focus:ring-yellow-500 focus:ring-1"
                                                                    />
                                                                    <label className="text-xs text-gray-400">Appealed</label>
                                                                </div>
                                                            </div>

                                                            {/* Appealed Timer for Archived Dashers */}
                                                            {dasher.appealed && dasher.appealedAt && (
                                                                <div className="flex items-center gap-2 mt-1">
                                                                    <label className="text-xs text-gray-400 w-20">Appealed at:</label>
                                                                    <div className="flex-1 text-xs">
                                                                        {(() => {
                                                                            const appealedStatus = calculateAppealedTimeStatus(dasher.appealedAt);
                                                                            return appealedStatus ? (
                                                                                <span className={appealedStatus.color} title={appealedStatus.fullDate}>
                                                                                    {appealedStatus.text}
                                                                                </span>
                                                                            ) : (
                                                                                <span className="text-gray-400">Not tracked</span>
                                                                            );
                                                                        })()}
                                                                    </div>
                                                                </div>
                                                            )}

                                                            {/* Last Used Timer */}
                                                            <div className="flex items-center gap-2">
                                                                <label className="text-xs text-gray-400 w-20">Last Used:</label>
                                                                <div className="flex-1">
                                                                    {dasher.lastUsed ? (
                                                                        timeStatus.isActive ? (
                                                                            <span className={`text-xs font-mono ${timeStatus.color}`}>
                                                                                {timeStatus.display}
                                                                            </span>
                                                                        ) : (
                                                                            <span className="text-xs text-gray-500">
                                                                                {timeStatus.fullDateTime}
                                                                            </span>
                                                                        )
                                                                    ) : (
                                                                        <span className="italic text-gray-500 text-xs">Timer not started</span>
                                                                    )}
                                                                </div>
                                                            </div>

                                                            {/* Notes - Expandable */}
                                                            <div className="flex items-start gap-2">
                                                                <label className="text-xs text-gray-400 w-20 mt-1">Notes:</label>
                                                                <div className="flex-1 text-xs text-gray-200 whitespace-pre-wrap">
                                                                    {dasher.notes || <span className="italic text-gray-500">No notes</span>}
                                                                </div>
                                                                {dasher.notes && (
                                                                    <button
                                                                        onClick={() => copyToClipboard(dasher.notes)}
                                                                        className="text-blue-400 hover:text-blue-300 p-1 self-start"
                                                                        title="Copy notes"
                                                                    >
                                                                        <Copy size={12} />
                                                                    </button>
                                                                )}
                                                            </div>
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })
                                        )}
                                    </div>
                                )}
                            </div>

                            {/* ========== ANALYTICS & DATA SECTION ========== */}
                            <div className="flex items-center gap-3 my-8">
                                <div className="flex-1 h-px bg-gradient-to-r from-transparent via-gray-700 to-transparent opacity-50"></div>
                                <span className="text-xs uppercase tracking-wider text-gray-500 font-medium">Analytics & Data</span>
                                <div className="flex-1 h-px bg-gradient-to-r from-transparent via-gray-700 to-transparent opacity-50"></div>
                            </div>

                            {/* Statistics Section */}
                            <div className="bg-gray-800 rounded-lg overflow-hidden">
                                <button
                                    onClick={() => setIsStatisticsOpen(!isStatisticsOpen)}
                                    className="w-full flex items-center justify-between p-4 text-left hover:bg-gray-700/50 transition-colors"
                                >
                                    <div className="flex items-center gap-3">
                                        <BarChart3 size={20} className="text-cyan-400" />
                                        <span className="text-lg font-medium">Statistics</span>
                                    </div>
                                    {isStatisticsOpen ? <ChevronUp size={20} /> : <ChevronDown size={20} />}
                                </button>

                                {isStatisticsOpen && (
                                    <div className="border-t border-gray-700 p-4 space-y-4">
                                        {/* Dasher Count Statistics */}
                                        <div className="bg-gray-700/40 rounded-lg p-3 space-y-2">
                                            <h4 className="text-sm font-medium text-cyan-300 mb-2">Dashers per Category</h4>
                                            {dasherCategories.map((category) => (
                                                <div key={category.id} className="flex justify-between items-center text-xs">
                                                    <span className="text-gray-400">{category.name}:</span>
                                                    <span className="text-gray-200 font-medium">{category.dashers.length} dashers</span>
                                                </div>
                                            ))}
                                            <div className="border-t border-gray-600 pt-2 mt-2">
                                                <div className="flex justify-between items-center text-sm font-medium">
                                                    <span className="text-cyan-300">Total Dashers:</span>
                                                    <span className="text-cyan-200">
                                                        {dasherCategories.reduce((total, cat) => total + cat.dashers.length, 0)}
                                                    </span>
                                                </div>
                                                {(() => {
                                                    const all = dasherCategories.flatMap(c => c.dashers);
                                                    if (all.length === 0) return null;
                                                    const ready = all.filter(d => d.ready).length;
                                                    const crimson = all.filter(d => d.crimson).length;
                                                    const red = all.filter(d => d.redCard).length;
                                                    const appealed = all.filter(d => d.appealed).length;
                                                    return (
                                                        <div className="mt-2 grid grid-cols-2 gap-y-1 gap-x-4 text-[11px] text-gray-300">
                                                            <div><span className="text-gray-500">Ready:</span> {ready}</div>
                                                            <div><span className="text-gray-500">Crimson:</span> {crimson}</div>
                                                            <div><span className="text-gray-500">Red Card:</span> {red}</div>
                                                            <div><span className="text-gray-500">Appealed:</span> {appealed}</div>
                                                        </div>
                                                    );
                                                })()}
                                            </div>
                                        </div>

                                        {/* Balance Statistics */}
                                        <div className="bg-gray-700/40 rounded-lg p-3 space-y-2">
                                            <h4 className="text-sm font-medium text-cyan-300 mb-2">Balance Breakdown</h4>
                                            {(() => {
                                                let totalWithCrimson = 0;
                                                let totalWithoutCrimson = 0;
                                                let totalWithRedCard = 0;
                                                let countWithCrimson = 0;
                                                let countWithoutCrimson = 0;
                                                let countWithRedCard = 0;

                                                dasherCategories.forEach(category => {
                                                    category.dashers.forEach(dasher => {
                                                        // Parse balance (remove $ and commas, convert to number)
                                                        const balanceStr = dasher.balance || '$0.00';
                                                        const balanceNum = parseFloat(balanceStr.replace(/[$,]/g, '')) || 0;

                                                        if (dasher.crimson) {
                                                            totalWithCrimson += balanceNum;
                                                            countWithCrimson++;
                                                        } else {
                                                            totalWithoutCrimson += balanceNum;
                                                            countWithoutCrimson++;
                                                        }

                                                        if (dasher.redCard) {
                                                            totalWithRedCard += balanceNum;
                                                            countWithRedCard++;
                                                        }
                                                    });
                                                });

                                                const totalBalance = totalWithCrimson + totalWithoutCrimson;

                                                return (
                                                    <>
                                                        <div className="flex justify-between items-center text-xs">
                                                            <span className="text-gray-400">With Crimson ({countWithCrimson}):</span>
                                                            <span className={`font-medium ${totalWithCrimson > 0 ? 'text-red-400' : 'text-green-400'}`}>
                                                                ${totalWithCrimson.toFixed(2)}
                                                            </span>
                                                        </div>
                                                        <div className="flex justify-between items-center text-xs">
                                                            <span className="text-gray-400">Without Crimson ({countWithoutCrimson}):</span>
                                                            <span className={`font-medium ${totalWithoutCrimson > 0 ? 'text-red-400' : 'text-green-400'}`}>
                                                                ${totalWithoutCrimson.toFixed(2)}
                                                            </span>
                                                        </div>
                                                        <div className="flex justify-between items-center text-xs">
                                                            <span className="text-gray-400">With Red Card ({countWithRedCard}):</span>
                                                            <span className={`font-medium ${totalWithRedCard > 0 ? 'text-red-400' : 'text-green-400'}`}>
                                                                ${totalWithRedCard.toFixed(2)}
                                                            </span>
                                                        </div>
                                                        <div className="border-t border-gray-600 pt-2 mt-2">
                                                            <div className="flex justify-between items-center text-sm font-medium">
                                                                <span className="text-cyan-300">Total Balance:</span>
                                                                <span className={totalBalance > 0 ? 'text-red-400' : 'text-green-400'}>
                                                                    ${totalBalance.toFixed(2)}
                                                                </span>
                                                            </div>
                                                        </div>
                                                    </>
                                                );
                                            })()}
                                        </div>

                                        {/* Category Balance Details */}
                                        <div className="bg-gray-700/40 rounded-lg p-3 space-y-2">
                                            <h4 className="text-sm font-medium text-cyan-300 mb-2">Balance by Category</h4>
                                            {dasherCategories.map((category) => {
                                                const categoryBalance = category.dashers.reduce((sum, dasher) => {
                                                    const balanceStr = dasher.balance || '$0.00';
                                                    const balanceNum = parseFloat(balanceStr.replace(/[$,]/g, '')) || 0;
                                                    return sum + balanceNum;
                                                }, 0);

                                                const crimsonCount = category.dashers.filter(d => d.crimson).length;
                                                const redCardCount = category.dashers.filter(d => d.redCard).length;
                                                const nonCrimsonCount = category.dashers.length - crimsonCount;

                                                return (
                                                    <div key={category.id} className="space-y-1">
                                                        <div className="flex justify-between items-center text-xs">
                                                            <span className="text-gray-400">{category.name}:</span>
                                                            <span className={`font-medium ${categoryBalance > 0 ? 'text-red-400' : 'text-green-400'}`}>
                                                                ${categoryBalance.toFixed(2)}
                                                            </span>
                                                        </div>
                                                        {category.dashers.length > 0 && (
                                                            <div className="text-xs text-gray-500 pl-4">
                                                                {crimsonCount > 0 && <span className="text-red-500">{crimsonCount} crimson</span>}
                                                                {crimsonCount > 0 && redCardCount > 0 && <span className="text-gray-600"> / </span>}
                                                                {redCardCount > 0 && <span className="text-red-600">{redCardCount} red card</span>}
                                                                {(crimsonCount > 0 || redCardCount > 0) && nonCrimsonCount > 0 && <span className="text-gray-600"> / </span>}
                                                                {nonCrimsonCount > 0 && <span className="text-gray-400">{nonCrimsonCount} regular</span>}
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* State Management Section */}
                            <div className="bg-gray-800 rounded-lg overflow-hidden">
                                <button
                                    onClick={() => setIsStateManagementOpen(!isStateManagementOpen)}
                                    className="w-full flex items-center justify-between p-4 text-left hover:bg-gray-700/50 transition-colors"
                                >
                                    <div className="flex items-center gap-3">
                                        <Settings size={20} className="text-purple-400" />
                                        <span className="text-lg font-medium">State Management <span className="text-sm text-gray-400 ml-2">v1.5.0</span></span>
                                    </div>
                                    {isStateManagementOpen ? <ChevronUp size={20} /> : <ChevronDown size={20} />}
                                </button>

                                {isStateManagementOpen && (
                                    <div className="border-t border-gray-700 p-4">
                                        <div className="grid grid-cols-2 lg:grid-cols-4 gap-3">
                                            {/* Save All Button */}
                                            <button
                                                onClick={saveAllToLocalStorage}
                                                className="bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg transition-colors flex items-center justify-center gap-2"
                                            >
                                                <Save size={18} />
                                                <span className="text-sm font-medium">Save All</span>
                                            </button>

                                            {/* Load from LocalStorage */}
                                            <button
                                                onClick={loadFromLocalStorage}
                                                className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg transition-colors flex items-center justify-center gap-2"
                                            >
                                                <RefreshCw size={18} />
                                                <span className="text-sm font-medium">Load Saved</span>
                                            </button>

                                            {/* Export to JSON */}
                                            <button
                                                onClick={exportToJSON}
                                                className="bg-purple-600 hover:bg-purple-700 text-white px-4 py-3 rounded-lg transition-colors flex items-center justify-center gap-2"
                                            >
                                                <Download size={18} />
                                                <span className="text-sm font-medium">Export JSON</span>
                                            </button>

                                            {/* Import from JSON */}
                                            <label className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-3 rounded-lg transition-colors flex items-center justify-center gap-2 cursor-pointer">
                                                <Upload size={18} />
                                                <span className="text-sm font-medium">Import JSON</span>
                                                <input
                                                    type="file"
                                                    accept="application/json"
                                                    onChange={importFromJSON}
                                                    className="hidden"
                                                />
                                            </label>

                                            {/* Clear All Data */}
                                            <button
                                                onClick={clearAllData}
                                                className="bg-red-600 hover:bg-red-700 text-white px-4 py-3 rounded-lg transition-colors flex items-center justify-center gap-2"
                                            >
                                                <Trash2 size={18} />
                                                <span className="text-sm font-medium">Clear All</span>
                                            </button>

                                            {/* Edit Mode Toggle */}
                                            <button
                                                onClick={() => {
                                                    setIsEditMode(!isEditMode);
                                                    if (isEditMode) {
                                                        clearAllSelections();
                                                    }
                                                }}
                                                className={`${isEditMode ? 'bg-orange-600 hover:bg-orange-700' : 'bg-gray-600 hover:bg-gray-700'} text-white px-4 py-3 rounded-lg transition-colors flex items-center justify-center gap-2 col-span-2 lg:col-span-1`}
                                            >
                                                <CheckSquare size={18} />
                                                <span className="text-sm font-medium">{isEditMode ? 'Exit Edit Mode' : 'Edit Mode'}</span>
                                            </button>
                                        </div>

                                        {/* Selection Toolbar - appears when in edit mode */}
                                        {isEditMode && (
                                            <div className="mt-4 p-3 bg-orange-600/20 border border-orange-600/30 rounded-lg">
                                                <div className="flex items-center justify-between mb-3">
                                                    <div className="text-sm text-gray-300">
                                                        <strong>{getSelectionCount()}</strong> items selected
                                                    </div>
                                                    <div className="flex gap-2">
                                                        <button
                                                            onClick={clearAllSelections}
                                                            className="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm transition-colors"
                                                        >
                                                            Clear Selection
                                                        </button>
                                                        <button
                                                            onClick={exportSelected}
                                                            disabled={getSelectionCount() === 0}
                                                            className="bg-purple-600 hover:bg-purple-700 disabled:bg-gray-600 disabled:opacity-50 text-white px-3 py-1 rounded text-sm transition-colors flex items-center gap-1"
                                                        >
                                                            <Download size={14} />
                                                            Export Selected
                                                        </button>
                                                    </div>
                                                </div>
                                                <div className="text-xs text-gray-400">
                                                    Select individual items or entire categories to export. Check the boxes next to items you want to include.
                                                </div>
                                            </div>
                                        )}

                                        {/* Instructions */}
                                        <div className="mt-4 p-3 bg-gray-700/50 rounded-lg">
                                            <h4 className="text-sm font-medium text-gray-300 mb-2">Instructions:</h4>
                                            <ul className="text-xs text-gray-400 space-y-1">
                                                <li>• <strong>Auto-Save:</strong> All changes are saved automatically</li>
                                                <li>• <strong>Load Saved:</strong> Restores previously saved data from browser storage</li>
                                                <li>• <strong>Export JSON:</strong> Downloads all data as a JSON file for backup</li>
                                                <li>• <strong>Import JSON:</strong> Loads data from a previously exported JSON file</li>
                                                <li>• <strong>Clear All:</strong> Resets everything to default values</li>
                                                <li>• <strong>Edit Mode:</strong> Select specific items to export and share with others</li>
                                            </ul>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Render the React component
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(EnhancedCalculator));
    </script>
</body>
</html>
