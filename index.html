<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dash Bash Utility</title>

    <!-- Version 1.9.5 - Web Worker JSON parsing + import gates (console flood fix) -->
    <meta name="app-version" content="1.9.5" />

    <!-- Cache Control Headers -->
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <link rel="icon" type="image/svg+xml" href="favicon.svg?v=1.9.5" />
    <link
      rel="alternate icon"
      href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Ccircle cx='16' cy='16' r='15' fill='%231f2937'/%3E%3Ctext x='16' y='22' font-family='Arial, sans-serif' font-size='18' font-weight='bold' text-anchor='middle' fill='%23fbbf24'%3E$%3C/text%3E%3Crect x='6' y='8' width='6' height='2' fill='%2360a5fa' opacity='0.8'/%3E%3Crect x='20' y='8' width='6' height='2' fill='%2360a5fa' opacity='0.8'/%3E%3Crect x='6' y='22' width='6' height='2' fill='%23a78bfa' opacity='0.8'/%3E%3Crect x='20' y='22' width='6' height='2' fill='%23a78bfa' opacity='0.8'/%3E%3C/svg%3E"
    />
    <meta
      name="description"
      content="Target Calculator & Address Book Utility with Dashers Management"
    />
    <meta name="theme-color" content="#111827" />

    <!-- PWA Support -->
    <link rel="manifest" href="manifest.json?v=1.9.5" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="mobile-web-app-capable" content="yes" />

    <!-- React and Dependencies - Local vendor builds for GitHub Pages compatibility -->
    <!-- BUILD STAMP: injected at 2025-09-30T08:05Z for version 1.4.3 (badge wiring, flag badges + icon-btn) -->
    <script crossorigin src="./vendor/react.production.min.js"></script>
    <script crossorigin src="./vendor/react-dom.production.min.js"></script>
    <!-- react-window for virtualization (PERF-STAGE6) - Local vendor build -->
    <script src="./vendor/react-window.js"></script>
    <!-- react-window compatibility adapter (maps List to FixedSizeList) -->
    <script src="./vendor/react-window-adapter.js"></script>

    <!-- Tailwind CSS - Local build (MUST load first to allow custom styles to override) -->
    <link rel="stylesheet" href="./tailwind.css?v=1.9.5" />

    <!-- Google Fonts - Modern Sans-Serif -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />

    <!-- External Stylesheets (MUST load after Tailwind to override defaults) -->
    <link rel="stylesheet" href="styles.css?v=1.9.5" />

    <!-- Lucide Icons - Local vendor build -->
    <script src="./vendor/lucide.min.js"></script>
  </head>
  <body class="theme-jp" data-style-version="1.4.3">
    <div id="root"></div>

    <!-- Service Worker Registration with Version Check -->
    <script>
      console.log(
        "%cDash Bash Utility build 1.9.5 (Import performance fix) loaded",
        "background:#222;color:#f39ac5;padding:4px 8px;border-radius:4px",
      );
      const APP_VERSION = "1.9.5"; // Web Worker JSON parsing + import gates
      const versionState = {
        registration: null,
        banner: null,
        lastSeenVersion: null,
        lastMismatchAt: null,
      };
      const ensureVersionBanner = (message, { tone = "warn" } = {}) => {
        const bg = tone === "error" ? "#dc2626" : "#f97316";
        const fg = "#ffffff";
        if (!versionState.banner) {
          const wrapper = document.createElement("div");
          wrapper.id = "version-mismatch-banner";
          wrapper.setAttribute("role", "alert");
          wrapper.setAttribute("aria-live", "assertive");
          wrapper.style.position = "fixed";
          wrapper.style.top = "16px";
          wrapper.style.left = "50%";
          wrapper.style.transform = "translateX(-50%)";
          wrapper.style.zIndex = "10000";
          wrapper.style.padding = "12px 18px";
          wrapper.style.borderRadius = "10px";
          wrapper.style.boxShadow = "0 10px 30px rgba(0,0,0,0.35)";
          wrapper.style.display = "flex";
          wrapper.style.flexWrap = "wrap";
          wrapper.style.alignItems = "center";
          wrapper.style.gap = "12px";

          const text = document.createElement("span");
          text.id = "version-mismatch-text";
          text.style.fontWeight = "600";
          text.style.fontSize = "15px";
          wrapper.appendChild(text);

          const reloadBtn = document.createElement("button");
          reloadBtn.type = "button";
          reloadBtn.textContent = "Reload now";
          reloadBtn.style.background = "#ffffff";
          reloadBtn.style.color = "#111827";
          reloadBtn.style.padding = "8px 14px";
          reloadBtn.style.borderRadius = "6px";
          reloadBtn.style.border = "none";
          reloadBtn.style.cursor = "pointer";
          reloadBtn.style.fontWeight = "600";
          reloadBtn.addEventListener("click", () =>
            window.location.reload(true),
          );
          wrapper.appendChild(reloadBtn);

          const forceBtn = document.createElement("button");
          forceBtn.type = "button";
          forceBtn.textContent = "Force update";
          forceBtn.style.background = "transparent";
          forceBtn.style.border = "1px solid rgba(255,255,255,0.6)";
          forceBtn.style.padding = "8px 14px";
          forceBtn.style.borderRadius = "6px";
          forceBtn.style.cursor = "pointer";
          forceBtn.style.color = fg;
          forceBtn.style.fontWeight = "600";
          forceBtn.addEventListener("click", () => {
            if (versionState.registration?.waiting) {
              versionState.registration.waiting.postMessage({
                type: "SKIP_WAITING",
              });
            }
            navigator.serviceWorker?.controller?.postMessage?.({
              type: "VERSION_CHECK",
              expected: APP_VERSION,
            });
            versionState.registration?.update();
          });
          wrapper.appendChild(forceBtn);

          versionState.banner = wrapper;
          document.body.appendChild(wrapper);
        }
        versionState.banner.style.background = bg;
        versionState.banner.style.color = fg;
        const textEl = versionState.banner.querySelector(
          "#version-mismatch-text",
        );
        if (textEl) textEl.textContent = message;
      };
      const dismissVersionBanner = () => {
        if (versionState.banner && versionState.banner.parentNode) {
          versionState.banner.parentNode.removeChild(versionState.banner);
        }
        versionState.banner = null;
      };
      const requestVersionCheck = (reason = "manual") => {
        if (navigator.serviceWorker?.controller?.postMessage) {
          navigator.serviceWorker.controller.postMessage({
            type: "VERSION_CHECK",
            expected: APP_VERSION,
            reason,
          });
        }
      };
      // Log active stylesheets for debugging theme cascade
      window.addEventListener("load", () => {
        const sheets = [...document.styleSheets].map(
          (s) => s.href && s.href.split("/").pop(),
        );
        console.log("[DashBash] Active stylesheets:", sheets.filter(Boolean));
      });

      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register(`service-worker.js?v=${APP_VERSION}`)
            .then((registration) => {
              versionState.registration = registration;
              console.log(
                "[DashBash] ServiceWorker registered for version",
                APP_VERSION,
              );

              const hourlyUpdate = setInterval(() => {
                registration.update();
                requestVersionCheck("hourly");
              }, 3600000);

              const versionPoll = setInterval(
                () => requestVersionCheck("interval"),
                3600000, // 60 minutes (reduced from 5 min for performance)
              );

              const cleanup = () => {
                clearInterval(hourlyUpdate);
                clearInterval(versionPoll);
              };
              window.addEventListener("beforeunload", cleanup, { once: true });

              registration.addEventListener("updatefound", () => {
                const newWorker = registration.installing;
                if (!newWorker) return;
                newWorker.addEventListener("statechange", () => {
                  if (newWorker.state === "installed") {
                    if (navigator.serviceWorker.controller) {
                      console.log(
                        "[DashBash] New service worker installed - awaiting activation",
                      );
                      ensureVersionBanner(
                        "A new update is ready. Reload to finish applying it.",
                        { tone: "warn" },
                      );
                      if (registration.waiting) {
                        registration.waiting.postMessage({
                          type: "SKIP_WAITING",
                        });
                      }
                    } else {
                      console.log(
                        "[DashBash] Service worker installed for first load",
                      );
                      requestVersionCheck("post-install");
                    }
                  }
                });
              });

              registration.update();
              requestVersionCheck("post-register");
            })
            .catch((err) =>
              console.log("ServiceWorker registration failed:", err),
            );
        });

        navigator.serviceWorker.addEventListener("message", (event) => {
          const data = event.data || {};
          if (data.type === "VERSION_INFO") {
            versionState.lastSeenVersion = data.version;
            console.log("[DashBash] Service worker version info", data);
            if (data.version !== APP_VERSION) {
              versionState.lastMismatchAt = Date.now();
              ensureVersionBanner(
                `App shell expects ${APP_VERSION} but worker is ${data.version}. Reload to apply the latest fixes.`,
                { tone: "error" },
              );
              versionState.registration?.update();
            } else {
              dismissVersionBanner();
            }
          }
        });

        let refreshing = false;
        navigator.serviceWorker.addEventListener("controllerchange", () => {
          if (!refreshing) {
            refreshing = true;
            dismissVersionBanner();
            window.location.reload(true);
          }
        });

        navigator.serviceWorker.ready.then(() => requestVersionCheck("ready"));
      }

      // Removed visibilitychange listener - redundant with focus event
      // Keep focus event for responsive updates when user returns to app
      window.addEventListener("focus", () => requestVersionCheck("focus"));
    </script>

    <script src="dash-bash-compiled.js?v=1.9.5"></script>
  </body>
</html>
