<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automated Data Persistence Test Suite - Dash Bash Utility</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #0f0f1e);
            color: #e0e0e0;
            padding: 20px;
            margin: 0;
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            color: #4fc3f7;
            margin-bottom: 30px;
            text-shadow: 0 0 10px rgba(79, 195, 247, 0.5);
        }
        .test-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .test-section {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(79, 195, 247, 0.3);
            border-radius: 10px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }
        .test-section h2 {
            color: #81c784;
            margin-top: 0;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            animation: pulse 2s infinite;
        }
        .status-pending {
            background: #757575;
        }
        .status-running {
            background: #ffa726;
            animation: pulse 1s infinite;
        }
        .status-success {
            background: #66bb6a;
        }
        .status-failed {
            background: #ef5350;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(0.9); }
        }
        .test-item {
            padding: 10px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.03);
            border-left: 3px solid #424242;
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        .test-item.success {
            border-left-color: #66bb6a;
            background: rgba(102, 187, 106, 0.1);
        }
        .test-item.failed {
            border-left-color: #ef5350;
            background: rgba(239, 83, 80, 0.1);
        }
        .test-item.running {
            border-left-color: #ffa726;
            background: rgba(255, 167, 38, 0.1);
        }
        .control-panel {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }
        button {
            background: linear-gradient(135deg, #4fc3f7, #29b6f6);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            margin: 0 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(79, 195, 247, 0.3);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(79, 195, 247, 0.5);
        }
        button:active {
            transform: translateY(0);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .results-panel {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
        }
        .result-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .result-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .result-card h3 {
            margin: 0 0 10px 0;
            color: #81c784;
            font-size: 14px;
        }
        .result-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #4fc3f7;
        }
        .log-panel {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(79, 195, 247, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px 5px;
        }
        .log-success {
            color: #66bb6a;
        }
        .log-error {
            color: #ef5350;
        }
        .log-info {
            color: #29b6f6;
        }
        .progress-bar {
            width: 100%;
            height: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4fc3f7, #66bb6a);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Automated Data Persistence Test Suite</h1>
        
        <div class="control-panel">
            <h2>Test Controls</h2>
            <button onclick="runAllTests()">‚ñ∂ Run All Tests</button>
            <button onclick="runQuickTest()">‚ö° Quick Test</button>
            <button onclick="runStressTest()">üí™ Stress Test</button>
            <button onclick="clearResults()">üóëÔ∏è Clear Results</button>
            <button onclick="exportTestReport()">üìä Export Report</button>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progressBar">0%</div>
        </div>

        <div class="test-grid">
            <div class="test-section">
                <h2><span class="status-indicator status-pending" id="saveStatus"></span> Save Tests</h2>
                <div id="saveTests"></div>
            </div>
            <div class="test-section">
                <h2><span class="status-indicator status-pending" id="loadStatus"></span> Load Tests</h2>
                <div id="loadTests"></div>
            </div>
            <div class="test-section">
                <h2><span class="status-indicator status-pending" id="exportStatus"></span> Export Tests</h2>
                <div id="exportTests"></div>
            </div>
            <div class="test-section">
                <h2><span class="status-indicator status-pending" id="importStatus"></span> Import Tests</h2>
                <div id="importTests"></div>
            </div>
        </div>

        <div class="results-panel">
            <h2>üìä Test Results Summary</h2>
            <div class="result-summary">
                <div class="result-card">
                    <h3>Total Tests</h3>
                    <div class="value" id="totalTests">0</div>
                </div>
                <div class="result-card">
                    <h3>Passed</h3>
                    <div class="value" id="passedTests" style="color: #66bb6a;">0</div>
                </div>
                <div class="result-card">
                    <h3>Failed</h3>
                    <div class="value" id="failedTests" style="color: #ef5350;">0</div>
                </div>
                <div class="result-card">
                    <h3>Success Rate</h3>
                    <div class="value" id="successRate">0%</div>
                </div>
                <div class="result-card">
                    <h3>Data Integrity</h3>
                    <div class="value" id="dataIntegrity">0%</div>
                </div>
                <div class="result-card">
                    <h3>Test Duration</h3>
                    <div class="value" id="testDuration">0ms</div>
                </div>
            </div>
        </div>

        <div class="log-panel" id="logPanel">
            <div class="log-entry log-info">Test suite initialized. Ready to run tests.</div>
        </div>
    </div>

    <script>
        let testResults = {
            total: 0,
            passed: 0,
            failed: 0,
            startTime: 0,
            endTime: 0
        };

        function log(message, type = 'info') {
            const logPanel = document.getElementById('logPanel');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logPanel.appendChild(entry);
            logPanel.scrollTop = logPanel.scrollHeight;
        }

        function updateProgress(percent) {
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = percent + '%';
            progressBar.textContent = Math.round(percent) + '%';
        }

        function updateStatus(section, status) {
            const element = document.getElementById(section + 'Status');
            element.className = `status-indicator status-${status}`;
        }

        function addTestResult(section, testName, success, details) {
            const container = document.getElementById(section + 'Tests');
            const testItem = document.createElement('div');
            testItem.className = `test-item ${success ? 'success' : 'failed'}`;
            testItem.innerHTML = `
                <strong>${success ? '‚úÖ' : '‚ùå'} ${testName}</strong>
                ${details ? `<div style="margin-top: 5px; font-size: 12px; opacity: 0.8;">${details}</div>` : ''}
            `;
            container.appendChild(testItem);
        }

        function generateTestData() {
            return {
                target: "99",
                targetPreset: "99",
                prices: [2.75, 3.50, 4.25, 5.00, 6.25, 7.50, 8.75, 10.00],
                messages: [
                    "Thank you for your order!",
                    "Your food is on the way.",
                    "I'm at your door.",
                    "Please provide gate code.",
                    "Unable to deliver - no response."
                ],
                categories: [
                    {
                        id: 1,
                        name: "Dollar General",
                        stores: [
                            {
                                id: 1,
                                address: "123 Main St, City, ST 12345",
                                openTime: "0800",
                                closeTime: "2200",
                                notes: "Next to Walmart"
                            },
                            {
                                id: 2,
                                address: "456 Oak Ave, Town, ST 54321",
                                openTime: "0700",
                                closeTime: "2300",
                                notes: "Has pharmacy"
                            }
                        ]
                    },
                    {
                        id: 2,
                        name: "CVS",
                        stores: [
                            {
                                id: 3,
                                address: "789 Pine Rd, Village, ST 67890",
                                openTime: "0000",
                                closeTime: "2359",
                                notes: "24 hours"
                            }
                        ]
                    }
                ],
                noteCategories: [
                    {
                        id: "cat1",
                        name: "Delivery Notes",
                        notes: [
                            "Always check for drinks",
                            "Verify address before leaving",
                            "Take photo of delivery"
                        ]
                    },
                    {
                        id: "cat2",
                        name: "Customer Preferences",
                        notes: [
                            "John - No onions",
                            "Sarah - Extra napkins",
                            "Mike - Leave at door"
                        ]
                    }
                ],
                dasherCategories: [
                    {
                        id: "main",
                        name: "Main",
                        dashers: [
                            {
                                id: "d1",
                                name: "John Dasher",
                                email: "john@dash.com",
                                lastUsed: new Date().toISOString(),
                                notes: "Primary account"
                            }
                        ]
                    },
                    {
                        id: "ready",
                        name: "Ready",
                        dashers: [
                            {
                                id: "d2",
                                name: "Jane Driver",
                                email: "jane@dash.com",
                                lastUsed: new Date(Date.now() - 25 * 60 * 60 * 1000).toISOString(),
                                notes: "Backup account"
                            },
                            {
                                id: "d3",
                                name: "Bob Delivery",
                                email: "bob@dash.com",
                                lastUsed: new Date(Date.now() - 48 * 60 * 60 * 1000).toISOString(),
                                notes: "Weekend driver"
                            }
                        ]
                    }
                ]
            };
        }

        async function testSaveToLocalStorage() {
            updateStatus('save', 'running');
            log('Starting localStorage save tests...', 'info');
            
            const testData = generateTestData();
            let allPassed = true;

            try {
                localStorage.setItem('dashBashState', JSON.stringify(testData));
                addTestResult('save', 'Save complete state', true, 'All data saved successfully');
                log('‚úì Complete state saved to localStorage', 'success');
            } catch (error) {
                addTestResult('save', 'Save complete state', false, error.message);
                log('‚úó Failed to save state: ' + error.message, 'error');
                allPassed = false;
            }

            // Verify each section
            const saved = JSON.parse(localStorage.getItem('dashBashState'));
            
            const sections = [
                { key: 'prices', name: 'Calculator Prices' },
                { key: 'messages', name: 'Quick Messages' },
                { key: 'categories', name: 'Address Book' },
                { key: 'noteCategories', name: 'Notes' },
                { key: 'dasherCategories', name: 'Dashers' }
            ];

            for (const section of sections) {
                const exists = saved && saved[section.key];
                const hasContent = exists && 
                    (Array.isArray(saved[section.key]) ? saved[section.key].length > 0 : true);
                
                addTestResult('save', section.name, exists && hasContent, 
                    exists ? `${JSON.stringify(saved[section.key]).length} bytes` : 'Missing');
                
                if (exists && hasContent) {
                    log(`‚úì ${section.name} saved correctly`, 'success');
                } else {
                    log(`‚úó ${section.name} not saved properly`, 'error');
                    allPassed = false;
                }
            }

            updateStatus('save', allPassed ? 'success' : 'failed');
            return allPassed;
        }

        async function testLoadFromLocalStorage() {
            updateStatus('load', 'running');
            log('Starting localStorage load tests...', 'info');
            
            let allPassed = true;

            try {
                const loaded = JSON.parse(localStorage.getItem('dashBashState'));
                
                if (!loaded) {
                    addTestResult('load', 'Load state', false, 'No data in localStorage');
                    log('‚úó No data found in localStorage', 'error');
                    updateStatus('load', 'failed');
                    return false;
                }

                addTestResult('load', 'Load complete state', true, 'Data loaded successfully');
                log('‚úì State loaded from localStorage', 'success');

                // Verify data integrity
                const checks = [
                    { test: loaded.target === "99", name: 'Target value' },
                    { test: loaded.prices && loaded.prices.length === 8, name: 'Prices array' },
                    { test: loaded.messages && loaded.messages.length === 5, name: 'Messages' },
                    { test: loaded.categories && loaded.categories.length === 2, name: 'Store categories' },
                    { test: loaded.noteCategories && loaded.noteCategories.length === 2, name: 'Note categories' },
                    { test: loaded.dasherCategories && loaded.dasherCategories.length === 2, name: 'Dasher categories' }
                ];

                for (const check of checks) {
                    addTestResult('load', check.name, check.test, 
                        check.test ? 'Verified' : 'Failed verification');
                    
                    if (check.test) {
                        log(`‚úì ${check.name} verified`, 'success');
                    } else {
                        log(`‚úó ${check.name} verification failed`, 'error');
                        allPassed = false;
                    }
                }

                // Deep verification of nested data
                if (loaded.categories && loaded.categories[0] && loaded.categories[0].stores) {
                    const storeCount = loaded.categories.reduce((sum, cat) => sum + cat.stores.length, 0);
                    addTestResult('load', 'Store details', true, `${storeCount} stores with complete data`);
                    log(`‚úì Found ${storeCount} stores with complete details`, 'success');
                }

                if (loaded.dasherCategories && loaded.dasherCategories[1] && loaded.dasherCategories[1].dashers) {
                    const dasherCount = loaded.dasherCategories.reduce((sum, cat) => sum + cat.dashers.length, 0);
                    addTestResult('load', 'Dasher details', true, `${dasherCount} dashers with timers`);
                    log(`‚úì Found ${dasherCount} dashers with all fields`, 'success');
                }

            } catch (error) {
                addTestResult('load', 'Load state', false, error.message);
                log('‚úó Failed to load: ' + error.message, 'error');
                allPassed = false;
            }

            updateStatus('load', allPassed ? 'success' : 'failed');
            return allPassed;
        }

        async function testExportToJSON() {
            updateStatus('export', 'running');
            log('Starting JSON export tests...', 'info');
            
            let allPassed = true;

            try {
                const data = JSON.parse(localStorage.getItem('dashBashState'));
                const exportData = {
                    ...data,
                    timestamp: new Date().toISOString(),
                    version: "2.0"
                };

                const jsonString = JSON.stringify(exportData, null, 2);
                
                addTestResult('export', 'Generate JSON', true, `${jsonString.length} characters`);
                log(`‚úì JSON generated: ${jsonString.length} characters`, 'success');

                // Verify JSON structure
                const parsed = JSON.parse(jsonString);
                
                const requiredFields = [
                    'target', 'targetPreset', 'prices', 'messages', 
                    'categories', 'noteCategories', 'dasherCategories',
                    'timestamp', 'version'
                ];

                for (const field of requiredFields) {
                    const exists = field in parsed;
                    addTestResult('export', `Export ${field}`, exists, 
                        exists ? 'Present' : 'Missing');
                    
                    if (exists) {
                        log(`‚úì ${field} exported correctly`, 'success');
                    } else {
                        log(`‚úó ${field} missing from export`, 'error');
                        allPassed = false;
                    }
                }

            } catch (error) {
                addTestResult('export', 'Export to JSON', false, error.message);
                log('‚úó Export failed: ' + error.message, 'error');
                allPassed = false;
            }

            updateStatus('export', allPassed ? 'success' : 'failed');
            return allPassed;
        }

        async function testImportFromJSON() {
            updateStatus('import', 'running');
            log('Starting JSON import tests...', 'info');
            
            let allPassed = true;

            try {
                // Create test import data
                const importData = generateTestData();
                importData.timestamp = new Date().toISOString();
                importData.version = "2.0";
                
                // Simulate import
                const jsonString = JSON.stringify(importData);
                const parsed = JSON.parse(jsonString);
                
                // Save imported data
                localStorage.setItem('dashBashState', JSON.stringify(parsed));
                
                addTestResult('import', 'Parse JSON', true, 'Valid JSON structure');
                log('‚úì JSON parsed successfully', 'success');

                // Verify imported data
                const imported = JSON.parse(localStorage.getItem('dashBashState'));
                
                const verifications = [
                    { 
                        test: imported.prices && imported.prices.length === 8,
                        name: 'Price data',
                        detail: `${imported.prices ? imported.prices.length : 0} prices`
                    },
                    {
                        test: imported.messages && imported.messages.length === 5,
                        name: 'Messages',
                        detail: `${imported.messages ? imported.messages.length : 0} messages`
                    },
                    {
                        test: imported.categories && imported.categories[0].stores.length > 0,
                        name: 'Store data',
                        detail: 'Stores with details'
                    },
                    {
                        test: imported.noteCategories && imported.noteCategories[0].notes.length > 0,
                        name: 'Notes data',
                        detail: 'Notes with content'
                    },
                    {
                        test: imported.dasherCategories && imported.dasherCategories[0].dashers.length > 0,
                        name: 'Dasher data',
                        detail: 'Dashers with details'
                    }
                ];

                for (const verify of verifications) {
                    addTestResult('import', verify.name, verify.test, verify.detail);
                    
                    if (verify.test) {
                        log(`‚úì ${verify.name} imported correctly`, 'success');
                    } else {
                        log(`‚úó ${verify.name} import failed`, 'error');
                        allPassed = false;
                    }
                }

            } catch (error) {
                addTestResult('import', 'Import from JSON', false, error.message);
                log('‚úó Import failed: ' + error.message, 'error');
                allPassed = false;
            }

            updateStatus('import', allPassed ? 'success' : 'failed');
            return allPassed;
        }

        async function runAllTests() {
            log('üöÄ Starting comprehensive test suite...', 'info');
            testResults = { total: 0, passed: 0, failed: 0, startTime: Date.now(), endTime: 0 };
            
            // Clear previous results
            ['save', 'load', 'export', 'import'].forEach(section => {
                document.getElementById(section + 'Tests').innerHTML = '';
                updateStatus(section, 'pending');
            });

            updateProgress(0);

            // Run tests in sequence
            const tests = [
                { fn: testSaveToLocalStorage, weight: 25 },
                { fn: testLoadFromLocalStorage, weight: 25 },
                { fn: testExportToJSON, weight: 25 },
                { fn: testImportFromJSON, weight: 25 }
            ];

            let progress = 0;
            let allTestsPassed = true;

            for (const test of tests) {
                const passed = await test.fn();
                allTestsPassed = allTestsPassed && passed;
                progress += test.weight;
                updateProgress(progress);
                await new Promise(resolve => setTimeout(resolve, 500)); // Visual delay
            }

            testResults.endTime = Date.now();
            
            // Count results
            const allTestItems = document.querySelectorAll('.test-item');
            testResults.total = allTestItems.length;
            testResults.passed = document.querySelectorAll('.test-item.success').length;
            testResults.failed = document.querySelectorAll('.test-item.failed').length;

            // Update summary
            document.getElementById('totalTests').textContent = testResults.total;
            document.getElementById('passedTests').textContent = testResults.passed;
            document.getElementById('failedTests').textContent = testResults.failed;
            document.getElementById('successRate').textContent = 
                Math.round((testResults.passed / testResults.total) * 100) + '%';
            document.getElementById('dataIntegrity').textContent = 
                allTestsPassed ? '100%' : Math.round((testResults.passed / testResults.total) * 100) + '%';
            document.getElementById('testDuration').textContent = 
                (testResults.endTime - testResults.startTime) + 'ms';

            log(`‚úÖ Test suite completed: ${testResults.passed}/${testResults.total} passed`, 
                allTestsPassed ? 'success' : 'error');
        }

        async function runQuickTest() {
            log('‚ö° Running quick validation test...', 'info');
            
            // Just verify current state
            const state = localStorage.getItem('dashBashState');
            if (state) {
                const data = JSON.parse(state);
                const hasAllSections = data.prices && data.messages && data.categories && 
                                     data.noteCategories && data.dasherCategories;
                
                if (hasAllSections) {
                    log('‚úì Quick test passed - all sections present', 'success');
                    alert('‚úÖ Quick Test Passed!\n\nAll sections are properly configured and saving data.');
                } else {
                    log('‚úó Quick test failed - missing sections', 'error');
                    alert('‚ùå Quick Test Failed!\n\nSome sections are missing. Run full test for details.');
                }
            } else {
                log('‚úó No data in localStorage', 'error');
                alert('‚ùå No data found in localStorage!');
            }
        }

        async function runStressTest() {
            log('üí™ Starting stress test with large dataset...', 'info');
            
            const stressData = generateTestData();
            
            // Add lots of data
            for (let i = 0; i < 100; i++) {
                stressData.prices.push(Math.random() * 20);
                stressData.messages.push(`Test message ${i}`);
            }
            
            for (let i = 0; i < 50; i++) {
                stressData.noteCategories[0].notes.push(`Stress test note ${i}`);
            }
            
            const startTime = Date.now();
            localStorage.setItem('dashBashState', JSON.stringify(stressData));
            const saveTime = Date.now() - startTime;
            
            const loaded = JSON.parse(localStorage.getItem('dashBashState'));
            const loadTime = Date.now() - startTime - saveTime;
            
            log(`‚úì Stress test completed: Save ${saveTime}ms, Load ${loadTime}ms`, 'success');
            alert(`üí™ Stress Test Complete!\n\nSaved 100+ items in ${saveTime}ms\nLoaded in ${loadTime}ms`);
        }

        function clearResults() {
            ['save', 'load', 'export', 'import'].forEach(section => {
                document.getElementById(section + 'Tests').innerHTML = '';
                updateStatus(section, 'pending');
            });
            document.getElementById('logPanel').innerHTML = 
                '<div class="log-entry log-info">Test results cleared. Ready for new tests.</div>';
            updateProgress(0);
            log('Results cleared', 'info');
        }

        function exportTestReport() {
            const report = {
                timestamp: new Date().toISOString(),
                results: testResults,
                environment: {
                    userAgent: navigator.userAgent,
                    localStorage: localStorage.length,
                    timestamp: new Date().toISOString()
                },
                tests: []
            };
            
            document.querySelectorAll('.test-item').forEach(item => {
                report.tests.push({
                    name: item.querySelector('strong').textContent,
                    passed: item.classList.contains('success')
                });
            });
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `test-report-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            log('Test report exported', 'info');
        }

        // Auto-run on load
        window.addEventListener('load', () => {
            log('Test suite ready. Click "Run All Tests" to begin.', 'info');
        });
    </script>
</body>
</html>