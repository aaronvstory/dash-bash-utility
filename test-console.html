<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Dash Bash – Anchor Smoke Test</title>
		<style>
			body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif; background:#0b0f14; color:#e5e7eb; margin:0; }
			header { padding: 12px 16px; border-bottom: 1px solid #263041; display:flex; align-items:center; gap:12px; }
			button { background:#1f2937; color:#e5e7eb; border:1px solid #374151; border-radius:6px; padding:6px 10px; cursor:pointer; }
			button:hover { background:#2a364a; }
			#log { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; white-space:pre-wrap; padding:12px 16px; }
			iframe { width: 100%; height: calc(100vh - 120px); border: 0; display:block; }
		</style>
	</head>
	<body>
		<header>
			<strong>Anchor Smoke Test</strong>
			<button id="run">Run Test</button>
			<span id="status" aria-live="polite"></span>
		</header>
		<div id="log"></div>
		<iframe id="app" src="index.html" title="App Under Test"></iframe>
		<script>
			const logEl = document.getElementById('log');
			const statusEl = document.getElementById('status');
			const app = document.getElementById('app');

			function log(line = '') { logEl.textContent += line + '\n'; }
			function clearLog() { logEl.textContent = ''; }

			function sanitizeIdentity(identity) {
				const s = String(identity).toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '').replace(/-+/g, '-');
				return s ? `dasher-card-${s}` : '';
			}

			async function runTest() {
				clearLog();
				statusEl.textContent = 'Running…';
				try {
					const doc = app.contentDocument;
					if (!doc) throw new Error('iframe contentDocument unavailable. If this is blocked, try running via a local web server on http://localhost');

					// Give the React app a moment to render
					await new Promise(r => setTimeout(r, 1500));

								const bucketIds = [
						'bucket-ready',
						'bucket-currently-using',
						'bucket-appealed',
						'bucket-applied-pending',
						'bucket-reverif',
						'bucket-locked',
						'bucket-deactivated',
						'bucket-archived'
					];

					const allAnchors = Array.from(doc.querySelectorAll('[data-dasher-anchor]'));
					log(`Total anchors: ${allAnchors.length}`);

								// Try expanding each bucket by clicking its header toggle before counting
								const expandMap = {
									'bucket-ready': () => doc.querySelector('button[aria-controls="bucket-ready"]')?.click(),
									'bucket-currently-using': () => doc.querySelector('button[aria-controls="bucket-currently-using"]')?.click(),
									'bucket-appealed': () => doc.querySelector('button[aria-controls="bucket-appealed"]')?.click(),
									'bucket-applied-pending': () => doc.querySelector('button[aria-controls="bucket-applied-pending"]')?.click(),
									'bucket-reverif': () => doc.querySelector('button[aria-controls="bucket-reverif"]')?.click(),
									'bucket-locked': () => doc.querySelector('button[aria-controls="bucket-locked"]')?.click(),
									'bucket-deactivated': () => doc.querySelector('button[aria-controls="bucket-deactivated"]')?.click(),
									'bucket-archived': () => doc.querySelector('button[aria-controls="bucket-archived"]')?.click()
								};

								for (const bid of bucketIds) {
									expandMap[bid]?.();
								}
								await new Promise(r => setTimeout(r, 600));

								bucketIds.forEach((bid) => {
									const bucket = doc.getElementById(bid);
									if (!bucket) { log(`${bid}: not present (may be conditionally rendered)`); return; }
									const count = bucket.querySelectorAll('[data-dasher-anchor]').length;
									log(`${bid}: anchors=${count}`);
								});

					// Spot check a few anchors: id must match sanitized identity
					const sample = allAnchors.slice(0, 5);
					sample.forEach((el, i) => {
						const ident = el.getAttribute('data-dasher-anchor');
						const expectedId = sanitizeIdentity(ident);
						const ok = el.id === expectedId;
						log(`sample[${i}] identity='${ident}' id='${el.id}' expected='${expectedId}' => ${ok ? 'OK' : 'MISMATCH'}`);
					});

					statusEl.textContent = 'Done';
				} catch (err) {
					statusEl.textContent = 'Failed';
					log(String(err && err.stack || err));
				}
			}

			document.getElementById('run').addEventListener('click', runTest);
			app.addEventListener('load', () => statusEl.textContent = 'App loaded – click Run Test');
		</script>
	</body>
	</html>
