<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashers Enhancement Test</title>
    <style>
        body { font-family: monospace; background: #111; color: #0f0; padding: 20px; }
        .test { margin: 10px 0; padding: 10px; border: 1px solid #0f0; }
        .pass { background: #001100; }
        .fail { background: #110000; color: #f00; }
        pre { background: #222; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Dashers Enhancement Test Suite</h1>
    <div id="results"></div>

    <script>
        const results = document.getElementById('results');
        let testCount = 0;
        let passCount = 0;

        function log(message, passed = true) {
            const div = document.createElement('div');
            div.className = `test ${passed ? 'pass' : 'fail'}`;
            div.innerHTML = `Test ${++testCount}: ${message} - ${passed ? 'PASSED ✓' : 'FAILED ✗'}`;
            results.appendChild(div);
            if (passed) passCount++;
        }

        function showData(label, data) {
            const pre = document.createElement('pre');
            pre.textContent = `${label}:\n${JSON.stringify(data, null, 2)}`;
            results.appendChild(pre);
        }

        // Test 1: Create new dasher with all fields
        const testDasher = {
            id: Date.now().toString(),
            name: 'Test Dasher',
            email: 'test@example.com',
            emailPw: 'emailPass123',
            dasherPw: 'dasherPass456',
            phone: '555-0123',
            balance: '$125.50',
            crimson: true,
            lastUsed: new Date().toISOString(),
            notes: 'This is a test dasher\nWith multiple lines\nof notes'
        };

        // Test 2: Save to localStorage
        const testState = {
            target: '99',
            targetPreset: '99',
            messages: [],
            categories: [],
            noteCategories: [],
            dasherCategories: [
                {
                    id: 'test-cat',
                    name: 'Test Category',
                    dashers: [testDasher]
                }
            ]
        };

        try {
            localStorage.setItem('dashBashState', JSON.stringify(testState));
            log('Saved enhanced dasher data to localStorage');
        } catch (e) {
            log('Failed to save to localStorage: ' + e.message, false);
        }

        // Test 3: Read back from localStorage
        try {
            const savedState = JSON.parse(localStorage.getItem('dashBashState'));
            const savedDasher = savedState.dasherCategories[0].dashers[0];
            
            // Verify all fields are present
            const requiredFields = ['id', 'name', 'email', 'emailPw', 'dasherPw', 'phone', 'balance', 'crimson', 'lastUsed', 'notes'];
            const allFieldsPresent = requiredFields.every(field => field in savedDasher);
            
            log(`All new fields present in saved data: ${allFieldsPresent}`);
            
            // Verify specific field values
            log(`Email password field saved: ${savedDasher.emailPw === 'emailPass123'}`);
            log(`Dasher password field saved: ${savedDasher.dasherPw === 'dasherPass456'}`);
            log(`Phone field saved: ${savedDasher.phone === '555-0123'}`);
            log(`Balance field saved: ${savedDasher.balance === '$125.50'}`);
            log(`Crimson checkbox saved: ${savedDasher.crimson === true}`);
            log(`Multi-line notes preserved: ${savedDasher.notes.includes('\n')}`);
            
            showData('Saved Dasher Data', savedDasher);
        } catch (e) {
            log('Failed to read from localStorage: ' + e.message, false);
        }

        // Test 4: Export/Import functionality
        try {
            const exportData = JSON.stringify(testState, null, 2);
            const importedData = JSON.parse(exportData);
            
            log('Export/Import maintains data integrity');
            
            // Verify imported data structure
            const importedDasher = importedData.dasherCategories[0].dashers[0];
            log(`Imported dasher has all fields: ${importedDasher.emailPw && importedDasher.dasherPw && importedDasher.phone}`);
        } catch (e) {
            log('Export/Import test failed: ' + e.message, false);
        }

        // Test 5: Backward compatibility check
        const oldDasher = {
            id: '123',
            name: 'Old Dasher',
            email: 'old@example.com',
            lastUsed: null,
            notes: 'Old notes'
        };

        try {
            // New fields should be undefined or have default values
            log(`Old dashers work with new fields: ${oldDasher.emailPw === undefined && oldDasher.crimson === undefined}`);
        } catch (e) {
            log('Backward compatibility test failed: ' + e.message, false);
        }

        // Summary
        const summary = document.createElement('div');
        summary.style.marginTop = '20px';
        summary.style.padding = '15px';
        summary.style.border = '2px solid ' + (passCount === testCount ? '#0f0' : '#f00');
        summary.innerHTML = `<h2>Test Summary: ${passCount}/${testCount} tests passed</h2>`;
        results.appendChild(summary);
    </script>
</body>
</html>